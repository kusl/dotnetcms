===============================================================================
PROJECT EXPORT
Generated: Tue Jan 27 08:46:20 AM EST 2026
Project Path: /home/kushal/src/dotnet/MyBlog
===============================================================================

DIRECTORY STRUCTURE:
===================

.
├── .continue
│   └── agents
├── docs
│   ├── llm
│   │   ├── output
│   │   │   ├── 0001.txt
│   │   │   ├── 0002.txt
│   │   │   ├── 0003.txt
│   │   │   ├── 0004.txt
│   │   │   ├── 0005.txt
│   │   │   ├── 0006.txt
│   │   │   ├── 0007.txt
│   │   │   ├── 0008.txt
│   │   │   ├── 0009.txt
│   │   │   ├── 0010.txt
│   │   │   ├── 0011.txt
│   │   │   ├── 0012.txt
│   │   │   ├── 0013.txt
│   │   │   ├── 0014.txt
│   │   │   ├── 0015.txt
│   │   │   ├── 0016.txt
│   │   │   ├── 0017.txt
│   │   │   ├── 0018.txt
│   │   │   ├── 0019.txt
│   │   │   ├── 0020.txt
│   │   │   ├── 0021.txt
│   │   │   ├── 0022.txt
│   │   │   ├── 0023.txt
│   │   │   ├── 0024.txt
│   │   │   ├── 0025.md
│   │   │   ├── 0026.txt
│   │   │   ├── 0029.txt
│   │   │   ├── 0030.txt
│   │   │   ├── 0031.txt
│   │   │   ├── 0032.txt
│   │   │   ├── 0033.md
│   │   │   ├── 0034.txt
│   │   │   ├── 0035.md
│   │   │   ├── 0037.txt
│   │   │   ├── 0038.txt
│   │   │   ├── 0039.txt
│   │   │   ├── 0040.txt
│   │   │   ├── 0041.txt
│   │   │   ├── 0042.txt
│   │   │   └── 0043.txt
│   │   ├── chatgpt.md
│   │   ├── claude.md
│   │   ├── command.md
│   │   ├── dump.txt
│   │   ├── gemini.md
│   │   ├── instructions.md
│   │   ├── kush.runasp.net-WebDeploy.publishSettings
│   │   ├── playwright.md
│   │   ├── qwen.md
│   │   └── test.html
│   └── E2E-TESTING.md
├── .github
│   └── workflows
│       └── build-deploy.yml
├── src
│   ├── .github
│   │   └── workflows
│   │       └── build-deploy.yml
│   ├── MyBlog.Core
│   │   ├── Constants
│   │   │   └── AppConstants.cs
│   │   ├── Interfaces
│   │   │   ├── IAuthService.cs
│   │   │   ├── IImageDimensionService.cs
│   │   │   ├── IImageRepository.cs
│   │   │   ├── IMarkdownService.cs
│   │   │   ├── IPasswordService.cs
│   │   │   ├── IPostRepository.cs
│   │   │   ├── IReaderTrackingService.cs
│   │   │   ├── ISlugService.cs
│   │   │   ├── ITelemetryLogRepository.cs
│   │   │   └── IUserRepository.cs
│   │   ├── Models
│   │   │   ├── Image.cs
│   │   │   ├── ImageDimensionCache.cs
│   │   │   ├── Post.cs
│   │   │   ├── PostDto.cs
│   │   │   ├── TelemetryLog.cs
│   │   │   └── User.cs
│   │   ├── Services
│   │   │   ├── MarkdownService.cs
│   │   │   └── SlugService.cs
│   │   └── MyBlog.Core.csproj
│   ├── MyBlog.E2E
│   │   ├── Tests
│   │   │   ├── AboutPageTests.cs
│   │   │   ├── HomePageTests.cs
│   │   │   ├── LoginPageTests.cs
│   │   │   └── ThemeSwitcherTests.cs
│   │   ├── Dockerfile
│   │   ├── MyBlog.E2E.csproj
│   │   ├── PlaywrightCollection.cs
│   │   └── PlaywrightFixture.cs
│   ├── MyBlog.Infrastructure
│   │   ├── Data
│   │   │   ├── BlogDbContext.cs
│   │   │   ├── DatabasePathResolver.cs
│   │   │   └── DatabaseSchemaUpdater.cs
│   │   ├── Repositories
│   │   │   ├── ImageRepository.cs
│   │   │   ├── PostRepository.cs
│   │   │   ├── TelemetryLogRepository.cs
│   │   │   └── UserRepository.cs
│   │   ├── Services
│   │   │   ├── AuthService.cs
│   │   │   ├── ImageCacheWarmerService.cs
│   │   │   ├── ImageDimensionService.cs
│   │   │   ├── PasswordService.cs
│   │   │   ├── ReaderTrackingService.cs
│   │   │   └── TelemetryCleanupService.cs
│   │   ├── Telemetry
│   │   │   ├── DatabaseLogExporter.cs
│   │   │   ├── FileLogExporter.cs
│   │   │   └── TelemetryPathResolver.cs
│   │   ├── MyBlog.Infrastructure.csproj
│   │   └── ServiceCollectionExtensions.cs
│   ├── MyBlog.Tests
│   │   ├── Integration
│   │   │   ├── AuthServiceLongPasswordTests.cs
│   │   │   ├── AuthServiceTests.cs
│   │   │   ├── PasswordChangeTests.cs
│   │   │   ├── PostRepositoryTests.cs
│   │   │   └── TelemetryCleanupTests.cs
│   │   ├── Unit
│   │   │   ├── LoginRateLimitMiddlewareTests.cs
│   │   │   ├── MarkdownServiceTests.cs
│   │   │   ├── PasswordServiceTests.cs
│   │   │   └── SlugServiceTests.cs
│   │   └── MyBlog.Tests.csproj
│   ├── MyBlog.Web
│   │   ├── Components
│   │   │   ├── Layout
│   │   │   │   └── MainLayout.razor
│   │   │   ├── Pages
│   │   │   │   ├── Admin
│   │   │   │   │   ├── ChangePassword.razor
│   │   │   │   │   ├── ChangePassword.razor.css
│   │   │   │   │   ├── Dashboard.razor
│   │   │   │   │   ├── Dashboard.razor.css
│   │   │   │   │   ├── ImageManager.razor
│   │   │   │   │   ├── ImageManager.razor.css
│   │   │   │   │   ├── PostEditor.razor
│   │   │   │   │   ├── PostEditor.razor.css
│   │   │   │   │   ├── PostList.razor
│   │   │   │   │   ├── UserEditor.razor
│   │   │   │   │   ├── UserEditor.razor.css
│   │   │   │   │   ├── UserList.razor
│   │   │   │   │   └── UserList.razor.css
│   │   │   │   ├── About.razor
│   │   │   │   ├── About.razor.css
│   │   │   │   ├── AccessDenied.razor
│   │   │   │   ├── Home.razor
│   │   │   │   ├── Login.razor
│   │   │   │   ├── Login.razor.css
│   │   │   │   ├── PostDetail.razor
│   │   │   │   └── PostDetail.razor.css
│   │   │   ├── Shared
│   │   │   │   ├── Footer.razor
│   │   │   │   ├── Footer.razor.css
│   │   │   │   ├── MarkdownRenderer.razor
│   │   │   │   ├── Pagination.razor
│   │   │   │   ├── PostCard.razor
│   │   │   │   ├── PostCard.razor.css
│   │   │   │   ├── ReaderBadge.razor
│   │   │   │   ├── ReaderBadge.razor.css
│   │   │   │   ├── RedirectToLogin.razor
│   │   │   │   ├── ThemeSwitcher.razor
│   │   │   │   └── ThemeSwitcher.razor.css
│   │   │   ├── App.razor
│   │   │   ├── _Imports.razor
│   │   │   └── Routes.razor
│   │   ├── Hubs
│   │   │   └── ReaderHub.cs
│   │   ├── Middleware
│   │   │   └── LoginRateLimitMiddleware.cs
│   │   ├── Properties
│   │   │   └── launchSettings.json
│   │   ├── wwwroot
│   │   │   ├── css
│   │   │   │   └── site.css
│   │   │   └── js
│   │   │       └── site.js
│   │   ├── appsettings.Development.json
│   │   ├── appsettings.json
│   │   ├── Dockerfile
│   │   ├── MyBlog.Web.csproj
│   │   └── Program.cs
│   ├── Directory.Build.props
│   ├── Directory.Packages.props
│   ├── .gitkeep
│   ├── global.json
│   ├── MyBlog.sln.DotSettings.user
│   └── MyBlog.slnx
├── test-results
│   ├── myblog-e2e.log
│   └── myblog-web.log
├── docker-compose.e2e.yml
├── docker-compose.yml
├── .editorconfig
├── export.sh
├── .gitignore
├── README.md
└── run-e2e.sh


FILE CONTENTS:
==============

================================================================================
FILE: docker-compose.e2e.yml
SIZE: 1.40 KB
MODIFIED: 2026-01-26 09:55:18
================================================================================

# Docker Compose for E2E testing with Playwright
# Works with both Docker and Podman Compose on Fedora (with SELinux)
#
# Usage:
#   podman-compose -f docker-compose.e2e.yml up --build
#   podman-compose -f docker-compose.e2e.yml down -v

services:
  myblog-web:
    build:
      context: ./src
      dockerfile: MyBlog.Web/Dockerfile
    container_name: myblog-web
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Data Source=/app/data/myblog.db
      - Authentication__DefaultAdminPassword=ChangeMe123!
    volumes:
      # :Z suffix for SELinux on Fedora - creates private unshared label
      - myblog-data:/app/data:Z
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - myblog-network

  myblog-e2e:
    build:
      context: ./src
      dockerfile: MyBlog.E2E/Dockerfile
    container_name: myblog-e2e
    depends_on:
      myblog-web:
        condition: service_healthy
    environment:
      - MYBLOG_BASE_URL=http://myblog-web:5000
      - PLAYWRIGHT_HEADLESS=true
    volumes:
      # Test results output with SELinux label
      - ./test-results:/tests/TestResults:Z
    networks:
      - myblog-network

networks:
  myblog-network:
    driver: bridge

volumes:
  myblog-data:
  

================================================================================
FILE: docker-compose.yml
SIZE: .67 KB
MODIFIED: 2026-01-26 09:55:33
================================================================================

# Simple Docker Compose for running MyBlog locally
# Works with both Docker and Podman Compose
#
# Usage:
#   podman-compose up --build
#   podman-compose down -v

services:
  myblog:
    build:
      context: ./src
      dockerfile: MyBlog.Web/Dockerfile
    container_name: myblog
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Data Source=/app/data/myblog.db
      - Authentication__DefaultAdminPassword=ChangeMe123!
    volumes:
      # :Z suffix for SELinux on Fedora
      - myblog-data:/app/data:Z
    restart: unless-stopped

volumes:
  myblog-data:
  

================================================================================
FILE: .editorconfig
SIZE: 1.28 KB
MODIFIED: 2026-01-26 07:27:49
================================================================================

root = true

[*]
indent_style = space
indent_size = 4
end_of_line = lf
charset = utf-8
trim_trailing_whitespace = true
insert_final_newline = true

[*.{cs,csx,razor}]
# Using directives
dotnet_sort_system_directives_first = true
csharp_using_directive_placement = outside_namespace:warning

# Namespace and braces
csharp_style_namespace_declarations = file_scoped:error
csharp_prefer_braces = true:warning

# var usage
csharp_style_var_for_built_in_types = true:suggestion
csharp_style_var_when_type_is_apparent = true:suggestion

# Expression-bodied members
csharp_style_expression_bodied_properties = true:suggestion
csharp_style_expression_bodied_methods = true:suggestion

# Naming conventions - private fields with underscore prefix
dotnet_naming_rule.private_fields_should_be_underscored.severity = suggestion
dotnet_naming_rule.private_fields_should_be_underscored.symbols = private_fields
dotnet_naming_rule.private_fields_should_be_underscored.style = prefix_underscore

dotnet_naming_symbols.private_fields.applicable_kinds = field
dotnet_naming_symbols.private_fields.applicable_accessibilities = private

dotnet_naming_style.prefix_underscore.capitalization = camel_case
dotnet_naming_style.prefix_underscore.required_prefix = _

[*.{json,yaml,yml}]
indent_size = 2

[*.md]
trim_trailing_whitespace = false


================================================================================
FILE: export.sh
SIZE: 8.54 KB
MODIFIED: 2026-01-26 05:51:37
================================================================================

#!/bin/bash
# =============================================================================
# Complete Project Export for LLM Analysis
# =============================================================================
# Exports all relevant source files, configs, and documentation for AI review.
# Excludes: binaries, build outputs, IDE files, packages, git internals
# =============================================================================

set -e

OUTPUT_DIR="docs/llm"
OUTPUT_FILE="$OUTPUT_DIR/dump.txt"
PROJECT_PATH="$(pwd)"

# File extensions to include (comprehensive list for .NET/Blazor projects)
# Source code
SOURCE_EXTS="cs|fs|vb"
# XAML/Avalonia UI
XAML_EXTS="axaml|xaml|paml"
# Blazor/Razor
RAZOR_EXTS="razor"
# Project/Build files
PROJECT_EXTS="csproj|fsproj|vbproj|slnx|sln|props|targets|tasks"
# Config files
CONFIG_EXTS="json|yaml|yml|xml|config|settings"
# Documentation
DOC_EXTS="md|txt|rst|adoc"
# Scripts
SCRIPT_EXTS="sh|ps1|psm1|cmd|bat"
# Web/Style/Scripts
WEB_EXTS="css|scss|sass|less|js|ts"
# Data/Templates
DATA_EXTS="sql|csv|resx|resources"
# Docker/CI
DEVOPS_EXTS="dockerfile|dockerignore|editorconfig|gitignore|gitattributes"

# Directories to exclude
EXCLUDE_DIRS="bin|obj|.git|.vs|.idea|.vscode|node_modules|packages|TestResults|coverage|publish|artifacts|.nuget|wwwroot/lib"

# Files to exclude (patterns)
EXCLUDE_FILES="*.Designer.cs|*.g.cs|*.g.i.cs|AssemblyInfo.cs|*.min.js|*.min.css|package-lock.json|*.lock|*.bak"

echo "=============================================="
echo "  Project Export for LLM Analysis"
echo "=============================================="
echo ""
echo "Project Path: $PROJECT_PATH"
echo "Output File:  $OUTPUT_FILE"
echo ""

mkdir -p "$OUTPUT_DIR"

# Start output file
{
    echo "==============================================================================="
    echo "PROJECT EXPORT"
    echo "Generated: $(date)"
    echo "Project Path: $PROJECT_PATH"
    echo "==============================================================================="
    echo ""
} > "$OUTPUT_FILE"

# Directory structure
echo "Generating directory structure..."
{
    echo "DIRECTORY STRUCTURE:"
    echo "==================="
    echo ""
    # Try tree first, fall back to find
    if command -v tree &> /dev/null; then
        tree -a -I "$EXCLUDE_DIRS" --noreport --dirsfirst 2>/dev/null || echo "(tree command failed)"
    else
        find . -type d \( -name "bin" -o -name "obj" -o -name ".git" -o -name ".vs" -o -name ".idea" -o -name "node_modules" -o -name "packages" -o -name "TestResults" \) -prune -o -type f -print | sed 's|[^/]*/|  |g' | sort
    fi
    echo ""
    echo ""
} >> "$OUTPUT_FILE"

# Build the find command dynamically
echo "Collecting files..."

# Create a temporary file for the file list
TMPFILE=$(mktemp)

# Find all relevant files
find . -type f \( \
    -iname "*.cs" -o \
    -iname "*.fs" -o \
    -iname "*.vb" -o \
    -iname "*.razor" -o \
    -iname "*.axaml" -o \
    -iname "*.xaml" -o \
    -iname "*.paml" -o \
    -iname "*.csproj" -o \
    -iname "*.fsproj" -o \
    -iname "*.vbproj" -o \
    -iname "*.slnx" -o \
    -iname "*.sln" -o \
    -iname "*.props" -o \
    -iname "*.targets" -o \
    -iname "*.json" -o \
    -iname "*.yaml" -o \
    -iname "*.yml" -o \
    -iname "*.xml" -o \
    -iname "*.config" -o \
    -iname "*.md" -o \
    -iname "*.txt" -o \
    -iname "*.sh" -o \
    -iname "*.ps1" -o \
    -iname "*.cmd" -o \
    -iname "*.bat" -o \
    -iname "*.sql" -o \
    -iname "*.resx" -o \
    -iname "*.css" -o \
    -iname "*.scss" -o \
    -iname "*.js" -o \
    -iname "*.ts" -o \
    -iname "*.manifest" -o \
    -iname "*.ico" -o \
    -iname "Dockerfile" -o \
    -iname "docker-compose*.yml" -o \
    -iname ".editorconfig" -o \
    -iname ".gitignore" -o \
    -iname ".gitattributes" -o \
    -iname "global.json" -o \
    -iname "nuget.config" -o \
    -iname "Directory.Build.props" -o \
    -iname "Directory.Build.targets" -o \
    -iname "Directory.Packages.props" \
    \) \
    ! -path "*/bin/*" \
    ! -path "*/obj/*" \
    ! -path "*/docs/*" \
    ! -path "*/.git/*" \
    ! -path "*/.vs/*" \
    ! -path "*/.idea/*" \
    ! -path "*/.vscode/*" \
    ! -path "*/node_modules/*" \
    ! -path "*/packages/*" \
    ! -path "*/TestResults/*" \
    ! -path "*/coverage/*" \
    ! -path "*/publish/*" \
    ! -path "*/artifacts/*" \
    ! -path "*/.nuget/*" \
    ! -path "*/wwwroot/lib/*" \
    ! -name "*.Designer.cs" \
    ! -name "*.g.cs" \
    ! -name "*.g.i.cs" \
    ! -name "*.min.js" \
    ! -name "*.min.css" \
    ! -name "package-lock.json" \
    ! -name "*.bak" \
    2>/dev/null | sort > "$TMPFILE"

FILE_COUNT=$(wc -l < "$TMPFILE")
echo "Found $FILE_COUNT files to export"
echo ""

# Add file contents header
{
    echo "FILE CONTENTS:"
    echo "=============="
    echo ""
} >> "$OUTPUT_FILE"

# Process each file
COUNTER=0
SKIPPED=0

while IFS= read -r file; do
    COUNTER=$((COUNTER + 1))
    FILENAME="${file#./}"
    
    # Skip binary files (check if file is text)
    if file "$file" | grep -qE "binary|executable|data|image"; then
        # For some files we want to note they exist but not dump contents
        if [[ "$file" =~ \.(ico|png|jpg|jpeg|gif|bmp|svg|woff|woff2|ttf|eot)$ ]]; then
            SKIPPED=$((SKIPPED + 1))
            echo "Skipping binary ($COUNTER/$FILE_COUNT): $FILENAME"
            {
                echo "================================================================================"
                echo "FILE: $FILENAME"
                echo "TYPE: [BINARY FILE - Contents not exported]"
                echo "================================================================================"
                echo ""
            } >> "$OUTPUT_FILE"
            continue
        fi
    fi
    
    # Get file info
    FILESIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "0")
    MODIFIED=$(stat -c%y "$file" 2>/dev/null | cut -d'.' -f1 || stat -f"%Sm" -t "%Y-%m-%d %H:%M:%S" "$file" 2>/dev/null || echo "unknown")
    
    # Skip very large files (>500KB) - they're probably not source code
    if [ "$FILESIZE" -gt 512000 ]; then
        SKIPPED=$((SKIPPED + 1))
        echo "Skipping large file ($COUNTER/$FILE_COUNT): $FILENAME ($(echo "scale=0; $FILESIZE/1024" | bc)KB)"
        {
            echo "================================================================================"
            echo "FILE: $FILENAME"
            echo "SIZE: $(echo "scale=2; $FILESIZE/1024" | bc) KB"
            echo "TYPE: [LARGE FILE - Contents not exported, exceeds 500KB limit]"
            echo "================================================================================"
            echo ""
        } >> "$OUTPUT_FILE"
        continue
    fi
    
    echo "Processing ($COUNTER/$FILE_COUNT): $FILENAME"
    
    {
        echo "================================================================================"
        echo "FILE: $FILENAME"
        echo "SIZE: $(echo "scale=2; $FILESIZE/1024" | bc 2>/dev/null || echo "0.00") KB"
        echo "MODIFIED: $MODIFIED"
        echo "================================================================================"
        echo ""
        cat "$file" 2>/dev/null || echo "[ERROR: Could not read file]"
        echo ""
        echo ""
    } >> "$OUTPUT_FILE"
    
done < "$TMPFILE"

# Cleanup
rm -f "$TMPFILE"

# Summary
EXPORTED=$((COUNTER - SKIPPED))
{
    echo "==============================================================================="
    echo "EXPORT COMPLETED: $(date)"
    echo "Total Files Found: $FILE_COUNT"
    echo "Files Exported: $EXPORTED"
    echo "Files Skipped: $SKIPPED (binary or large files)"
    echo "Output File: $PROJECT_PATH/$OUTPUT_FILE"
    echo "==============================================================================="
} >> "$OUTPUT_FILE"

# Final output
OUTPUT_SIZE=$(stat -c%s "$OUTPUT_FILE" 2>/dev/null || stat -f%z "$OUTPUT_FILE" 2>/dev/null || echo "0")

echo ""
echo "=============================================="
echo "  Export Complete!"
echo "=============================================="
echo ""
echo "Output file:    $OUTPUT_FILE"
echo "Files exported: $EXPORTED"
echo "Files skipped:  $SKIPPED"
echo "Output size:    $(echo "scale=2; $OUTPUT_SIZE/1024" | bc 2>/dev/null || echo "?") KB"
echo ""
echo "File types included:"
echo "  • Source code: .cs, .fs, .vb"
echo "  • Blazor/Razor: .razor"
echo "  • UI/XAML: .axaml, .xaml, .paml"
echo "  • Projects: .csproj, .slnx, .sln, .props, .targets"
echo "  • Config: .json, .yaml, .yml, .xml, .config"
echo "  • Docs: .md, .txt"
echo "  • Scripts: .sh, .ps1, .cmd, .bat"
echo "  • Web: .css, .scss, .js, .ts"
echo "  • Other: .sql, .resx, Dockerfile, etc."
echo ""



================================================================================
FILE: .github/workflows/build-deploy.yml
SIZE: 4.47 KB
MODIFIED: 2026-01-26 21:59:40
================================================================================

name: Build, Test, and Deploy

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  build-test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore src/MyBlog.slnx

      - name: Build solution
        run: dotnet build src/MyBlog.slnx -c Release --no-restore

      - name: Run unit tests
        run: dotnet run --project src/MyBlog.Tests/MyBlog.Tests.csproj

  e2e-tests:
    runs-on: ubuntu-latest
    needs: build-test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore E2E dependencies
        run: dotnet restore src/MyBlog.E2E/MyBlog.E2E.csproj

      - name: Build E2E project
        run: dotnet build src/MyBlog.E2E/MyBlog.E2E.csproj -c Release --no-restore

      - name: Install Playwright browsers
        run: |
          pwsh src/MyBlog.E2E/bin/Release/net10.0/playwright.ps1 install chromium --with-deps

      - name: Build and run MyBlog
        run: |
          dotnet build src/MyBlog.Web/MyBlog.Web.csproj -c Release
          dotnet run --project src/MyBlog.Web/MyBlog.Web.csproj -c Release --no-build &
          sleep 15
        env:
          ASPNETCORE_URLS: http://localhost:5000
          ASPNETCORE_ENVIRONMENT: Development
          Authentication__DefaultAdminPassword: ChangeMe123!

      - name: Wait for application to start
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:5000/ > /dev/null 2>&1; then
              echo "Application is ready"
              break
            fi
            echo "Waiting for application... ($i/30)"
            sleep 2
          done

      - name: Run E2E tests
        run: dotnet run --project src/MyBlog.E2E/MyBlog.E2E.csproj -c Release --no-build
        env:
          MYBLOG_BASE_URL: http://localhost:5000
          PLAYWRIGHT_HEADLESS: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            src/MyBlog.E2E/TestResults/
            test-results/
          retention-days: 7

  deploy:
    needs: [build-test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish application
        run: dotnet publish src/MyBlog.Web/MyBlog.Web.csproj -c Release -o ./publish -r win-x86 --self-contained false

      - name: Deploy via WebDeploy
        shell: pwsh
        env:
          DEPLOY_SOURCE: ${{ github.workspace }}\publish
          DEPLOY_SITE: ${{ secrets.WEBSITE_NAME }}
          DEPLOY_HOST: ${{ secrets.SERVER_COMPUTER_NAME }}
          DEPLOY_USER: ${{ secrets.SERVER_USERNAME }}
          DEPLOY_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          $msdeployPath = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"
          
          if (-not (Test-Path $msdeployPath)) {
            Write-Host "Installing Web Deploy..."
            choco install webdeploy -y --no-progress
          }
          
          Write-Host "Deploying to $env:DEPLOY_HOST..."
          Write-Host "Note: Using AppOffline rule to prevent file-in-use errors"

          $sourceArg = "-source:contentPath=$env:DEPLOY_SOURCE"
          $destArg = "-dest:contentPath=$env:DEPLOY_SITE,computerName=https://$($env:DEPLOY_HOST):8172/MsDeploy.axd?site=$env:DEPLOY_SITE,userName=$env:DEPLOY_USER,password=$env:DEPLOY_PASSWORD,AuthType='Basic'"
          
          & $msdeployPath -verb:sync $sourceArg $destArg `
            -allowUntrusted `
            -enableRule:DoNotDeleteRule `
            -enableRule:AppOffline `
            -retryAttempts:3 `
            -retryInterval:3000
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Deployment failed with exit code $LASTEXITCODE"
            exit 1
          }
          
          Write-Host "Deployment completed successfully!"


================================================================================
FILE: .gitignore
SIZE: 7.94 KB
MODIFIED: 2026-01-26 09:57:52
================================================================================

## Ignore Visual Studio temporary files, build results, and
## files generated by popular Visual Studio add-ons.
##
## Get latest from `dotnet new gitignore`

# dotenv files
.env

# User-specific files
*.rsuser
*.suo
*.user
*.userosscache
*.sln.docstates

# User-specific files (MonoDevelop/Xamarin Studio)
*.userprefs

# Mono auto generated files
mono_crash.*

# Build results
[Dd]ebug/
[Dd]ebugPublic/
[Rr]elease/
[Rr]eleases/
x64/
x86/
[Ww][Ii][Nn]32/
[Aa][Rr][Mm]/
[Aa][Rr][Mm]64/
bld/
[Bb]in/
[Oo]bj/
[Ll]og/
[Ll]ogs/

# Visual Studio 2015/2017 cache/options directory
.vs/
# Uncomment if you have tasks that create the project's static files in wwwroot
#wwwroot/

# Visual Studio 2017 auto generated files
Generated\ Files/

# MSTest test Results
[Tt]est[Rr]esult*/
[Bb]uild[Ll]og.*

# NUnit
*.VisualState.xml
TestResult.xml
nunit-*.xml

# Build Results of an ATL Project
[Dd]ebugPS/
[Rr]eleasePS/
dlldata.c

# Benchmark Results
BenchmarkDotNet.Artifacts/

# .NET
project.lock.json
project.fragment.lock.json
artifacts/

# Tye
.tye/

# ASP.NET Scaffolding
ScaffoldingReadMe.txt

# StyleCop
StyleCopReport.xml

# Files built by Visual Studio
*_i.c
*_p.c
*_h.h
*.ilk
*.meta
*.obj
*.iobj
*.pch
*.pdb
*.ipdb
*.pgc
*.pgd
*.rsp
# but not Directory.Build.rsp, as it configures directory-level build defaults
!Directory.Build.rsp
*.sbr
*.tlb
*.tli
*.tlh
*.tmp
*.tmp_proj
*_wpftmp.csproj
*.log
*.tlog
*.vspscc
*.vssscc
.builds
*.pidb
*.svclog
*.scc

# Chutzpah Test files
_Chutzpah*

# Visual C++ cache files
ipch/
*.aps
*.ncb
*.opendb
*.opensdf
*.sdf
*.cachefile
*.VC.db
*.VC.VC.opendb

# Visual Studio profiler
*.psess
*.vsp
*.vspx
*.sap

# Visual Studio Trace Files
*.e2e

# TFS 2012 Local Workspace
$tf/

# Guidance Automation Toolkit
*.gpState

# ReSharper is a .NET coding add-in
_ReSharper*/
*.[Rr]e[Ss]harper
*.DotSettings.user

# TeamCity is a build add-in
_TeamCity*

# DotCover is a Code Coverage Tool
*.dotCover

# AxoCover is a Code Coverage Tool
.axoCover/*
!.axoCover/settings.json

# Coverlet is a free, cross platform Code Coverage Tool
coverage*.json
coverage*.xml
coverage*.info

# Visual Studio code coverage results
*.coverage
*.coveragexml

# NCrunch
_NCrunch_*
.*crunch*.local.xml
nCrunchTemp_*

# MightyMoose
*.mm.*
AutoTest.Net/

# Web workbench (sass)
.sass-cache/

# Installshield output folder
[Ee]xpress/

# DocProject is a documentation generator add-in
DocProject/buildhelp/
DocProject/Help/*.HxT
DocProject/Help/*.HxC
DocProject/Help/*.hhc
DocProject/Help/*.hhk
DocProject/Help/*.hhp
DocProject/Help/Html2
DocProject/Help/html

# Click-Once directory
publish/

# Publish Web Output
*.[Pp]ublish.xml
*.azurePubxml
# Note: Comment the next line if you want to checkin your web deploy settings,
# but database connection strings (with potential passwords) will be unencrypted
*.pubxml
*.publishproj

# Microsoft Azure Web App publish settings. Comment the next line if you want to
# checkin your Azure Web App publish settings, but sensitive information contained
# in these scripts will be unencrypted
PublishScripts/

# NuGet Packages
*.nupkg
# NuGet Symbol Packages
*.snupkg
# The packages folder can be ignored because of Package Restore
**/[Pp]ackages/*
# except build/, which is used as an MSBuild target.
!**/[Pp]ackages/build/
# Uncomment if necessary however generally it will be regenerated when needed
#!**/[Pp]ackages/repositories.config
# NuGet v3's project.json files produces more ignorable files
*.nuget.props
*.nuget.targets

# Microsoft Azure Build Output
csx/
*.build.csdef

# Microsoft Azure Emulator
ecf/
rcf/

# Windows Store app package directories and files
AppPackages/
BundleArtifacts/
Package.StoreAssociation.xml
_pkginfo.txt
*.appx
*.appxbundle
*.appxupload

# Visual Studio cache files
# files ending in .cache can be ignored
*.[Cc]ache
# but keep track of directories ending in .cache
!?*.[Cc]ache/

# Others
ClientBin/
~$*
*~
*.dbmdl
*.dbproj.schemaview
*.jfm
*.pfx
*.publishsettings
orleans.codegen.cs

# Including strong name files can present a security risk
# (https://github.com/github/gitignore/pull/2483#issue-259490424)
#*.snk

# Since there are multiple workflows, uncomment next line to ignore bower_components
# (https://github.com/github/gitignore/pull/1529#issuecomment-104372622)
#bower_components/

# RIA/Silverlight projects
Generated_Code/

# Backup & report files from converting an old project file
# to a newer Visual Studio version. Backup files are not needed,
# because we have git ;-)
_UpgradeReport_Files/
Backup*/
UpgradeLog*.XML
UpgradeLog*.htm
ServiceFabricBackup/
*.rptproj.bak

# SQL Server files
*.mdf
*.ldf
*.ndf

# Business Intelligence projects
*.rdl.data
*.bim.layout
*.bim_*.settings
*.rptproj.rsuser
*- [Bb]ackup.rdl
*- [Bb]ackup ([0-9]).rdl
*- [Bb]ackup ([0-9][0-9]).rdl

# Microsoft Fakes
FakesAssemblies/

# GhostDoc plugin setting file
*.GhostDoc.xml

# Node.js Tools for Visual Studio
.ntvs_analysis.dat
node_modules/

# Visual Studio 6 build log
*.plg

# Visual Studio 6 workspace options file
*.opt

# Visual Studio 6 auto-generated workspace file (contains which files were open etc.)
*.vbw

# Visual Studio 6 auto-generated project file (contains which files were open etc.)
*.vbp

# Visual Studio 6 workspace and project file (working project files containing files to include in project)
*.dsw
*.dsp

# Visual Studio 6 technical files
*.ncb
*.aps

# Visual Studio LightSwitch build output
**/*.HTMLClient/GeneratedArtifacts
**/*.DesktopClient/GeneratedArtifacts
**/*.DesktopClient/ModelManifest.xml
**/*.Server/GeneratedArtifacts
**/*.Server/ModelManifest.xml
_Pvt_Extensions

# Paket dependency manager
.paket/paket.exe
paket-files/

# FAKE - F# Make
.fake/

# CodeRush personal settings
.cr/personal

# Python Tools for Visual Studio (PTVS)
__pycache__/
*.pyc

# Cake - Uncomment if you are using it
# tools/**
# !tools/packages.config

# Tabs Studio
*.tss

# Telerik's JustMock configuration file
*.jmconfig

# BizTalk build output
*.btp.cs
*.btm.cs
*.odx.cs
*.xsd.cs

# OpenCover UI analysis results
OpenCover/

# Azure Stream Analytics local run output
ASALocalRun/

# MSBuild Binary and Structured Log
*.binlog

# NVidia Nsight GPU debugger configuration file
*.nvuser

# MFractors (Xamarin productivity tool) working folder
.mfractor/

# Local History for Visual Studio
.localhistory/

# Visual Studio History (VSHistory) files
.vshistory/

# BeatPulse healthcheck temp database
healthchecksdb

# Backup folder for Package Reference Convert tool in Visual Studio 2017
MigrationBackup/

# Ionide (cross platform F# VS Code tools) working folder
.ionide/

# Fody - auto-generated XML schema
FodyWeavers.xsd

# VS Code files for those working on multiple tools
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace

# Local History for Visual Studio Code
.history/

# Windows Installer files from build outputs
*.cab
*.msi
*.msix
*.msm
*.msp

# JetBrains Rider
*.sln.iml
.idea/

##
## Visual studio for Mac
##


# globs
Makefile.in
*.userprefs
*.usertasks
config.make
config.status
aclocal.m4
install-sh
autom4te.cache/
*.tar.gz
tarballs/
test-results/

# content below from: https://github.com/github/gitignore/blob/main/Global/macOS.gitignore
# General
.DS_Store
.AppleDouble
.LSOverride

# Icon must end with two \r
Icon


# Thumbnails
._*

# Files that might appear in the root of a volume
.DocumentRevisions-V100
.fseventsd
.Spotlight-V100
.TemporaryItems
.Trashes
.VolumeIcon.icns
.com.apple.timemachine.donotpresent

# Directories potentially created on remote AFP share
.AppleDB
.AppleDesktop
Network Trash Folder
Temporary Items
.apdisk

# content below from: https://github.com/github/gitignore/blob/main/Global/Windows.gitignore
# Windows thumbnail cache files
Thumbs.db
ehthumbs.db
ehthumbs_vista.db

# Dump file
*.stackdump

# Folder config file
[Dd]esktop.ini

# Recycle Bin used on file shares
$RECYCLE.BIN/

# Windows Installer files
*.cab
*.msi
*.msix
*.msm
*.msp

# Windows shortcuts
*.lnk

# Vim temporary swap files
*.swp


*.publishSettings

# Playwright
playwright-report/
playwright/.cache/
test-results/

# Docker/Podman volumes
myblog-data/


================================================================================
FILE: README.md
SIZE: 63.06 KB
MODIFIED: 2026-01-26 07:03:32
================================================================================

# MyBlog

> **⚠️ AI-Assisted Development Notice**
>
> This project contains code generated with assistance from Large Language Models (LLMs), including Claude (Anthropic) and Gemini (Google). All code—whether explicitly marked or not—should be considered experimental. The AI assistance was used for code generation, architecture decisions, debugging, documentation, and test creation. Human review and testing have been applied, but users should exercise appropriate caution when deploying to production environments.

A lightweight, self-hosted blogging platform built with .NET 10 and Blazor Server, following Clean Architecture principles.

**Live Demo:** [kush.runasp.net](https://kush.runasp.net)

---

## Table of Contents

1. [Overview](#overview)
2. [Features](#features)
3. [Architecture](#architecture)
4. [Technology Stack](#technology-stack)
5. [Quick Start](#quick-start)
6. [Configuration](#configuration)
7. [Database](#database)
8. [Authentication & Security](#authentication--security)
9. [Content Management](#content-management)
10. [Markdown Specification](#markdown-specification)
11. [Image Management](#image-management)
12. [Real-Time Features](#real-time-features)
13. [Theming System](#theming-system)
14. [Observability & Telemetry](#observability--telemetry)
15. [API Reference](#api-reference)
16. [Admin Guide](#admin-guide)
17. [Testing](#testing)
18. [Deployment](#deployment)
19. [Troubleshooting](#troubleshooting)
20. [Contributing](#contributing)
21. [License](#license)

---

## Overview

MyBlog is a complete content management system designed for developers who want full control over their blogging platform. It prioritizes simplicity, security, and self-sufficiency—requiring no external services, JavaScript frameworks, or CSS libraries.

### Design Philosophy

| Principle | Implementation |
|-----------|----------------|
| **Zero External Dependencies** | No npm, Node.js, or CSS frameworks. Pure .NET with custom CSS. |
| **Self-Contained** | Single deployable unit with SQLite database. No external DB servers. |
| **Cross-Platform** | Runs identically on Windows, Linux, and macOS. |
| **Security First** | Rate limiting, secure password hashing, input sanitization. |
| **Observable** | Built-in OpenTelemetry with file and database logging. |
| **Testable** | Interface-based DI with comprehensive unit and integration tests. |

---

## Features

### Content Features
- **Markdown Authoring** — Write posts in Markdown with live preview
- **Custom Markdown Parser** — No external libraries; supports all common syntax
- **Automatic Image Dimensions** — Fetches and caches dimensions to prevent layout shift
- **SEO Optimization** — Open Graph, Twitter Cards, JSON-LD structured data
- **Social Sharing** — Web Share API with clipboard fallback

### Security Features
- **Progressive Rate Limiting** — Slows down brute-force attacks but never locks users out
- **Secure Password Storage** — ASP.NET Identity PasswordHasher with automatic rehashing
- **Slug Collision Prevention** — Automatic unique slug generation
- **Cookie-Based Sessions** — HttpOnly, secure cookies with sliding expiration

### Administrative Features
- **Multi-User Support** — Create and manage multiple authors
- **Image Library** — Upload, browse, and manage images stored in the database
- **Real-Time Reader Counts** — See how many people are reading each post
- **Dashboard** — Overview of posts, quick access to all management areas

### Technical Features
- **Six Color Themes** — Light, Dark, Sepia, Nord, Solarized Light, Dracula
- **OpenTelemetry Integration** — Distributed tracing, metrics, and logging
- **Automatic Log Cleanup** — Configurable retention with daily cleanup
- **XDG-Compliant Paths** — Proper data storage locations per platform
- **CI/CD Pipeline** — GitHub Actions with cross-platform testing

---

## Architecture

MyBlog follows **Clean Architecture** (also known as Onion Architecture), ensuring clear separation of concerns and testability.

```
┌─────────────────────────────────────────────────────────────────┐
│                        MyBlog.Web                               │
│                   (Presentation Layer)                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐  │
│  │   Pages/    │ │   Shared/   │ │ Middleware/ │ │   Hubs/   │  │
│  │  Components │ │  Components │ │Rate Limiting│ │  SignalR  │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    MyBlog.Infrastructure                        │
│                     (Data Access Layer)                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐  │
│  │Repositories │ │  Services   │ │  Telemetry  │ │   Data/   │  │
│  │   (EF Core) │ │Auth,Password│ │  Exporters  │ │ DbContext │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       MyBlog.Core                               │
│                      (Domain Layer)                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐  │
│  │   Models    │ │ Interfaces  │ │  Services   │ │ Constants │  │
│  │Post,User,.. │ │IPostRepo,.. │ │Markdown,Slug│ │ AppConsts │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### Project Structure

```
MyBlog/
├── src/
│   ├── MyBlog.Core/                 # Domain Layer (no external dependencies)
│   │   ├── Constants/
│   │   │   └── AppConstants.cs      # Auth cookie name, roles, limits
│   │   ├── Interfaces/
│   │   │   ├── IAuthService.cs
│   │   │   ├── IImageDimensionService.cs
│   │   │   ├── IImageRepository.cs
│   │   │   ├── IMarkdownService.cs
│   │   │   ├── IPasswordService.cs
│   │   │   ├── IPostRepository.cs
│   │   │   ├── IReaderTrackingService.cs
│   │   │   ├── ISlugService.cs
│   │   │   ├── ITelemetryLogRepository.cs
│   │   │   └── IUserRepository.cs
│   │   ├── Models/
│   │   │   ├── Image.cs
│   │   │   ├── ImageDimensionCache.cs
│   │   │   ├── Post.cs
│   │   │   ├── PostDto.cs
│   │   │   ├── TelemetryLog.cs
│   │   │   └── User.cs
│   │   └── Services/
│   │       ├── MarkdownService.cs
│   │       └── SlugService.cs
│   │
│   ├── MyBlog.Infrastructure/       # Data Access Layer
│   │   ├── Data/
│   │   │   ├── BlogDbContext.cs
│   │   │   ├── DatabasePathResolver.cs
│   │   │   └── DatabaseSchemaUpdater.cs
│   │   ├── Repositories/
│   │   │   ├── ImageRepository.cs
│   │   │   ├── PostRepository.cs
│   │   │   ├── TelemetryLogRepository.cs
│   │   │   └── UserRepository.cs
│   │   ├── Services/
│   │   │   ├── AuthService.cs
│   │   │   ├── ImageCacheWarmerService.cs
│   │   │   ├── ImageDimensionService.cs
│   │   │   ├── PasswordService.cs
│   │   │   ├── ReaderTrackingService.cs
│   │   │   └── TelemetryCleanupService.cs
│   │   ├── Telemetry/
│   │   │   ├── DatabaseLogExporter.cs
│   │   │   ├── FileLogExporter.cs
│   │   │   └── TelemetryPathResolver.cs
│   │   └── ServiceCollectionExtensions.cs
│   │
│   ├── MyBlog.Web/                  # Presentation Layer
│   │   ├── Components/
│   │   │   ├── Layout/
│   │   │   │   └── MainLayout.razor
│   │   │   ├── Pages/
│   │   │   │   ├── Admin/
│   │   │   │   │   ├── ChangePassword.razor
│   │   │   │   │   ├── Dashboard.razor
│   │   │   │   │   ├── ImageManager.razor
│   │   │   │   │   ├── PostEditor.razor
│   │   │   │   │   ├── PostList.razor
│   │   │   │   │   ├── UserEditor.razor
│   │   │   │   │   └── UserList.razor
│   │   │   │   ├── About.razor
│   │   │   │   ├── AccessDenied.razor
│   │   │   │   ├── Home.razor
│   │   │   │   ├── Login.razor
│   │   │   │   └── PostDetail.razor
│   │   │   └── Shared/
│   │   │       ├── Footer.razor
│   │   │       ├── MarkdownRenderer.razor
│   │   │       ├── Pagination.razor
│   │   │       ├── PostCard.razor
│   │   │       ├── ReaderBadge.razor
│   │   │       ├── RedirectToLogin.razor
│   │   │       └── ThemeSwitcher.razor
│   │   ├── Hubs/
│   │   │   └── ReaderHub.cs
│   │   ├── Middleware/
│   │   │   └── LoginRateLimitMiddleware.cs
│   │   └── wwwroot/
│   │       ├── css/site.css
│   │       └── js/site.js
│   │
│   ├── MyBlog.Tests/                # Test Project
│   │   ├── Integration/
│   │   │   ├── AuthServiceLongPasswordTests.cs
│   │   │   ├── AuthServiceTests.cs
│   │   │   ├── PasswordChangeTests.cs
│   │   │   ├── PostRepositoryTests.cs
│   │   │   └── TelemetryCleanupTests.cs
│   │   └── Unit/
│   │       ├── LoginRateLimitMiddlewareTests.cs
│   │       ├── MarkdownServiceTests.cs
│   │       ├── PasswordServiceTests.cs
│   │       └── SlugServiceTests.cs
│   │
│   ├── Directory.Build.props        # Shared build properties
│   ├── Directory.Packages.props     # Centralized package versions
│   └── MyBlog.slnx                  # Solution file
│
├── .github/
│   └── workflows/
│       └── build-deploy.yml         # CI/CD pipeline
│
└── README.md
```

---

## Technology Stack

### Runtime & Frameworks

| Component | Technology | Version |
|-----------|------------|---------|
| Runtime | .NET | 10.0 |
| Web Framework | ASP.NET Core | 10.0 |
| UI Framework | Blazor Server | 10.0 |
| ORM | Entity Framework Core | 10.0.2 |
| Real-Time | SignalR | 10.0.2 |

### Database

| Component | Technology |
|-----------|------------|
| Database Engine | SQLite |
| Storage | Single file, XDG-compliant paths |
| Images | Binary BLOBs in database |

### Observability

| Component | Technology | Version |
|-----------|------------|---------|
| Telemetry | OpenTelemetry | 1.15.0 |
| Tracing | OpenTelemetry.Instrumentation.AspNetCore | 1.15.0 |
| Logging | File (JSON) + Database + Console | — |

### Testing

| Component | Technology | Version |
|-----------|------------|---------|
| Framework | xUnit | v3.2.2 |
| Test SDK | Microsoft.NET.Test.Sdk | 18.0.1 |
| Database | In-Memory SQLite | — |

### Security

| Component | Implementation |
|-----------|----------------|
| Password Hashing | ASP.NET Identity PasswordHasher (PBKDF2) |
| Authentication | Cookie-based with sliding expiration |
| Rate Limiting | Custom middleware with progressive delays |

---

## Quick Start

### Prerequisites

- [.NET 10 SDK](https://dotnet.microsoft.com/download/dotnet/10.0) or later

### Clone and Run

```bash
# Clone the repository
git clone https://github.com/kusl/dotnetcms.git
cd dotnetcms/src

# Restore dependencies
dotnet restore MyBlog.slnx

# Run the application
cd MyBlog.Web
dotnet run
```

The application starts at `https://localhost:51226` (or the next available port).

### Default Credentials

| Field | Value |
|-------|-------|
| Username | `admin` |
| Password | `ChangeMe123!` |

> **⚠️ Important:** The default password is only used when creating the initial admin user. Once the user exists, you must change the password through the website at `/admin/change-password`.

### Running Tests

```bash
cd src
dotnet test MyBlog.slnx
```

Or run the test project directly:

```bash
dotnet run --project src/MyBlog.Tests/MyBlog.Tests.csproj
```

---

## Configuration

### Configuration Files

MyBlog uses the standard ASP.NET Core configuration system with the following files:

#### `appsettings.json` (Production)

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=myblog.db"
  },
  "Authentication": {
    "SessionTimeoutMinutes": 30,
    "DefaultAdminPassword": "ChangeMe123!"
  },
  "Telemetry": {
    "RetentionDays": 30,
    "EnableFileLogging": true,
    "EnableDatabaseLogging": true
  },
  "Application": {
    "Title": "MyBlog",
    "PostsPerPage": 10,
    "RequireHttps": false,
    "GitForgeUrl": "https://github.com/kusl/dotnetcms"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  }
}
```

#### `appsettings.Development.json`

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  }
}
```

### Configuration Reference

#### Application Settings

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `Application:Title` | string | `"MyBlog"` | Site title displayed in header, browser tabs, and metadata |
| `Application:PostsPerPage` | int | `10` | Number of posts per page on the homepage |
| `Application:RequireHttps` | bool | `false` | Force HTTPS for authentication cookies |
| `Application:GitForgeUrl` | string | — | Link to source code repository displayed in footer |

#### Authentication Settings

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `Authentication:SessionTimeoutMinutes` | int | `30` | Session expiration time in minutes |
| `Authentication:DefaultAdminPassword` | string | `"ChangeMe123!"` | Initial admin password (first run only) |

#### Telemetry Settings

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `Telemetry:RetentionDays` | int | `30` | Days to retain telemetry logs before cleanup |
| `Telemetry:EnableFileLogging` | bool | `true` | Write logs to JSON files |
| `Telemetry:EnableDatabaseLogging` | bool | `true` | Store logs in SQLite database |

### Environment Variables

Environment variables override configuration file values:

| Variable | Description | Overrides |
|----------|-------------|-----------|
| `MYBLOG_ADMIN_PASSWORD` | Initial admin password | `Authentication:DefaultAdminPassword` |
| `ASPNETCORE_ENVIRONMENT` | Runtime environment (`Development`, `Production`) | — |
| `XDG_DATA_HOME` | Linux data directory override | Database path |

**Priority order:** Environment Variables > `appsettings.{Environment}.json` > `appsettings.json`

---

## Database

### Schema

MyBlog uses SQLite with Entity Framework Core. The schema is created automatically on first run.

#### Users Table

```sql
CREATE TABLE "Users" (
    "Id" TEXT NOT NULL CONSTRAINT "PK_Users" PRIMARY KEY,
    "Username" TEXT NOT NULL,
    "PasswordHash" TEXT NOT NULL,
    "Email" TEXT NOT NULL,
    "DisplayName" TEXT NOT NULL,
    "CreatedAtUtc" TEXT NOT NULL
);
CREATE UNIQUE INDEX "IX_Users_Username" ON "Users" ("Username");
```

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| Id | GUID | Primary Key | Unique identifier |
| Username | VARCHAR(50) | Unique, Required | Login username (case-insensitive lookup) |
| PasswordHash | VARCHAR(256) | Required | PBKDF2 hash from ASP.NET Identity |
| Email | VARCHAR(256) | Required | User's email address |
| DisplayName | VARCHAR(100) | Required | Name shown on posts |
| CreatedAtUtc | DateTime | Required | Account creation timestamp |

#### Posts Table

```sql
CREATE TABLE "Posts" (
    "Id" TEXT NOT NULL CONSTRAINT "PK_Posts" PRIMARY KEY,
    "Title" TEXT NOT NULL,
    "Slug" TEXT NOT NULL,
    "Content" TEXT NOT NULL,
    "Summary" TEXT NOT NULL,
    "AuthorId" TEXT NOT NULL,
    "CreatedAtUtc" TEXT NOT NULL,
    "UpdatedAtUtc" TEXT NOT NULL,
    "PublishedAtUtc" TEXT,
    "IsPublished" INTEGER NOT NULL,
    CONSTRAINT "FK_Posts_Users_AuthorId" FOREIGN KEY ("AuthorId") 
        REFERENCES "Users" ("Id") ON DELETE RESTRICT
);
CREATE UNIQUE INDEX "IX_Posts_Slug" ON "Posts" ("Slug");
```

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| Id | GUID | Primary Key | Unique identifier |
| Title | VARCHAR(200) | Required | Post title |
| Slug | VARCHAR(200) | Unique, Required | URL-friendly identifier |
| Content | TEXT | Required | Markdown content |
| Summary | VARCHAR(500) | Required | Brief description for listings |
| AuthorId | GUID | Foreign Key | Reference to Users table |
| CreatedAtUtc | DateTime | Required | Creation timestamp |
| UpdatedAtUtc | DateTime | Required | Last modification timestamp |
| PublishedAtUtc | DateTime | Nullable | Publication timestamp |
| IsPublished | Boolean | Required | Visibility flag |

#### Images Table

```sql
CREATE TABLE "Images" (
    "Id" TEXT NOT NULL CONSTRAINT "PK_Images" PRIMARY KEY,
    "FileName" TEXT NOT NULL,
    "ContentType" TEXT NOT NULL,
    "Data" BLOB NOT NULL,
    "PostId" TEXT,
    "UploadedAtUtc" TEXT NOT NULL,
    "UploadedByUserId" TEXT NOT NULL,
    CONSTRAINT "FK_Images_Posts_PostId" FOREIGN KEY ("PostId") 
        REFERENCES "Posts" ("Id") ON DELETE SET NULL,
    CONSTRAINT "FK_Images_Users_UploadedByUserId" FOREIGN KEY ("UploadedByUserId") 
        REFERENCES "Users" ("Id") ON DELETE RESTRICT
);
```

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| Id | GUID | Primary Key | Unique identifier |
| FileName | VARCHAR(256) | Required | Original file name |
| ContentType | VARCHAR(100) | Required | MIME type (image/jpeg, etc.) |
| Data | BLOB | Required | Binary image data |
| PostId | GUID | Nullable, FK | Optional association to a post |
| UploadedAtUtc | DateTime | Required | Upload timestamp |
| UploadedByUserId | GUID | Foreign Key | Reference to uploader |

#### ImageDimensionCache Table

```sql
CREATE TABLE "ImageDimensionCache" (
    "Url" TEXT NOT NULL CONSTRAINT "PK_ImageDimensionCache" PRIMARY KEY,
    "Width" INTEGER NOT NULL,
    "Height" INTEGER NOT NULL,
    "LastCheckedUtc" TEXT NOT NULL
);
```

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| Url | VARCHAR(2048) | Primary Key | Image URL (external images) |
| Width | Integer | Required | Cached width in pixels |
| Height | Integer | Required | Cached height in pixels |
| LastCheckedUtc | DateTime | Required | When dimensions were fetched |

#### TelemetryLogs Table

```sql
CREATE TABLE "TelemetryLogs" (
    "Id" INTEGER NOT NULL CONSTRAINT "PK_TelemetryLogs" PRIMARY KEY AUTOINCREMENT,
    "TimestampUtc" TEXT NOT NULL,
    "Level" TEXT NOT NULL,
    "Category" TEXT NOT NULL,
    "Message" TEXT NOT NULL,
    "Exception" TEXT,
    "TraceId" TEXT,
    "SpanId" TEXT,
    "Properties" TEXT
);
CREATE INDEX "IX_TelemetryLogs_TimestampUtc" ON "TelemetryLogs" ("TimestampUtc");
```

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| Id | Integer | Auto-increment PK | Unique identifier |
| TimestampUtc | DateTime | Required, Indexed | Log timestamp |
| Level | VARCHAR(20) | Required | Log level (Information, Warning, Error) |
| Category | VARCHAR(256) | Required | Logger category/source |
| Message | TEXT | Required | Log message |
| Exception | TEXT | Nullable | Exception details if any |
| TraceId | TEXT | Nullable | Distributed trace ID |
| SpanId | TEXT | Nullable | Span ID within trace |
| Properties | TEXT | Nullable | Additional properties as JSON |

### Database Locations (XDG-Compliant)

The database file location follows platform conventions:

| Platform | Path |
|----------|------|
| Linux | `~/.local/share/MyBlog/myblog.db` |
| macOS | `~/Library/Application Support/MyBlog/myblog.db` |
| Windows | `%LOCALAPPDATA%\MyBlog\myblog.db` |
| Fallback | `{AppDirectory}/data/myblog.db` |

The system automatically:
1. Checks for XDG_DATA_HOME environment variable (Linux)
2. Falls back to platform-specific standard directories
3. Falls back to local `data/` directory if the preferred location is not writable

### Database Initialization

On application startup:

1. **EnsureCreated** — Creates the database and all tables if they don't exist
2. **DatabaseSchemaUpdater.ApplyUpdatesAsync** — Adds new tables to existing databases (for upgrades)
3. **AuthService.EnsureAdminUserAsync** — Creates default admin user if no users exist

### Schema Updates

Since the project doesn't use formal EF Core migrations, the `DatabaseSchemaUpdater` class handles incremental schema updates:

```csharp
public static async Task ApplyUpdatesAsync(BlogDbContext db)
{
    // Check and create ImageDimensionCache table if it doesn't exist
    await EnsureImageDimensionCacheTableAsync(db);
}
```

This approach is idempotent—safe to run multiple times without side effects.

---

## Authentication & Security

### Authentication Flow

```
┌─────────┐     ┌─────────────────┐     ┌─────────────┐
│  User   │───▶│ Rate Limiting   │───▶│   Login     │
│         │     │   Middleware    │     │    Page     │
└─────────┘     └─────────────────┘     └─────────────┘
                       │                       │
                       │ Delay if needed       │ POST /login
                       ▼                       ▼
              ┌─────────────────┐     ┌─────────────┐
              │  Track Attempt  │     │ AuthService │
              │  (per IP)       │     │.Authenticate│
              └─────────────────┘     └─────────────┘
                                              │
                                              ▼
                                      ┌─────────────┐
                                      │ Password    │
                                      │ Service     │
                                      │ .Verify     │
                                      └─────────────┘
                                              │
                              Success ◄───────┴───────► Failure
                                 │                         │
                                 ▼                         ▼
                         ┌─────────────┐          ┌─────────────┐
                         │ Create      │          │ Show Error  │
                         │ Claims &    │          │ Message     │
                         │ Sign In     │          │             │
                         └─────────────┘          └─────────────┘
```

### Password Security

Passwords are hashed using ASP.NET Identity's `PasswordHasher<T>`:

**Algorithm:** PBKDF2 with HMAC-SHA256
- 128-bit salt
- 256-bit subkey
- 10,000+ iterations (version-dependent)

```csharp
public sealed class PasswordService : IPasswordService
{
    private readonly PasswordHasher<User> _hasher = new();

    public string HashPassword(string password)
    {
        return _hasher.HashPassword(null!, password);
    }

    public bool VerifyPassword(string hashedPassword, string providedPassword)
    {
        var result = _hasher.VerifyHashedPassword(null!, hashedPassword, providedPassword);
        return result == PasswordVerificationResult.Success ||
               result == PasswordVerificationResult.SuccessRehashNeeded;
    }
}
```

**Key behaviors:**
- Same password produces different hashes each time (random salt)
- Automatic rehashing detection for algorithm upgrades
- Supports passwords up to 512+ characters

### Rate Limiting

The `LoginRateLimitMiddleware` protects against brute-force attacks using **progressive delays**:

| Attempt # | Delay |
|-----------|-------|
| 1-5 | None |
| 6 | 1 second |
| 7 | 2 seconds |
| 8 | 4 seconds |
| 9 | 8 seconds |
| 10 | 16 seconds |
| 11+ | 30 seconds (max) |

**Key design decisions:**
- **Never blocks users** — Only delays, ensuring legitimate users can always try again
- **Per-IP tracking** — Each IP address has independent attempt counters
- **15-minute window** — Counters reset after 15 minutes of inactivity
- **Testable** — Delay function is injectable for unit testing

```csharp
// Delay calculation formula
var delayMultiplier = record.Count - AttemptsBeforeDelay;  // attempts - 5
var delaySeconds = Math.Min(Math.Pow(2, delayMultiplier), MaxDelaySeconds);  // 2^n, max 30
```

### Session Management

Sessions use cookie-based authentication:

```csharp
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.Cookie.Name = "MyBlog.Auth";
        options.LoginPath = "/login";
        options.LogoutPath = "/logout";
        options.AccessDeniedPath = "/access-denied";
        options.ExpireTimeSpan = TimeSpan.FromMinutes(30);  // Configurable
        options.SlidingExpiration = true;
        options.Cookie.HttpOnly = true;  // XSS protection
        options.Cookie.SecurePolicy = CookieSecurePolicy.SameAsRequest;  // Or Always for HTTPS
    });
```

### Claims Structure

When a user logs in, the following claims are created:

| Claim Type | Value |
|------------|-------|
| `ClaimTypes.NameIdentifier` | User's GUID |
| `ClaimTypes.Name` | Username |
| `DisplayName` | User's display name |
| `ClaimTypes.Role` | "Admin" |

---

## Content Management

### Post Lifecycle

```
┌─────────────────────────────────────────────────────────────────┐
│                        Post Creation                            │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────┐  Generate  ┌─────────────┐  Check    ┌─────────────┐
│ User enters │──────────▶│ SlugService │─────────▶│ IsSlugTaken │
│ Title       │   Slug     │ .Generate   │  Unique?  │ Repository  │
└─────────────┘            └─────────────┘           └─────────────┘
                                                           │
                           ┌───────────────────────────────┤
                           │                               │
                      Unique                          Not Unique
                           │                               │
                           ▼                               ▼
                    ┌─────────────┐              ┌─────────────┐
                    │ Use slug    │              │ Append -1,  │
                    │ as-is       │              │ -2, etc.    │
                    └─────────────┘              └─────────────┘
                           │                               │
                           └───────────────┬───────────────┘
                                           ▼
                                   ┌─────────────┐
                                   │ Save Post   │
                                   │ to Database │
                                   └─────────────┘
```

### Slug Generation Algorithm

The `SlugService` converts titles to URL-friendly slugs:

```csharp
public string GenerateSlugOrUuid(string title)
{
    var slug = GenerateSlug(title);
    return !string.IsNullOrWhiteSpace(slug) 
        ? slug 
        : $"post-{Guid.CreateVersion7().ToString()}";
}

private string GenerateSlug(string title)
{
    // 1. Normalize Unicode (decompose accented characters)
    var normalized = title.Normalize(NormalizationForm.FormD);
    
    // 2. Remove diacritical marks
    // 3. Convert to lowercase
    // 4. Replace spaces/underscores with hyphens
    // 5. Remove non-alphanumeric characters (except hyphens)
    // 6. Collapse multiple hyphens
    // 7. Trim hyphens from ends
}
```

**Examples:**

| Input | Output |
|-------|--------|
| `"Hello World"` | `hello-world` |
| `"Hello, World! How's it going?"` | `hello-world-hows-it-going` |
| `"Café résumé"` | `cafe-resume` |
| `"Top 10 Tips for 2024"` | `top-10-tips-for-2024` |
| `"hello_world_test"` | `hello-world-test` |
| `""` (empty) | `post-{guid}` |
| `"   "` (whitespace only) | `post-{guid}` |

### Post Data Transfer Objects

The system uses DTOs to separate concerns:

```csharp
// For list views (lightweight)
public sealed record PostListItemDto(
    Guid Id,
    string Title,
    string Slug,
    string Summary,
    string AuthorDisplayName,
    DateTime? PublishedAtUtc,
    bool IsPublished);

// For detail views (full content)
public sealed record PostDetailDto(
    Guid Id,
    string Title,
    string Slug,
    string Content,
    string Summary,
    string AuthorDisplayName,
    DateTime CreatedAtUtc,
    DateTime UpdatedAtUtc,
    DateTime? PublishedAtUtc,
    bool IsPublished);

// For creating posts
public sealed record CreatePostDto(
    string Title,
    string Content,
    string Summary,
    bool IsPublished);

// For updating posts
public sealed record UpdatePostDto(
    string Title,
    string Content,
    string Summary,
    bool IsPublished);
```

---

## Markdown Specification

MyBlog uses a **custom-built Markdown parser** with no external dependencies. This section documents the exact specification for compatibility.

### Supported Syntax

#### Headings (ATX Style)

```markdown
# Heading 1
## Heading 2
### Heading 3
#### Heading 4
##### Heading 5
###### Heading 6
```

**Output:**
```html
<h1>Heading 1</h1>
<h2>Heading 2</h2>
<!-- etc. -->
```

#### Bold Text

```markdown
**bold text**
__also bold__
```

**Output:**
```html
<strong>bold text</strong>
<strong>also bold</strong>
```

#### Italic Text

```markdown
*italic text*
_also italic_
```

**Output:**
```html
<em>italic text</em>
<em>also italic</em>
```

#### Links

```markdown
[Link Text](https://example.com)
```

**Output:**
```html
<a href="https://example.com">Link Text</a>
```

#### Images

```markdown
![Alt Text](https://example.com/image.png)
```

**Output (with dimension lookup):**
```html
<img src="https://example.com/image.png" alt="Alt Text" width="800" height="600" />
```

**Output (without dimensions):**
```html
<img src="https://example.com/image.png" alt="Alt Text" />
```

#### Inline Code

```markdown
Use `code` here
```

**Output:**
```html
Use <code>code</code> here
```

#### Fenced Code Blocks

````markdown
```
var x = 1;
console.log(x);
```
````

**Output:**
```html
<pre><code>var x = 1;
console.log(x);</code></pre>
```

> Note: Language specification after the backticks is accepted but not used for syntax highlighting.

#### Blockquotes

```markdown
> This is a quote
```

**Output:**
```html
<blockquote><p>This is a quote</p></blockquote>
```

#### Unordered Lists

```markdown
- Item 1
- Item 2
- Item 3
```

or

```markdown
* Item 1
* Item 2
```

**Output:**
```html
<ul>
<li>Item 1</li>
<li>Item 2</li>
<li>Item 3</li>
</ul>
```

#### Ordered Lists

```markdown
1. First
2. Second
3. Third
```

**Output:**
```html
<ol>
<li>First</li>
<li>Second</li>
<li>Third</li>
</ol>
```

#### Horizontal Rules

```markdown
---
```

or `***` or `___` (3+ characters)

**Output:**
```html
<hr />
```

#### Paragraphs

Regular text separated by blank lines becomes paragraphs:

```markdown
This is paragraph one.

This is paragraph two.
```

**Output:**
```html
<p>This is paragraph one.</p>
<p>This is paragraph two.</p>
```

### Image Dimension Caching

The Markdown service automatically fetches and caches dimensions for external images:

1. **On render:** Check `ImageDimensionCache` table for URL
2. **If cached:** Use stored width/height
3. **If not cached:** Fetch image headers, parse dimensions, store in cache
4. **If fetch fails:** Render image without dimensions (graceful degradation)

**Supported image formats for dimension detection:**
- PNG (dimensions at bytes 16-23)
- GIF (dimensions at bytes 6-9)
- JPEG (requires scanning for SOF marker)
- WebP (VP8, VP8L, VP8X variants)

### HTML Escaping

All user content is HTML-escaped before processing:

```csharp
text = HttpUtility.HtmlEncode(text);
```

This prevents XSS attacks while allowing Markdown syntax.

---

## Image Management

### Upload Specifications

| Specification | Value |
|---------------|-------|
| Maximum Size | 5 MB (5,242,880 bytes) |
| Allowed Types | `image/jpeg`, `image/png`, `image/gif`, `image/webp` |
| Storage | Binary BLOB in SQLite database |

### Upload Process

```
┌─────────────┐     ┌─────────────────┐     ┌─────────────┐
│ InputFile   │───▶│ Validate Size   │───▶│ Validate    │
│ Component   │     │ (< 5MB)         │     │ Content Type│
└─────────────┘     └─────────────────┘     └─────────────┘
                                                   │
                                                   ▼
                    ┌─────────────────┐     ┌─────────────┐
                    │ Save to         │◀───│ Read to     │
                    │ Database        │     │ MemoryStream│
                    └─────────────────┘     └─────────────┘
```

### Using Images in Posts

After uploading, reference images in Markdown using:

```markdown
![Description](/api/images/{guid})
```

Example:
```markdown
![My Photo](/api/images/550e8400-e29b-41d4-a716-446655440000)
```

### Image API Endpoint

**GET** `/api/images/{id}`

Returns the image binary data with appropriate `Content-Type` header.

**Response Headers:**
```
Content-Type: image/jpeg
Content-Length: 12345
```

---

## Real-Time Features

### Reader Tracking

MyBlog tracks how many users are currently reading each post using SignalR.

#### Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│                        Browser                                   │
│  ┌─────────────┐                                                 │
│  │ ReaderBadge │◀──────SignalR Connection──────────────────────┐│
│  │ Component   │                                                ││
│  └─────────────┘                                                ││
└─────────────────────────────────────────────────────────────────┘│
                                                                   │
┌─────────────────────────────────────────────────────────────────┐│
│                        Server                                   ││
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐        ││
│  │ ReaderHub   │───▶│ Tracking    │───▶│ Concurrent  │        ││
│  │ (SignalR)   │     │ Service     │     │ Dictionary  │        ││
│  └─────────────┘     └─────────────┘     └─────────────┘        ││
│         │                                       │               ││
│         └──────────Broadcast Count──────────────┘◀─────────────┘│
└──────────────────────────────────────────────────────────────────┘
```

#### SignalR Hub Methods

```csharp
public class ReaderHub : Hub
{
    // Client calls when viewing a post
    public async Task JoinPage(string slug);
    
    // Client calls when leaving a post
    public async Task LeavePage(string slug);
    
    // Automatically called on disconnect
    public override async Task OnDisconnectedAsync(Exception? exception);
}
```

#### Client Events

| Event | Direction | Payload | Description |
|-------|-----------|---------|-------------|
| `JoinPage` | Client → Server | `string slug` | Register viewer for post |
| `LeavePage` | Client → Server | `string slug` | Unregister viewer |
| `UpdateCount` | Server → Client | `int count` | Broadcast new count |

#### Tracking Service Implementation

```csharp
public class ReaderTrackingService : IReaderTrackingService
{
    // Maps Slug → Count of active readers
    private readonly ConcurrentDictionary<string, int> _slugCounts = new();
    
    // Maps ConnectionId → Slug (for disconnect handling)
    private readonly ConcurrentDictionary<string, string> _connectionMap = new();
}
```

**Thread-safety:** All operations use `ConcurrentDictionary` with atomic operations.

---

## Theming System

### Available Themes

| Theme | Type | Description |
|-------|------|-------------|
| `light` | Light | Clean, professional default |
| `dark` | Dark | Easy on the eyes for night reading |
| `sepia` | Light | Warm, paper-like reading experience |
| `nord` | Dark | Inspired by Arctic landscapes |
| `solarized-light` | Light | Ethan Schoonover's classic palette |
| `dracula` | Dark | Popular dark theme with vibrant accents |

### CSS Variables

Each theme defines the following CSS custom properties:

```css
:root, [data-theme="light"] {
    --color-bg: #ffffff;
    --color-bg-alt: #f8f9fa;
    --color-bg-elevated: #ffffff;
    --color-text: #1a1a2e;
    --color-text-muted: #5a5a6e;
    --color-primary: #2563eb;
    --color-primary-hover: #1d4ed8;
    --color-primary-muted: #3b82f6;
    --color-border: #d1d5db;
    --color-border-light: #e5e7eb;
    --color-danger: #dc2626;
    --color-danger-hover: #b91c1c;
    --color-success: #059669;
    --color-success-hover: #047857;
    --color-warning: #d97706;
    --color-info: #0891b2;
    --color-code-bg: #f1f5f9;
    --color-blockquote-border: #3b82f6;
    --color-selection-bg: #bfdbfe;
    --color-selection-text: #1e3a5f;
    --color-focus-ring: #3b82f6;
    --color-shadow: rgba(0, 0, 0, 0.1);
    --color-overlay: rgba(0, 0, 0, 0.5);
    color-scheme: light;
}
```

### Theme Persistence

Themes are stored in `localStorage`:

```javascript
localStorage.setItem('myblog-theme', 'dark');
```

### System Preference Detection

The system automatically detects and respects the user's OS preference:

```javascript
window.matchMedia('(prefers-color-scheme: dark)').matches
```

If no theme is saved, the system preference is used.

### Flash Prevention

A blocking inline script runs before page render to prevent theme flash:

```javascript
(function() {
    var theme = localStorage.getItem('myblog-theme');
    if (!theme) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    document.documentElement.setAttribute('data-theme', theme);
})();
```

---

## Observability & Telemetry

### OpenTelemetry Integration

MyBlog uses OpenTelemetry for distributed tracing, metrics, and logging.

#### Configuration

```csharp
builder.Services.AddOpenTelemetry()
    .ConfigureResource(resource => resource
        .AddService(serviceName: "MyBlog.Web", serviceVersion: "1.0.0"))
    .WithTracing(tracing => tracing
        .AddAspNetCoreInstrumentation()
        .AddHttpClientInstrumentation()
        .AddSource("MyBlog.Web")
        .AddConsoleExporter())
    .WithMetrics(metrics => metrics
        .AddAspNetCoreInstrumentation()
        .AddHttpClientInstrumentation()
        .AddConsoleExporter());
```

### Log Exporters

#### File Exporter

Writes JSON-formatted logs to rotating files:

```
~/.local/share/MyBlog/telemetry/logs/logs_20260126_063830.json
```

**Format:**
```json
[
{
  "Timestamp": "2026-01-26T06:38:30.1234567Z",
  "Level": "Information",
  "Category": "MyBlog.Web.Pages.Home",
  "Message": "Page loaded",
  "TraceId": "abc123...",
  "SpanId": "def456...",
  "Exception": null
},
...
]
```

**Rotation:** Files rotate at 25 MB with sequential numbering.

#### Database Exporter

Writes structured logs to the `TelemetryLogs` table for queryable storage.

### Automatic Cleanup

The `TelemetryCleanupService` runs daily to remove old logs:

```csharp
public sealed class TelemetryCleanupService : BackgroundService
{
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        // Run cleanup immediately on startup
        await CleanupAsync(stoppingToken);

        // Then run daily
        using var timer = new PeriodicTimer(TimeSpan.FromDays(1));
        while (await timer.WaitForNextTickAsync(stoppingToken))
        {
            await CleanupAsync(stoppingToken);
        }
    }
}
```

**Retention:** Controlled by `Telemetry:RetentionDays` (default: 30 days).

---

## API Reference

### Public Endpoints

#### GET `/`
Homepage with paginated published posts.

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `page` | int | 1 | Page number |

#### GET `/post/{slug}`
View a single published post.

**Path Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| `slug` | string | Post's URL slug |

**Response:** HTML page with SEO metadata, Open Graph tags, and JSON-LD structured data.

#### GET `/about`
About page with application information.

#### GET `/login`
Login page.

**Query Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| `returnUrl` | string | URL to redirect after login |

#### POST `/login`
Authenticate user (handled by Blazor form).

**Form Data:**
| Field | Type | Required |
|-------|------|----------|
| `username` | string | Yes |
| `password` | string | Yes |

#### POST `/logout`
Sign out current user. Requires authentication.

#### GET `/api/images/{id}`
Retrieve an uploaded image.

**Path Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| `id` | GUID | Image identifier |

**Response:**
- `200 OK` with image binary and `Content-Type` header
- `404 Not Found` if image doesn't exist

### Admin Endpoints (Require Authentication)

| Path | Description |
|------|-------------|
| `/admin` | Dashboard |
| `/admin/posts` | Post list |
| `/admin/posts/new` | Create post |
| `/admin/posts/edit/{id}` | Edit post |
| `/admin/users` | User list |
| `/admin/users/new` | Create user |
| `/admin/users/edit/{id}` | Edit user |
| `/admin/images` | Image manager |
| `/admin/change-password` | Change own password |

### SignalR Hub

**Endpoint:** `/readerHub`

| Method | Direction | Parameters | Description |
|--------|-----------|------------|-------------|
| `JoinPage` | Client → Server | `string slug` | Start tracking for a post |
| `LeavePage` | Client → Server | `string slug` | Stop tracking for a post |
| `UpdateCount` | Server → Client | `int count` | Receive updated reader count |

---

## Admin Guide

### Dashboard (`/admin`)

The dashboard provides:
- Total post count
- 5 most recently updated posts
- Quick links to all management areas

### Managing Posts

#### Creating a Post (`/admin/posts/new`)

1. Enter a **Title** (required)
2. Enter a **Summary** (shown in listings)
3. Write **Content** in Markdown
4. Check **Published** to make visible
5. Click **Save**

The slug is automatically generated from the title. If a collision occurs, `-1`, `-2`, etc. is appended.

#### Editing a Post (`/admin/posts/edit/{id}`)

Same as creating, with the current content pre-filled. The slug is regenerated if the title changes.

#### Live Preview

The editor shows a live preview of the rendered Markdown on the right side.

### Managing Users

#### Creating a User (`/admin/users/new`)

| Field | Requirements |
|-------|--------------|
| Username | Unique, required |
| Display Name | Required, shown on posts |
| Email | Required |
| Password | Minimum 8 characters |

#### Editing a User (`/admin/users/edit/{id}`)

All fields except password can be updated. Leave password blank to keep current password.

#### Deleting a User

Users can be deleted except for the currently logged-in user.

### Managing Images (`/admin/images`)

#### Uploading

1. Click the file input or drag-and-drop
2. Select an image (JPEG, PNG, GIF, or WebP)
3. Image uploads automatically

#### Using in Posts

Copy the URL shown below each image thumbnail and paste into your Markdown:

```markdown
![Description](/api/images/550e8400-e29b-41d4-a716-446655440000)
```

#### Deleting

Click **Delete** below any image. This action is immediate and permanent.

### Changing Your Password (`/admin/change-password`)

1. Enter **Current Password**
2. Enter **New Password** (minimum 8 characters)
3. **Confirm New Password**
4. Click **Change Password**

The `MYBLOG_ADMIN_PASSWORD` environment variable does NOT override existing passwords.

---

## Testing

### Test Project Structure

```
MyBlog.Tests/
├── Integration/
│   ├── AuthServiceLongPasswordTests.cs
│   ├── AuthServiceTests.cs
│   ├── PasswordChangeTests.cs
│   ├── PostRepositoryTests.cs
│   └── TelemetryCleanupTests.cs
└── Unit/
    ├── LoginRateLimitMiddlewareTests.cs
    ├── MarkdownServiceTests.cs
    ├── PasswordServiceTests.cs
    └── SlugServiceTests.cs
```

### Test Categories

#### Unit Tests

Test individual components in isolation with mock dependencies.

**PasswordServiceTests (5 tests)**

| Test | Purpose |
|------|---------|
| `HashPassword_ReturnsNonEmptyHash` | Verify hashing produces output |
| `HashPassword_ReturnsDifferentHashForSamePassword` | Verify salt randomization |
| `VerifyPassword_WithCorrectPassword_ReturnsTrue` | Verify correct password matches |
| `VerifyPassword_WithWrongPassword_ReturnsFalse` | Verify incorrect password fails |
| `VerifyPassword_WithEmptyPassword_ReturnsFalse` | Verify empty password fails |

**SlugServiceTests (7 tests)**

| Test | Purpose |
|------|---------|
| `GenerateSlug_WithSimpleTitle_ReturnsLowercaseWithHyphens` | Basic transformation |
| `GenerateSlug_WithSpecialCharacters_RemovesThem` | Punctuation removal |
| `GenerateSlug_WithMultipleSpaces_CollapsesToSingleHyphen` | Space normalization |
| `GenerateSlug_WithUnicode_RemovesDiacritics` | Unicode handling |
| `GenerateSlug_WithLeadingTrailingSpaces_TrimsHyphens` | Edge trimming |
| `GenerateSlug_WithNumbers_PreservesNumbers` | Number preservation |
| `GenerateSlug_WithEmptyStringOrWhitespace_ReturnsGuidWithPrefix` | Fallback behavior |

**MarkdownServiceTests (18 tests)**

| Test | Purpose |
|------|---------|
| `ToHtml_WithHeading1_ReturnsH1Tag` | H1 parsing |
| `ToHtml_WithHeading2_ReturnsH2Tag` | H2 parsing |
| `ToHtml_WithHeading6_ReturnsH6Tag` | H6 parsing |
| `ToHtml_WithBoldText_ReturnsStrongTag` | Bold parsing |
| `ToHtml_WithItalicText_ReturnsEmTag` | Italic parsing |
| `ToHtml_WithLink_ReturnsAnchorTag` | Link parsing |
| `ToHtml_WithImage_InjectsDimensions_IfResolvable` | Image with dimensions |
| `ToHtml_WithImage_NoDimensions_IfUnresolvable` | Image without dimensions |
| `ToHtml_WithImage_WhenServiceThrows_StillRendersImage` | Error handling |
| `ToHtml_WithInlineCode_ReturnsCodeTag` | Inline code |
| `ToHtml_WithCodeBlock_ReturnsPreCodeTags` | Code blocks |
| `ToHtml_WithBlockquote_ReturnsBlockquoteTag` | Blockquotes |
| `ToHtml_WithUnorderedList_ReturnsUlLiTags` | Unordered lists |
| `ToHtml_WithOrderedList_ReturnsOlLiTags` | Ordered lists |
| `ToHtml_WithHorizontalRule_ReturnsHrTag` | Horizontal rules |
| `ToHtml_WithEmptyString_ReturnsEmpty` | Empty input |
| `ToHtml_WithNull_ReturnsEmpty` | Null input |
| `ToHtml_WithMultipleImages_ProcessesAll` | Multiple images |

**LoginRateLimitMiddlewareTests (8 tests)**

| Test | Purpose |
|------|---------|
| `InvokeAsync_NonLoginRequest_PassesThroughImmediately` | Non-login requests unaffected |
| `InvokeAsync_GetLoginRequest_PassesThroughImmediately` | GET requests unaffected |
| `InvokeAsync_FirstFiveAttempts_NoDelay` | Grace period |
| `InvokeAsync_SixthAttempt_HasOneSecondDelay` | First delay |
| `InvokeAsync_ProgressiveDelays_IncreaseExponentially` | Exponential backoff |
| `InvokeAsync_DelayCappedAt30Seconds` | Maximum delay cap |
| `InvokeAsync_AfterManyAttempts_NeverBlocks` | Never blocks (100 attempts) |
| `InvokeAsync_DifferentIPs_IndependentTracking` | Per-IP isolation |

#### Integration Tests

Test components with real database (in-memory SQLite).

**AuthServiceTests (5 tests)**

| Test | Purpose |
|------|---------|
| `AuthenticateAsync_WithValidCredentials_ReturnsUser` | Successful login |
| `AuthenticateAsync_WithInvalidPassword_ReturnsNull` | Wrong password |
| `AuthenticateAsync_WithNonExistentUser_ReturnsNull` | Unknown user |
| `EnsureAdminUserAsync_WhenNoUsersExist_CreatesAdmin` | Initial setup |
| `EnsureAdminUserAsync_WhenUsersExist_DoesNotCreateAnother` | Idempotence |

**AuthServiceLongPasswordTests (8 tests)**

| Test | Purpose |
|------|---------|
| `AuthenticateAsync_With128CharacterPassword_Succeeds` | Long password support |
| `AuthenticateAsync_With256CharacterPassword_Succeeds` | Very long password |
| `AuthenticateAsync_With512CharacterPassword_Succeeds` | Extra long password |
| `ChangePasswordAsync_With128CharacterNewPassword_Succeeds` | Long password change |
| `AuthenticateAsync_WithComplexLongPassword_Succeeds` | Mixed character password |
| `AuthenticateAsync_After100FailedAttempts_StillAllowsLogin` | No lockout (100) |
| `AuthenticateAsync_After1000FailedAttempts_StillAllowsLogin` | No lockout (1000) |
| `AuthenticateAsync_InterleavedFailuresAndSuccesses_NeverLocks` | Interleaved attempts |

**PasswordChangeTests (7 tests)**

| Test | Purpose |
|------|---------|
| `ChangePasswordAsync_WithCorrectCurrentPassword_ReturnsTrue` | Successful change |
| `ChangePasswordAsync_WithCorrectPassword_AllowsLoginWithNewPassword` | New password works |
| `ChangePasswordAsync_WithWrongCurrentPassword_ReturnsFalse` | Wrong current password |
| `ChangePasswordAsync_WithWrongPassword_DoesNotChangePassword` | Failed change preserves old |
| `ChangePasswordAsync_WithNonExistentUser_ReturnsFalse` | Invalid user |
| `ResetPasswordAsync_SetsNewPassword` | Admin reset |
| `ResetPasswordAsync_WithNonExistentUser_ThrowsException` | Invalid user throws |

**PostRepositoryTests (8 tests)**

| Test | Purpose |
|------|---------|
| `CreateAsync_AddsPostToDatabase` | Create post |
| `GetByIdAsync_WithExistingId_ReturnsPost` | Retrieve by ID |
| `GetByIdAsync_WithNonExistingId_ReturnsNull` | Non-existent ID |
| `GetBySlugAsync_WithExistingSlug_ReturnsPost` | Retrieve by slug |
| `GetPublishedPostsAsync_ReturnsOnlyPublishedPosts` | Published filter |
| `UpdateAsync_ModifiesPost` | Update post |
| `DeleteAsync_RemovesPost` | Delete post |
| `GetPublishedPostsAsync_ReturnsCorrectCount` | Pagination count |

**TelemetryCleanupTests (3 tests)**

| Test | Purpose |
|------|---------|
| `DeleteOlderThanAsync_RemovesOldLogs` | Cleanup old logs |
| `DeleteOlderThanAsync_WithNoOldLogs_ReturnsZero` | No-op when nothing to clean |
| `DeleteOlderThanAsync_WithEmptyTable_ReturnsZero` | Empty table handling |

### Running Tests

```bash
# Run all tests
cd src
dotnet test MyBlog.slnx

# Run with detailed output
dotnet test MyBlog.slnx --verbosity normal

# Run specific test class
dotnet test MyBlog.slnx --filter "FullyQualifiedName~SlugServiceTests"

# Run specific test
dotnet test MyBlog.slnx --filter "FullyQualifiedName~GenerateSlug_WithUnicode"

# Generate TRX report
dotnet test MyBlog.slnx --logger trx --results-directory TestResults
```

### Test Database Strategy

Integration tests use **in-memory SQLite**:

```csharp
var options = new DbContextOptionsBuilder<BlogDbContext>()
    .UseSqlite("Data Source=:memory:")
    .Options;

_context = new BlogDbContext(options);
_context.Database.OpenConnection();  // Keep connection open
_context.Database.EnsureCreated();
```

**Benefits:**
- Fast execution (no disk I/O)
- Isolated per test class
- Cross-platform compatible
- No cleanup required

### Testing Rate Limiting

The rate limiting middleware uses an injectable delay function for testing:

```csharp
// Production: Real delays
public LoginRateLimitMiddleware(RequestDelegate next, ILogger logger)
    : this(next, logger, null) { }

// Testing: No-op delay function
public LoginRateLimitMiddleware(
    RequestDelegate next,
    ILogger logger,
    Func<TimeSpan, CancellationToken, Task>? delayFunc)
{
    _delayFunc = delayFunc;
}

// In InvokeAsync:
if (_delayFunc != null)
    await _delayFunc(delay, context.RequestAborted);  // Test path
else
    await Task.Delay(delay, context.RequestAborted);  // Production path
```

This allows tests to run instantly while still verifying delay calculations.

---

## Deployment

### GitHub Actions Pipeline

The project includes a complete CI/CD pipeline (`.github/workflows/build-deploy.yml`):

```yaml
name: Build, Test, and Deploy

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  build-test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore src/MyBlog.slnx

      - name: Build solution
        run: dotnet build src/MyBlog.slnx -c Release --no-restore

      - name: Run tests
        run: dotnet run --project src/MyBlog.Tests/MyBlog.Tests.csproj

  deploy:
    needs: build-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    runs-on: windows-latest
    
    # ... deployment steps
```

### Required GitHub Secrets

| Secret | Description | Example |
|--------|-------------|---------|
| `WEBSITE_NAME` | IIS site name | `MyBlog` |
| `SERVER_COMPUTER_NAME` | Server hostname | `myserver.example.com` |
| `SERVER_USERNAME` | WebDeploy username | `deploy-user` |
| `SERVER_PASSWORD` | WebDeploy password | (secure) |

### WebDeploy Configuration

The deployment uses WebDeploy with important features:

```powershell
& $msdeployPath -verb:sync $sourceArg $destArg `
    -allowUntrusted `
    -enableRule:DoNotDeleteRule `    # Preserve existing files
    -enableRule:AppOffline `          # Graceful shutdown
    -retryAttempts:3 `
    -retryInterval:3000
```

**AppOffline Rule:** Creates `app_offline.htm` to:
1. Stop the application gracefully
2. Release file locks
3. Allow deployment
4. Remove the file to restart

### Manual Deployment

#### Windows (IIS)

```bash
# Build for Windows
dotnet publish src/MyBlog.Web/MyBlog.Web.csproj -c Release -o ./publish -r win-x64

# Copy to server
xcopy /s /y publish \\server\wwwroot\MyBlog

# Or use WebDeploy
msdeploy -verb:sync -source:contentPath=./publish -dest:contentPath=MyBlog,...
```

#### Linux

```bash
# Build for Linux
dotnet publish src/MyBlog.Web/MyBlog.Web.csproj -c Release -o ./publish -r linux-x64

# Copy to server
rsync -avz publish/ user@server:/var/www/myblog/

# Create systemd service
sudo nano /etc/systemd/system/myblog.service
```

Example systemd service:

```ini
[Unit]
Description=MyBlog Web Application
After=network.target

[Service]
WorkingDirectory=/var/www/myblog
ExecStart=/var/www/myblog/MyBlog.Web
Restart=always
RestartSec=10
KillSignal=SIGINT
User=www-data
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

[Install]
WantedBy=multi-user.target
```

### IIS Configuration

1. Install [.NET 10 Hosting Bundle](https://dotnet.microsoft.com/download/dotnet/10.0)
2. Create a new IIS site pointing to the publish folder
3. Set Application Pool to **"No Managed Code"**
4. Ensure the Application Pool identity has **write access** to:
   - `%LOCALAPPDATA%\MyBlog\` (database)
   - Telemetry directory (if file logging enabled)

---

## Troubleshooting

### ERROR_FILE_IN_USE During Deployment

**Cause:** Application DLLs are locked because the app is running.

**Solution:** Use the `-enableRule:AppOffline` flag in WebDeploy (included in the GitHub Actions workflow).

### Password Not Changing After Setting MYBLOG_ADMIN_PASSWORD

**Cause:** The environment variable only works when **no users exist** in the database.

**Solution:**
1. Stop the application
2. Delete the database file
3. Set `MYBLOG_ADMIN_PASSWORD`
4. Start the application

Or use `/admin/change-password` to change the password through the UI.

### Database Locked Errors

**Cause:** SQLite can have locking issues with concurrent access.

**Solutions:**
- Ensure only one instance of the application is running
- Check that no database tools have the file open
- Verify file permissions on the database directory

### Theme Not Persisting

**Cause:** localStorage might be blocked or cleared.

**Solutions:**
- Check browser privacy settings
- Ensure JavaScript is enabled
- Clear browser cache and try again

### Images Not Displaying

**Cause:** Image URL might be incorrect or image was deleted.

**Solutions:**
- Verify the GUID in the URL matches an existing image
- Check `/admin/images` to confirm the image exists
- Ensure the URL format is `/api/images/{guid}`

### Rate Limiting Delays

**Note:** Rate limiting never blocks, only delays.

**Expected delays after failed login attempts:**
- Attempts 1-5: No delay
- Attempt 6: 1 second
- Attempt 7: 2 seconds
- etc., up to 30 seconds maximum

**Solution:** Wait for the delay window (15 minutes) to reset, or use the correct password.

### SignalR Connection Issues

**Symptoms:** Reader count not updating.

**Solutions:**
- Check browser console for WebSocket errors
- Verify `/readerHub` endpoint is accessible
- Check for proxy/firewall blocking WebSocket connections

---

## Contributing

### Development Setup

1. Clone the repository
2. Install .NET 10 SDK
3. Open `src/MyBlog.slnx` in your IDE
4. Run `dotnet restore`
5. Run `dotnet build`
6. Run `dotnet test`

### Code Style

The project uses `.editorconfig` for consistent formatting:

- File-scoped namespaces
- 4-space indentation
- LF line endings
- Private fields prefixed with `_`

### Pull Request Process

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Write tests for new functionality
4. Ensure all tests pass
5. Commit changes (`git commit -m 'Add amazing feature'`)
6. Push to branch (`git push origin feature/amazing-feature`)
7. Open a Pull Request

### Testing Requirements

- All new features must have corresponding tests
- All tests must pass on Windows, Linux, and macOS
- Code coverage should not decrease

---

## License

MIT License

Copyright (c) 2026

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

---

## Acknowledgments

- Built with [.NET](https://dotnet.microsoft.com/) and [Blazor](https://dotnet.microsoft.com/apps/aspnet/web-apps/blazor)
- Observability powered by [OpenTelemetry](https://opentelemetry.io/)
- Inspired by the simplicity of static site generators with the power of dynamic applications
- AI assistance provided by [Claude](https://www.anthropic.com/claude) (Anthropic) and [Gemini](https://deepmind.google/technologies/gemini/) (Google) among others

---

<p align="center">
  Built with ❤️ using .NET 10 and Blazor Server
</p>



























================================================================================
FILE: run-e2e.sh
SIZE: 3.12 KB
MODIFIED: 2026-01-26 09:56:37
================================================================================

#!/bin/bash
# =============================================================================
# Run E2E Tests with Podman Compose
# =============================================================================
# This script runs Playwright E2E tests against MyBlog using containers.
# Designed for Fedora with SELinux and Podman.
#
# Usage:
#   ./run-e2e.sh          # Run all E2E tests
#   ./run-e2e.sh --build  # Force rebuild containers
#   ./run-e2e.sh --clean  # Clean up and remove volumes
# =============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Parse arguments
BUILD_FLAG=""
CLEAN_FLAG=""

for arg in "$@"; do
    case $arg in
        --build)
            BUILD_FLAG="--build"
            ;;
        --clean)
            CLEAN_FLAG="true"
            ;;
    esac
done

# Clean up if requested
if [ "$CLEAN_FLAG" == "true" ]; then
    log_info "Cleaning up containers and volumes..."
    podman-compose -f docker-compose.e2e.yml down -v --remove-orphans 2>/dev/null || true
    podman system prune -f 2>/dev/null || true
    log_info "Cleanup complete"
    exit 0
fi

# Create test results directory
mkdir -p test-results
# Set SELinux context if on Fedora with SELinux
if command -v chcon &> /dev/null && getenforce 2>/dev/null | grep -q "Enforcing"; then
    log_info "Setting SELinux context for test-results directory..."
    chcon -Rt svirt_sandbox_file_t test-results 2>/dev/null || true
fi

log_info "Starting E2E test environment..."

# Build and start services
log_info "Building containers..."
podman-compose -f docker-compose.e2e.yml build $BUILD_FLAG

log_info "Starting MyBlog web service..."
podman-compose -f docker-compose.e2e.yml up -d myblog-web

# Wait for web service to be healthy
log_info "Waiting for MyBlog to be ready..."
RETRIES=30
until podman exec myblog-web curl -sf http://localhost:5000/ > /dev/null 2>&1; do
    RETRIES=$((RETRIES - 1))
    if [ $RETRIES -eq 0 ]; then
        log_error "MyBlog failed to start within timeout"
        podman-compose -f docker-compose.e2e.yml logs myblog-web
        podman-compose -f docker-compose.e2e.yml down -v
        exit 1
    fi
    echo -n "."
    sleep 2
done
echo ""
log_info "MyBlog is ready!"

# Run E2E tests
log_info "Running E2E tests..."
podman-compose -f docker-compose.e2e.yml up myblog-e2e
E2E_EXIT_CODE=$?

# Capture logs
log_info "Capturing logs..."
podman-compose -f docker-compose.e2e.yml logs myblog-web > test-results/myblog-web.log 2>&1
podman-compose -f docker-compose.e2e.yml logs myblog-e2e > test-results/myblog-e2e.log 2>&1

# Clean up
log_info "Cleaning up..."
podman-compose -f docker-compose.e2e.yml down -v

if [ $E2E_EXIT_CODE -eq 0 ]; then
    log_info "E2E tests passed! ✓"
else
    log_error "E2E tests failed with exit code $E2E_EXIT_CODE"
    log_info "Check test-results/ directory for logs"
fi

exit $E2E_EXIT_CODE


================================================================================
FILE: src/Directory.Build.props
SIZE: .56 KB
MODIFIED: 2026-01-01 22:21:17
================================================================================

<Project>
  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <LangVersion>latest</LangVersion>
    <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
    <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
    <AnalysisLevel>latest</AnalysisLevel>
  </PropertyGroup>
  
  <PropertyGroup Condition="$(MSBuildProjectName.Contains('.Tests'))">
    <IsPackable>false</IsPackable>
    <OutputType>Exe</OutputType>
    <IsTestProject>true</IsTestProject>
  </PropertyGroup>
</Project>


================================================================================
FILE: src/Directory.Packages.props
SIZE: 1.71 KB
MODIFIED: 2026-01-26 11:01:31
================================================================================

<Project>
  <PropertyGroup>
    <ManagePackageVersionsCentrally>true</ManagePackageVersionsCentrally>
    <CentralPackageTransitivePinningEnabled>true</CentralPackageTransitivePinningEnabled>
  </PropertyGroup>
  <ItemGroup>
    <!-- Core Framework (.NET 10) -->
    <PackageVersion Include="Microsoft.AspNetCore.SignalR.Client" Version="10.0.2" />
    <PackageVersion Include="Microsoft.EntityFrameworkCore.Sqlite" Version="10.0.2" />
    <PackageVersion Include="Microsoft.EntityFrameworkCore.Design" Version="10.0.1" />
    <PackageVersion Include="Microsoft.AspNetCore.Identity" Version="2.3.9" />
    <PackageVersion Include="Microsoft.Extensions.Hosting" Version="10.0.1" />
    <!-- OpenTelemetry (official packages only) -->
    <PackageVersion Include="Microsoft.Extensions.Http" Version="10.0.2" />
    <PackageVersion Include="Microsoft.Extensions.Logging" Version="10.0.2" />
    <PackageVersion Include="OpenTelemetry" Version="1.15.0" />
    <PackageVersion Include="OpenTelemetry.Extensions.Hosting" Version="1.15.0" />
    <PackageVersion Include="OpenTelemetry.Instrumentation.AspNetCore" Version="1.15.0" />
    <PackageVersion Include="OpenTelemetry.Exporter.Console" Version="1.15.0" />
    <PackageVersion Include="OpenTelemetry.Instrumentation.Http" Version="1.15.0" />
    <!-- Testing (xUnit v3) -->
    <PackageVersion Include="xunit.v3" Version="3.2.2" />
    <PackageVersion Include="Microsoft.NET.Test.Sdk" Version="18.0.1" />
    <PackageVersion Include="xunit.runner.visualstudio" Version="3.1.5" />
    <PackageVersion Include="Microsoft.Testing.Extensions.TrxReport" Version="2.0.2" />
    <!-- E2E Testing (Playwright) -->
    <PackageVersion Include="Microsoft.Playwright" Version="1.57.0" />
  </ItemGroup>
</Project>


================================================================================
FILE: src/.github/workflows/build-deploy.yml
SIZE: 3.10 KB
MODIFIED: 2025-12-28 11:33:37
================================================================================

name: Build, Test, and Deploy

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  build-test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore src/MyBlog.slnx

      - name: Build solution
        run: dotnet build src/MyBlog.slnx -c Release --no-restore

      - name: Run tests
        run: dotnet test src/MyBlog.slnx -c Release --no-build --logger trx --results-directory TestResults

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}
          path: TestResults
          retention-days: 7

  deploy:
    needs: build-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish application
        run: dotnet publish src/MyBlog.Web/MyBlog.Web.csproj -c Release -o ./publish -r win-x86 --self-contained false

      - name: Deploy via WebDeploy
        shell: pwsh
        env:
          DEPLOY_SOURCE: ${{ github.workspace }}\publish
          DEPLOY_SITE: ${{ secrets.WEBSITE_NAME }}
          DEPLOY_HOST: ${{ secrets.SERVER_COMPUTER_NAME }}
          DEPLOY_USER: ${{ secrets.SERVER_USERNAME }}
          DEPLOY_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          $msdeployPath = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"
          
          if (-not (Test-Path $msdeployPath)) {
            Write-Host "Installing Web Deploy..."
            choco install webdeploy -y --no-progress
          }
          
          Write-Host "Deploying to $env:DEPLOY_HOST..."
          Write-Host "Note: Using AppOffline rule to prevent file-in-use errors"

          $sourceArg = "-source:contentPath=$env:DEPLOY_SOURCE"
          $destArg = "-dest:contentPath=$env:DEPLOY_SITE,computerName=https://$($env:DEPLOY_HOST):8172/MsDeploy.axd?site=$env:DEPLOY_SITE,userName=$env:DEPLOY_USER,password=$env:DEPLOY_PASSWORD,AuthType='Basic'"
          
          # Key fix: Added -enableRule:AppOffline to stop the app during deployment
          # This creates app_offline.htm, waits for app to stop, deploys, then removes the file
          & $msdeployPath -verb:sync $sourceArg $destArg `
            -allowUntrusted `
            -enableRule:DoNotDeleteRule `
            -enableRule:AppOffline `
            -retryAttempts:3 `
            -retryInterval:3000
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Deployment failed with exit code $LASTEXITCODE"
            exit 1
          }
          
          Write-Host "Deployment completed successfully!"


================================================================================
FILE: src/global.json
SIZE: .12 KB
MODIFIED: 2026-01-21 11:56:44
================================================================================

{
  "sdk": {
    "version": "10.0.100",
    "rollForward": "major"
  },
  "test": {
    "runner": "Microsoft.Testing.Platform"
  }
}


================================================================================
FILE: src/MyBlog.Core/Constants/AppConstants.cs
SIZE: .73 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

namespace MyBlog.Core.Constants;

/// <summary>
/// Application-wide constants.
/// </summary>
public static class AppConstants
{
    /// <summary>The name of the authentication cookie.</summary>
    public const string AuthCookieName = "MyBlog.Auth";

    /// <summary>The admin role claim value.</summary>
    public const string AdminRole = "Admin";

    /// <summary>Default page size for listings.</summary>
    public const int DefaultPageSize = 10;

    /// <summary>Maximum image size in bytes (5MB).</summary>
    public const int MaxImageSizeBytes = 5 * 1024 * 1024;

    /// <summary>Allowed image content types.</summary>
    public static readonly string[] AllowedImageTypes =
        ["image/jpeg", "image/png", "image/gif", "image/webp"];
}


================================================================================
FILE: src/MyBlog.Core/Interfaces/IAuthService.cs
SIZE: 1.05 KB
MODIFIED: 2025-12-28 11:33:37
================================================================================

using MyBlog.Core.Models;

namespace MyBlog.Core.Interfaces;

/// <summary>
/// Service interface for authentication operations.
/// </summary>
public interface IAuthService
{
    /// <summary>Attempts to authenticate a user.</summary>
    Task<User?> AuthenticateAsync(
        string username, string password, CancellationToken cancellationToken = default);

    /// <summary>Ensures the default admin user exists.</summary>
    Task EnsureAdminUserAsync(CancellationToken cancellationToken = default);

    /// <summary>Changes a user's password.</summary>
    /// <returns>True if password was changed, false if current password was incorrect.</returns>
    Task<bool> ChangePasswordAsync(
        Guid userId,
        string currentPassword,
        string newPassword,
        CancellationToken cancellationToken = default);

    /// <summary>Resets a user's password without requiring the current password (admin function).</summary>
    Task ResetPasswordAsync(
        Guid userId,
        string newPassword,
        CancellationToken cancellationToken = default);
}


================================================================================
FILE: src/MyBlog.Core/Interfaces/IImageDimensionService.cs
SIZE: .68 KB
MODIFIED: 2026-01-16 21:39:27
================================================================================

namespace MyBlog.Core.Interfaces;

/// <summary>
/// Service for resolving and caching the width and height of images from URLs.
/// </summary>
public interface IImageDimensionService
{
    /// <summary>
    /// Gets the dimensions (width, height) of an image from a URL.
    /// Checks the database cache first; fetches and caches if missing.
    /// </summary>
    /// <param name="url">The absolute URL of the image.</param>
    /// <param name="cancellationToken">Cancellation token.</param>
    /// <returns>A tuple containing Width and Height, or null if resolution fails.</returns>
    Task<(int Width, int Height)?> GetDimensionsAsync(string url, CancellationToken cancellationToken = default);
}


================================================================================
FILE: src/MyBlog.Core/Interfaces/IImageRepository.cs
SIZE: .69 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

using MyBlog.Core.Models;

namespace MyBlog.Core.Interfaces;

/// <summary>
/// Repository interface for image operations.
/// </summary>
public interface IImageRepository
{
    /// <summary>Gets all images.</summary>
    Task<IReadOnlyList<Image>> GetAllAsync(CancellationToken cancellationToken = default);

    /// <summary>Gets an image by ID.</summary>
    Task<Image?> GetByIdAsync(Guid id, CancellationToken cancellationToken = default);

    /// <summary>Creates a new image.</summary>
    Task<Image> CreateAsync(Image image, CancellationToken cancellationToken = default);

    /// <summary>Deletes an image by ID.</summary>
    Task DeleteAsync(Guid id, CancellationToken cancellationToken = default);
}


================================================================================
FILE: src/MyBlog.Core/Interfaces/IMarkdownService.cs
SIZE: .25 KB
MODIFIED: 2026-01-16 21:46:20
================================================================================

namespace MyBlog.Core.Interfaces;

/// <summary>
/// Service interface for rendering Markdown to HTML.
/// </summary>
public interface IMarkdownService
{
    /// <summary>Converts Markdown text to HTML.</summary>
    Task<string> ToHtmlAsync(string markdown);
}


================================================================================
FILE: src/MyBlog.Core/Interfaces/IPasswordService.cs
SIZE: .38 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

namespace MyBlog.Core.Interfaces;

/// <summary>
/// Service interface for password hashing and verification.
/// </summary>
public interface IPasswordService
{
    /// <summary>Hashes a plain text password.</summary>
    string HashPassword(string password);

    /// <summary>Verifies a password against a hash.</summary>
    bool VerifyPassword(string hashedPassword, string providedPassword);
}


================================================================================
FILE: src/MyBlog.Core/Interfaces/IPostRepository.cs
SIZE: 1.75 KB
MODIFIED: 2026-01-14 19:57:11
================================================================================

using MyBlog.Core.Models;

namespace MyBlog.Core.Interfaces;

/// <summary>
/// Repository interface for post operations.
/// </summary>
public interface IPostRepository
{
    /// <summary>Gets a paginated list of published posts.</summary>
    Task<(IReadOnlyList<PostListItemDto> Posts, int TotalCount)> GetPublishedPostsAsync(
        int page, int pageSize, CancellationToken cancellationToken = default);

    /// <summary>Gets all posts for admin view.</summary>
    Task<IReadOnlyList<PostListItemDto>> GetAllPostsAsync(
        CancellationToken cancellationToken = default);

    /// <summary>Gets a post by its slug.</summary>
    Task<PostDetailDto?> GetBySlugAsync(string slug, CancellationToken cancellationToken = default);

    /// <summary>Gets a post by its ID.</summary>
    Task<Post?> GetByIdAsync(Guid id, CancellationToken cancellationToken = default);

    /// <summary>Creates a new post.</summary>
    Task<Post> CreateAsync(Post post, CancellationToken cancellationToken = default);

    /// <summary>Updates an existing post.</summary>
    Task UpdateAsync(Post post, CancellationToken cancellationToken = default);

    /// <summary>Deletes a post by ID.</summary>
    Task DeleteAsync(Guid id, CancellationToken cancellationToken = default);

    /// <summary>Gets the total count of posts.</summary>
    Task<int> GetCountAsync(CancellationToken cancellationToken = default);

    /// <summary>Gets recent posts for dashboard.</summary>
    Task<IReadOnlyList<PostListItemDto>> GetRecentPostsAsync(
        int count, CancellationToken cancellationToken = default);

    /// <summary>Checks if a slug is already in use by another post.</summary>
    Task<bool> IsSlugTakenAsync(string slug, Guid? excludePostId = null, CancellationToken cancellationToken = default);
}


================================================================================
FILE: src/MyBlog.Core/Interfaces/IReaderTrackingService.cs
SIZE: .90 KB
MODIFIED: 2026-01-16 20:30:07
================================================================================

namespace MyBlog.Core.Interfaces;

public interface IReaderTrackingService
{
    /// <summary>
    /// Registers a connection viewing a specific post.
    /// </summary>
    /// <returns>The new reader count for this slug.</returns>
    int JoinPost(string slug, string connectionId);

    /// <summary>
    /// Unregisters a connection from a specific post.
    /// </summary>
    /// <returns>The new reader count for this slug.</returns>
    int LeavePost(string slug, string connectionId);

    /// <summary>
    /// Handles a disconnection event (e.g. tab closed) and determines which slug was being viewed.
    /// </summary>
    /// <returns>A tuple containing the Slug that was left (if any) and the new count.</returns>
    (string? Slug, int NewCount) Disconnect(string connectionId);

    /// <summary>
    /// Gets the current count for a specific post.
    /// </summary>
    int GetReaderCount(string slug);
}


================================================================================
FILE: src/MyBlog.Core/Interfaces/ISlugService.cs
SIZE: .25 KB
MODIFIED: 2026-01-19 18:32:54
================================================================================

namespace MyBlog.Core.Interfaces;

/// <summary>
/// Service interface for generating URL-friendly slugs.
/// </summary>
public interface ISlugService
{
    /// <summary>Generates a slug from a title.</summary>
    string GenerateSlugOrUuid(string title);
}


================================================================================
FILE: src/MyBlog.Core/Interfaces/ITelemetryLogRepository.cs
SIZE: .67 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

using MyBlog.Core.Models;

namespace MyBlog.Core.Interfaces;

/// <summary>
/// Repository interface for telemetry log operations.
/// </summary>
public interface ITelemetryLogRepository
{
    /// <summary>Writes a log entry to the database.</summary>
    Task WriteAsync(TelemetryLog log, CancellationToken cancellationToken = default);

    /// <summary>Deletes logs older than the specified date.</summary>
    Task<int> DeleteOlderThanAsync(DateTime cutoffUtc, CancellationToken cancellationToken = default);

    /// <summary>Gets recent logs for viewing.</summary>
    Task<IReadOnlyList<TelemetryLog>> GetRecentAsync(
        int count, CancellationToken cancellationToken = default);
}


================================================================================
FILE: src/MyBlog.Core/Interfaces/IUserRepository.cs
SIZE: 1.09 KB
MODIFIED: 2025-12-30 21:28:12
================================================================================

using MyBlog.Core.Models;

namespace MyBlog.Core.Interfaces;

/// <summary>
/// Repository interface for user data access.
/// </summary>
public interface IUserRepository
{
    /// <summary>Gets a user by ID.</summary>
    Task<User?> GetByIdAsync(Guid id, CancellationToken cancellationToken = default);

    /// <summary>Gets a user by username.</summary>
    Task<User?> GetByUsernameAsync(string username, CancellationToken cancellationToken = default);

    /// <summary>Gets all users.</summary>
    Task<IReadOnlyList<User>> GetAllAsync(CancellationToken cancellationToken = default);

    /// <summary>Checks if any users exist.</summary>
    Task<bool> AnyUsersExistAsync(CancellationToken cancellationToken = default);

    /// <summary>Creates a new user.</summary>
    Task CreateAsync(User user, CancellationToken cancellationToken = default);

    /// <summary>Updates an existing user.</summary>
    Task UpdateAsync(User user, CancellationToken cancellationToken = default);

    /// <summary>Deletes a user by ID.</summary>
    Task DeleteAsync(Guid id, CancellationToken cancellationToken = default);
}


================================================================================
FILE: src/MyBlog.Core/Models/Image.cs
SIZE: 1.15 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

namespace MyBlog.Core.Models;

/// <summary>
/// Represents an image stored as a BLOB in the database.
/// </summary>
public sealed class Image
{
    /// <summary>Gets or sets the unique identifier for the image.</summary>
    public Guid Id { get; set; }

    /// <summary>Gets or sets the original file name.</summary>
    public required string FileName { get; set; }

    /// <summary>Gets or sets the MIME content type.</summary>
    public required string ContentType { get; set; }

    /// <summary>Gets or sets the binary image data.</summary>
    public required byte[] Data { get; set; }

    /// <summary>Gets or sets the associated post ID (optional).</summary>
    public Guid? PostId { get; set; }

    /// <summary>Gets or sets when the image was uploaded.</summary>
    public DateTime UploadedAtUtc { get; set; }

    /// <summary>Gets or sets the ID of the user who uploaded the image.</summary>
    public Guid UploadedByUserId { get; set; }

    /// <summary>Navigation property for the associated post.</summary>
    public Post? Post { get; set; }

    /// <summary>Navigation property for the uploader.</summary>
    public User? UploadedBy { get; set; }
}


================================================================================
FILE: src/MyBlog.Core/Models/ImageDimensionCache.cs
SIZE: .58 KB
MODIFIED: 2026-01-16 21:38:23
================================================================================

namespace MyBlog.Core.Models;

/// <summary>
/// Caches dimensions for external images to prevent layout shifts.
/// </summary>
public sealed class ImageDimensionCache
{
    /// <summary>The absolute URL of the image (Primary Key).</summary>
    public required string Url { get; set; }

    /// <summary>The detected width of the image.</summary>
    public int Width { get; set; }

    /// <summary>The detected height of the image.</summary>
    public int Height { get; set; }

    /// <summary>When this record was last updated.</summary>
    public DateTime LastCheckedUtc { get; set; }
}


================================================================================
FILE: src/MyBlog.Core/Models/Post.cs
SIZE: 1.49 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

namespace MyBlog.Core.Models;

/// <summary>
/// Represents a blog post with Markdown content.
/// </summary>
public sealed class Post
{
    /// <summary>Gets or sets the unique identifier for the post.</summary>
    public Guid Id { get; set; }

    /// <summary>Gets or sets the post title.</summary>
    public required string Title { get; set; }

    /// <summary>Gets or sets the URL-friendly slug.</summary>
    public required string Slug { get; set; }

    /// <summary>Gets or sets the Markdown content of the post.</summary>
    public required string Content { get; set; }

    /// <summary>Gets or sets a brief summary for listings.</summary>
    public required string Summary { get; set; }

    /// <summary>Gets or sets the author's user ID.</summary>
    public Guid AuthorId { get; set; }

    /// <summary>Gets or sets when the post was created.</summary>
    public DateTime CreatedAtUtc { get; set; }

    /// <summary>Gets or sets when the post was last updated.</summary>
    public DateTime UpdatedAtUtc { get; set; }

    /// <summary>Gets or sets when the post was published (null if draft).</summary>
    public DateTime? PublishedAtUtc { get; set; }

    /// <summary>Gets or sets whether the post is publicly visible.</summary>
    public bool IsPublished { get; set; }

    /// <summary>Navigation property for the author.</summary>
    public User? Author { get; set; }

    /// <summary>Navigation property for attached images.</summary>
    public ICollection<Image> Images { get; set; } = [];
}


================================================================================
FILE: src/MyBlog.Core/Models/PostDto.cs
SIZE: .95 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

namespace MyBlog.Core.Models;

/// <summary>Data transfer object for post listings.</summary>
public sealed record PostListItemDto(
    Guid Id,
    string Title,
    string Slug,
    string Summary,
    string AuthorDisplayName,
    DateTime? PublishedAtUtc,
    bool IsPublished);

/// <summary>Data transfer object for creating a new post.</summary>
public sealed record CreatePostDto(
    string Title,
    string Content,
    string Summary,
    bool IsPublished);

/// <summary>Data transfer object for updating a post.</summary>
public sealed record UpdatePostDto(
    string Title,
    string Content,
    string Summary,
    bool IsPublished);

/// <summary>Data transfer object for post details.</summary>
public sealed record PostDetailDto(
    Guid Id,
    string Title,
    string Slug,
    string Content,
    string Summary,
    string AuthorDisplayName,
    DateTime CreatedAtUtc,
    DateTime UpdatedAtUtc,
    DateTime? PublishedAtUtc,
    bool IsPublished);


================================================================================
FILE: src/MyBlog.Core/Models/TelemetryLog.cs
SIZE: 1.17 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

namespace MyBlog.Core.Models;

/// <summary>
/// Represents a telemetry log entry stored in the database.
/// </summary>
public sealed class TelemetryLog
{
    /// <summary>Gets or sets the auto-increment primary key.</summary>
    public int Id { get; set; }

    /// <summary>Gets or sets the UTC timestamp of the log entry.</summary>
    public DateTime TimestampUtc { get; set; }

    /// <summary>Gets or sets the log level (Information, Warning, Error, etc.).</summary>
    public required string Level { get; set; }

    /// <summary>Gets or sets the category/source of the log.</summary>
    public required string Category { get; set; }

    /// <summary>Gets or sets the log message.</summary>
    public required string Message { get; set; }

    /// <summary>Gets or sets the exception details if any.</summary>
    public string? Exception { get; set; }

    /// <summary>Gets or sets the distributed trace ID.</summary>
    public string? TraceId { get; set; }

    /// <summary>Gets or sets the span ID within the trace.</summary>
    public string? SpanId { get; set; }

    /// <summary>Gets or sets additional properties as JSON.</summary>
    public string? Properties { get; set; }
}


================================================================================
FILE: src/MyBlog.Core/Models/User.cs
SIZE: 1.12 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

namespace MyBlog.Core.Models;

/// <summary>
/// Represents a user who can create and manage blog posts.
/// </summary>
public sealed class User
{
    /// <summary>Gets or sets the unique identifier for the user.</summary>
    public Guid Id { get; set; }

    /// <summary>Gets or sets the unique username for authentication.</summary>
    public required string Username { get; set; }

    /// <summary>Gets or sets the hashed password.</summary>
    public required string PasswordHash { get; set; }

    /// <summary>Gets or sets the user's email address.</summary>
    public required string Email { get; set; }

    /// <summary>Gets or sets the display name shown on posts.</summary>
    public required string DisplayName { get; set; }

    /// <summary>Gets or sets when the user account was created.</summary>
    public DateTime CreatedAtUtc { get; set; }

    /// <summary>Navigation property for posts authored by this user.</summary>
    public ICollection<Post> Posts { get; set; } = [];

    /// <summary>Navigation property for images uploaded by this user.</summary>
    public ICollection<Image> UploadedImages { get; set; } = [];
}


================================================================================
FILE: src/MyBlog.Core/MyBlog.Core.csproj
SIZE: .21 KB
MODIFIED: 2026-01-20 09:10:15
================================================================================

<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <RootNamespace>MyBlog.Core</RootNamespace>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="Microsoft.Extensions.Logging" />
  </ItemGroup>
</Project>


================================================================================
FILE: src/MyBlog.Core/Services/MarkdownService.cs
SIZE: 8.51 KB
MODIFIED: 2026-01-20 09:11:02
================================================================================

using System.Text;
using System.Text.RegularExpressions;
using System.Web;
using Microsoft.Extensions.Logging;
using MyBlog.Core.Interfaces;

namespace MyBlog.Core.Services;

/// <summary>
/// Custom Markdown parser that converts Markdown text to HTML.
/// Supports: headings, bold, italic, links, images, code blocks, blockquotes, lists, horizontal rules.
/// </summary>
public sealed partial class MarkdownService(
    IImageDimensionService imageDimensionService,
    ILogger<MarkdownService>? logger = null)
    : IMarkdownService
{
    private enum ListType { None, Unordered, Ordered }

    /// <inheritdoc />
    public async Task<string> ToHtmlAsync(string markdown)
    {
        if (string.IsNullOrWhiteSpace(markdown))
        {
            return string.Empty;
        }

        var lines = markdown.Replace("\r\n", "\n").Split('\n');
        var result = new StringBuilder();
        var inCodeBlock = false;
        var currentListType = ListType.None;
        var codeBlockContent = new StringBuilder();

        foreach (var rawLine in lines)
        {
            var line = rawLine;

            // Handle fenced code blocks
            if (line.StartsWith("```"))
            {
                if (inCodeBlock)
                {
                    result.Append("<pre><code>");
                    result.Append(HttpUtility.HtmlEncode(codeBlockContent.ToString().TrimEnd()));
                    result.AppendLine("</code></pre>");
                    codeBlockContent.Clear();
                    inCodeBlock = false;
                }
                else
                {
                    result.Append(CloseList(ref currentListType));
                    inCodeBlock = true;
                }
                continue;
            }

            if (inCodeBlock)
            {
                codeBlockContent.AppendLine(line);
                continue;
            }

            // Handle horizontal rules
            if (HorizontalRulePattern().IsMatch(line))
            {
                result.Append(CloseList(ref currentListType));
                result.AppendLine("<hr />");
                continue;
            }

            // Handle headings
            var headingMatch = HeadingPattern().Match(line);
            if (headingMatch.Success)
            {
                result.Append(CloseList(ref currentListType));
                var level = headingMatch.Groups[1].Value.Length;
                var text = await ProcessInlineAsync(headingMatch.Groups[2].Value);
                result.AppendLine($"<h{level}>{text}</h{level}>");
                continue;
            }

            // Handle blockquotes
            if (line.StartsWith("> "))
            {
                result.Append(CloseList(ref currentListType));
                var quoteText = await ProcessInlineAsync(line[2..]);
                result.AppendLine($"<blockquote><p>{quoteText}</p></blockquote>");
                continue;
            }

            // Handle unordered lists
            var unorderedMatch = UnorderedListPattern().Match(line);
            if (unorderedMatch.Success)
            {
                if (currentListType != ListType.Unordered)
                {
                    result.Append(CloseList(ref currentListType));
                    result.AppendLine("<ul>");
                    currentListType = ListType.Unordered;
                }
                var itemText = await ProcessInlineAsync(unorderedMatch.Groups[1].Value);
                result.AppendLine($"<li>{itemText}</li>");
                continue;
            }

            // Handle ordered lists
            var orderedMatch = OrderedListPattern().Match(line);
            if (orderedMatch.Success)
            {
                if (currentListType != ListType.Ordered)
                {
                    result.Append(CloseList(ref currentListType));
                    result.AppendLine("<ol>");
                    currentListType = ListType.Ordered;
                }
                var itemText = await ProcessInlineAsync(orderedMatch.Groups[1].Value);
                result.AppendLine($"<li>{itemText}</li>");
                continue;
            }

            // Close list if no longer in list item
            if (currentListType != ListType.None && !string.IsNullOrWhiteSpace(line))
            {
                result.Append(CloseList(ref currentListType));
            }

            // Handle empty lines
            if (string.IsNullOrWhiteSpace(line))
            {
                result.Append(CloseList(ref currentListType));
                continue;
            }

            // Regular paragraph
            var paragraphText = await ProcessInlineAsync(line);
            result.AppendLine($"<p>{paragraphText}</p>");
        }

        // Close any open list
        result.Append(CloseList(ref currentListType));

        // Close any unclosed code block
        if (inCodeBlock)
        {
            result.Append("<pre><code>");
            result.Append(HttpUtility.HtmlEncode(codeBlockContent.ToString().TrimEnd()));
            result.AppendLine("</code></pre>");
        }

        return result.ToString();
    }

    private static string CloseList(ref ListType listType)
    {
        var result = listType switch
        {
            ListType.Unordered => "</ul>\n",
            ListType.Ordered => "</ol>\n",
            _ => ""
        };
        listType = ListType.None;
        return result;
    }

    private async Task<string> ProcessInlineAsync(string text)
    {
        // Escape HTML first
        text = HttpUtility.HtmlEncode(text);

        // Process inline code
        text = InlineCodePattern().Replace(text, "<code>$1</code>");

        // Process images ![alt](url) -> WITH AUTOMATED DIMENSION LOOKUP
        // Regex replacement doesn't support async, so we find matches, process them, and replace.
        var matches = ImagePattern().Matches(text);
        if (matches.Count > 0)
        {
            // Process matches in reverse to avoid index drift
            for (var i = matches.Count - 1; i >= 0; i--)
            {
                var match = matches[i];
                var alt = match.Groups[1].Value;
                var url = match.Groups[2].Value;

                string imgTag;
                try
                {
                    // Lookup dimensions (Fast DB check or background fetch)
                    // This is wrapped in try-catch to ensure we never fail rendering
                    var dimensions = await imageDimensionService.GetDimensionsAsync(url);

                    imgTag = dimensions.HasValue ? $"<img src=\"{url}\" alt=\"{alt}\" width=\"{dimensions.Value.Width}\" height=\"{dimensions.Value.Height}\" />" :
                        // No dimensions available - render without width/height
                        $"<img src=\"{url}\" alt=\"{alt}\" />";
                }
                catch (Exception ex)
                {
                    // If dimension lookup fails for any reason, still render the image
                    logger?.LogWarning(ex, "Failed to get dimensions for image {Url}. Rendering without dimensions.", url);
                    imgTag = $"<img src=\"{url}\" alt=\"{alt}\" />";
                }

                // Replace the Markdown syntax with the HTML tag
                text = text.Remove(match.Index, match.Length).Insert(match.Index, imgTag);
            }
        }

        // Process links
        text = LinkPattern().Replace(text, "<a href=\"$2\">$1</a>");

        // Process bold
        text = BoldPattern().Replace(text, "<strong>$1</strong>");

        // Process italic
        text = ItalicPattern().Replace(text, "<em>$1</em>");

        return text;
    }

    [GeneratedRegex(@"^(#{1,6})\s+(.+)$")]
    private static partial Regex HeadingPattern();

    [GeneratedRegex(@"^[-*]\s+(.+)$")]
    private static partial Regex UnorderedListPattern();

    [GeneratedRegex(@"^\d+\.\s+(.+)$")]
    private static partial Regex OrderedListPattern();

    [GeneratedRegex(@"^[-*_]{3,}\s*$")]
    private static partial Regex HorizontalRulePattern();

    [GeneratedRegex(@"`([^`]+)`")]
    private static partial Regex InlineCodePattern();

    // Standard Markdown image pattern: ![alt](url)
    [GeneratedRegex(@"!\[([^\]]*)\]\(([^)]+)\)")]
    private static partial Regex ImagePattern();

    [GeneratedRegex(@"\[([^\]]+)\]\(([^)]+)\)")]
    private static partial Regex LinkPattern();

    [GeneratedRegex(@"\*\*([^*]+)\*\*|__([^_]+)__")]
    private static partial Regex BoldPattern();

    [GeneratedRegex(@"(?<!\*)\*(?!\*)([^*]+)(?<!\*)\*(?!\*)|(?<!_)_(?!_)([^_]+)(?<!_)_(?!_)")]
    private static partial Regex ItalicPattern();
}


================================================================================
FILE: src/MyBlog.Core/Services/SlugService.cs
SIZE: 1.73 KB
MODIFIED: 2026-01-19 19:46:10
================================================================================

using System.Globalization;
using System.Text;
using System.Text.RegularExpressions;
using MyBlog.Core.Interfaces;

namespace MyBlog.Core.Services;

/// <summary>
/// Generates URL-friendly slugs from text.
/// </summary>
public sealed partial class SlugService : ISlugService
{
    /// <inheritdoc />
    public string GenerateSlugOrUuid(string title)
    {
        var slug = GenerateSlug(title);

        return !string.IsNullOrWhiteSpace(slug) ? slug : $"post-{Guid.CreateVersion7().ToString()}";
    }

    private string GenerateSlug(string title)
    {
        // Normalize unicode and convert to lowercase
        var normalized = title.Normalize(NormalizationForm.FormD);
        var sb = new StringBuilder();

        foreach (var c in normalized)
        {
            var category = CharUnicodeInfo.GetUnicodeCategory(c);
            if (category != UnicodeCategory.NonSpacingMark)
            {
                sb.Append(c);
            }
        }

        var result = sb.ToString().Normalize(NormalizationForm.FormC).ToLowerInvariant();

        // Replace spaces and underscores with hyphens
        result = SpacePattern().Replace(result, "-");

        // Remove all non-alphanumeric characters except hyphens
        result = NonAlphanumericPattern().Replace(result, "");

        // Replace multiple hyphens with single hyphen
        result = MultipleHyphenPattern().Replace(result, "-");

        // Trim hyphens from ends
        result = result.Trim('-');

        return result;
    }

    [GeneratedRegex(@"[\s_]+")]
    private static partial Regex SpacePattern();

    [GeneratedRegex(@"[^a-z0-9\-]")]
    private static partial Regex NonAlphanumericPattern();

    [GeneratedRegex(@"-+")]
    private static partial Regex MultipleHyphenPattern();
}


================================================================================
FILE: src/MyBlog.E2E/Dockerfile
SIZE: 2.31 KB
MODIFIED: 2026-01-26 11:05:48
================================================================================

# E2E Test Runner with Playwright
# Single stage using .NET 10 SDK for both build and run
FROM mcr.microsoft.com/dotnet/sdk:10.0-noble

WORKDIR /src

# Install Playwright browser dependencies (Chromium) for Ubuntu Noble
# PowerShell needs to be installed from Microsoft's repo
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    wget \
    curl \
    gnupg \
    ca-certificates \
    fonts-liberation \
    libasound2t64 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libatspi2.0-0 \
    libcairo2 \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libgbm1 \
    libglib2.0-0 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libpango-1.0-0 \
    libx11-6 \
    libxcb1 \
    libxcomposite1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxkbcommon0 \
    libxrandr2 \
    xdg-utils \
    && rm -rf /var/lib/apt/lists/*

# Install PowerShell from Microsoft repo
RUN wget -q https://packages.microsoft.com/config/ubuntu/24.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb && \
    dpkg -i packages-microsoft-prod.deb && \
    rm packages-microsoft-prod.deb && \
    apt-get update && \
    apt-get install -y --no-install-recommends powershell && \
    rm -rf /var/lib/apt/lists/*

# Copy all project files first for restore
COPY Directory.Build.props .
COPY Directory.Packages.props .
COPY MyBlog.Core/MyBlog.Core.csproj MyBlog.Core/
COPY MyBlog.Infrastructure/MyBlog.Infrastructure.csproj MyBlog.Infrastructure/
COPY MyBlog.Web/MyBlog.Web.csproj MyBlog.Web/
COPY MyBlog.E2E/MyBlog.E2E.csproj MyBlog.E2E/

# Restore ALL projects to ensure transitive dependencies are available
RUN dotnet restore MyBlog.Core/MyBlog.Core.csproj && \
    dotnet restore MyBlog.Infrastructure/MyBlog.Infrastructure.csproj && \
    dotnet restore MyBlog.Web/MyBlog.Web.csproj && \
    dotnet restore MyBlog.E2E/MyBlog.E2E.csproj

# Copy all source code
COPY . .

# Build the E2E project
RUN dotnet build MyBlog.E2E/MyBlog.E2E.csproj -c Release

# Install Playwright browsers using the PowerShell script generated by the build
RUN pwsh ./MyBlog.E2E/bin/Release/net10.0/playwright.ps1 install chromium

WORKDIR /src/MyBlog.E2E

# Set environment variables
ENV MYBLOG_BASE_URL=http://myblog-web:5000
ENV PLAYWRIGHT_HEADLESS=true

# Run tests using dotnet run (xUnit v3 style)
ENTRYPOINT ["dotnet", "run", "-c", "Release", "--no-build"]


================================================================================
FILE: src/MyBlog.E2E/MyBlog.E2E.csproj
SIZE: .44 KB
MODIFIED: 2026-01-26 10:23:36
================================================================================

<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <RootNamespace>MyBlog.E2E</RootNamespace>
    <IsTestProject>true</IsTestProject>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.NET.Test.Sdk" />
    <PackageReference Include="xunit.v3" />
    <PackageReference Include="Microsoft.Playwright" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\MyBlog.Web\MyBlog.Web.csproj" />
  </ItemGroup>
</Project>


================================================================================
FILE: src/MyBlog.E2E/PlaywrightCollection.cs
SIZE: .35 KB
MODIFIED: 2026-01-26 09:53:31
================================================================================

using Xunit;

namespace MyBlog.E2E;

/// <summary>
/// Collection definition for sharing PlaywrightFixture across tests.
/// All tests using this collection share a single browser instance.
/// </summary>
[CollectionDefinition(Name)]
public sealed class PlaywrightCollection : ICollectionFixture<PlaywrightFixture>
{
    public const string Name = "Playwright";
}


================================================================================
FILE: src/MyBlog.E2E/PlaywrightFixture.cs
SIZE: 2.07 KB
MODIFIED: 2026-01-27 08:44:52
================================================================================

using Microsoft.Playwright;
using Xunit;

namespace MyBlog.E2E;

/// <summary>
/// Shared Playwright fixture for E2E tests.
/// Provides browser and context instances reused across tests.
/// </summary>
public sealed class PlaywrightFixture : IAsyncLifetime
{
    private IPlaywright? _playwright;
    private IBrowser? _browser;

    public IBrowser Browser => _browser ?? throw new InvalidOperationException("Browser not initialized");
    public IPlaywright Playwright => _playwright ?? throw new InvalidOperationException("Playwright not initialized");

    /// <summary>
    /// Base URL for the application under test.
    /// Can be overridden via environment variable for container testing.
    /// </summary>
    public string BaseUrl => Environment.GetEnvironmentVariable("MYBLOG_BASE_URL") ?? "http://localhost:5000";

    public async ValueTask InitializeAsync()
    {
        _playwright = await Microsoft.Playwright.Playwright.CreateAsync();

        var headless = Environment.GetEnvironmentVariable("PLAYWRIGHT_HEADLESS") != "false";

        _browser = await _playwright.Chromium.LaunchAsync(new BrowserTypeLaunchOptions
        {
            Headless = headless,
            SlowMo = headless ? 0 : 100 // Slow down for debugging when not headless
        });
    }

    public async ValueTask DisposeAsync()
    {
        if (_browser is not null)
        {
            await _browser.CloseAsync();
        }

        _playwright?.Dispose();
    }

    /// <summary>
    /// Creates a new browser context with default settings.
    /// </summary>
    public async Task<IBrowserContext> CreateContextAsync()
    {
        return await Browser.NewContextAsync(new BrowserNewContextOptions
        {
            BaseURL = BaseUrl,
            IgnoreHTTPSErrors = true,
            ViewportSize = new ViewportSize { Width = 1280, Height = 720 }
        });
    }

    /// <summary>
    /// Creates a new page with a fresh context.
    /// </summary>
    public async Task<IPage> CreatePageAsync()
    {
        var context = await CreateContextAsync();
        return await context.NewPageAsync();
    }
}


================================================================================
FILE: src/MyBlog.E2E/Tests/AboutPageTests.cs
SIZE: 2.05 KB
MODIFIED: 2026-01-27 08:04:49
================================================================================

using Microsoft.Playwright;
using Xunit;

namespace MyBlog.E2E.Tests;

/// <summary>
/// E2E tests for the about page (Epic 1: Public Content Viewing).
/// </summary>
[Collection(PlaywrightCollection.Name)]
public sealed class AboutPageTests(PlaywrightFixture fixture)
{
    private readonly PlaywrightFixture _fixture = fixture;

    [Fact]
    public async Task AboutPage_LoadsSuccessfully()
    {
        var page = await _fixture.CreatePageAsync();

        var response = await page.GotoAsync("/about");

        Assert.NotNull(response);
        Assert.True(response.Ok, $"Expected OK response, got {response.Status}");
    }

    [Fact]
    public async Task AboutPage_DisplaysAboutHeading()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/about");

        var heading = page.Locator("h1");
        await Assertions.Expect(heading).ToBeVisibleAsync();
        await Assertions.Expect(heading).ToContainTextAsync("About");
    }

    [Fact]
    public async Task AboutPage_DisplaysArchitectureSection()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/about");

        var architectureSection = page.Locator("text=Architecture");
        await Assertions.Expect(architectureSection.First).ToBeVisibleAsync();
    }

    [Fact]
    public async Task AboutPage_DisplaysTechnologyStack()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/about");

        // The about page should mention .NET and Blazor
        var content = await page.ContentAsync();
        Assert.Contains(".NET", content);
        Assert.Contains("Blazor", content);
    }

    [Fact]
    public async Task AboutPage_HasReaderBadge()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/about");

        // Wait for SignalR connection and reader badge
        var readerBadge = page.Locator(".reader-badge, .reader-info");
        await Assertions.Expect(readerBadge.First).ToBeVisibleAsync(new LocatorAssertionsToBeVisibleOptions { Timeout = 10000 });
    }
}


================================================================================
FILE: src/MyBlog.E2E/Tests/HomePageTests.cs
SIZE: 2.15 KB
MODIFIED: 2026-01-26 09:53:45
================================================================================

using Microsoft.Playwright;
using Xunit;

namespace MyBlog.E2E.Tests;

/// <summary>
/// E2E tests for the homepage (Epic 1: Public Content Viewing).
/// </summary>
[Collection(PlaywrightCollection.Name)]
public sealed class HomePageTests(PlaywrightFixture fixture)
{
    private readonly PlaywrightFixture _fixture = fixture;

    [Fact]
    public async Task HomePage_LoadsSuccessfully()
    {
        var page = await _fixture.CreatePageAsync();

        var response = await page.GotoAsync("/");

        Assert.NotNull(response);
        Assert.True(response.Ok, $"Expected OK response, got {response.Status}");
    }

    [Fact]
    public async Task HomePage_DisplaysWelcomeHeading()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/");

        var heading = page.Locator("h1");
        await Assertions.Expect(heading).ToBeVisibleAsync();
        await Assertions.Expect(heading).ToContainTextAsync("Welcome");
    }

    [Fact]
    public async Task HomePage_HasNavigationLinks()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/");

        // Check for essential navigation links
        var homeLink = page.Locator("nav a[href='/']");
        var aboutLink = page.Locator("nav a[href='/about']");
        var loginLink = page.Locator("nav a[href='/login']");

        await Assertions.Expect(homeLink).ToBeVisibleAsync();
        await Assertions.Expect(aboutLink).ToBeVisibleAsync();
        await Assertions.Expect(loginLink).ToBeVisibleAsync();
    }

    [Fact]
    public async Task HomePage_HasFooter()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/");

        var footer = page.Locator("footer");
        await Assertions.Expect(footer).ToBeVisibleAsync();
    }

    [Fact]
    public async Task HomePage_NavigationToAbout_Works()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/");

        await page.ClickAsync("nav a[href='/about']");

        await page.WaitForURLAsync("**/about");
        var heading = page.Locator("h1");
        await Assertions.Expect(heading).ToContainTextAsync("About");
    }
}


================================================================================
FILE: src/MyBlog.E2E/Tests/LoginPageTests.cs
SIZE: 3.66 KB
MODIFIED: 2026-01-27 08:42:19
================================================================================

using System.Text.RegularExpressions;
using Microsoft.Playwright;
using Xunit;

namespace MyBlog.E2E.Tests;

[Collection(PlaywrightCollection.Name)]
public sealed class LoginPageTests(PlaywrightFixture fixture)
{
    private readonly PlaywrightFixture _fixture = fixture;

    [Fact]
    public async Task LoginPage_LoadsSuccessfully()
    {
        var page = await _fixture.CreatePageAsync();
        var response = await page.GotoAsync("/login");

        Assert.NotNull(response);
        Assert.True(response.Ok, $"Expected OK response, got {response.Status}");
    }

    [Fact]
    public async Task LoginPage_DisplaysLoginForm()
    {
        var page = await _fixture.CreatePageAsync();
        await page.GotoAsync("/login");

        // Use Web Assertions to wait for visibility
        await Assertions.Expect(page.Locator("input[name='username']")).ToBeVisibleAsync();
        await Assertions.Expect(page.Locator("input[name='password']")).ToBeVisibleAsync();
        await Assertions.Expect(page.Locator("button[type='submit']")).ToBeVisibleAsync();
    }

    [Fact]
    public async Task LoginPage_WithInvalidCredentials_ShowsError()
    {
        var page = await _fixture.CreatePageAsync();
        await page.GotoAsync("/login");

        await page.FillAsync("input[name='username']", "invalid");
        await page.FillAsync("input[name='password']", "invalid");

        await page.ClickAsync("button[type='submit']");

        // Web Assertion: This automatically waits for the error message to appear
        // It handles the postback and re-render implicitly.
        var errorLocator = page.Locator(".error-message");
        await Assertions.Expect(errorLocator).ToBeVisibleAsync();
        await Assertions.Expect(errorLocator).ToContainTextAsync("Invalid username or password");
    }

    [Fact]
    public async Task LoginPage_WithValidCredentials_RedirectsToAdmin()
    {
        var page = await _fixture.CreatePageAsync();
        await page.GotoAsync("/login");

        await page.FillAsync("input[name='username']", "admin");
        await page.FillAsync("input[name='password']", "ChangeMe123!");

        await page.ClickAsync("button[type='submit']");

        // KEY FIX: Use Expect(page).ToHaveURLAsync
        // This replaces WaitForURLAsync. It retries repeatedly until the URL matches
        // the regex or the timeout is reached. It implies navigation is complete.
        await Assertions.Expect(page).ToHaveURLAsync(new Regex("/admin"));
    }

    [Fact]
    public async Task LoginPage_AfterLogin_ShowsLogoutButton()
    {
        var page = await _fixture.CreatePageAsync();
        await page.GotoAsync("/login");

        await page.FillAsync("input[name='username']", "admin");
        await page.FillAsync("input[name='password']", "ChangeMe123!");

        await page.ClickAsync("button[type='submit']");

        // 1. Guard Assertion: Verify we landed on the right URL first.
        // This ensures the POST succeeded and redirect happened.
        await Assertions.Expect(page).ToHaveURLAsync(new Regex("/admin"));

        // 2. State Assertion: Verify Blazor has hydrated and shows the Dashboard header.
        // In your Dashboard.razor, there is an <h1>Admin Dashboard</h1>.
        // Waiting for this ensures the main content area is ready.
        await Assertions.Expect(page.Locator("h1")).ToContainTextAsync("Dashboard");

        // 3. Auth Assertion: Verify the Logout button is visible.
        // In MainLayout.razor, this button is inside <Authorized>, so its presence
        // proves authentication state is resolved.
        var logoutButton = page.Locator("form[action='/logout'] button");
        await Assertions.Expect(logoutButton).ToBeVisibleAsync();
    }
}


================================================================================
FILE: src/MyBlog.E2E/Tests/ThemeSwitcherTests.cs
SIZE: 2.98 KB
MODIFIED: 2026-01-26 11:44:49
================================================================================

using Microsoft.Playwright;
using Xunit;

namespace MyBlog.E2E.Tests;

/// <summary>
/// E2E tests for the theme switcher (Epic 1: UI/UX).
/// The ThemeSwitcher is a button-based dropdown menu, not a select element.
/// </summary>
[Collection(PlaywrightCollection.Name)]
public sealed class ThemeSwitcherTests(PlaywrightFixture fixture)
{
    private readonly PlaywrightFixture _fixture = fixture;

    [Fact]
    public async Task ThemeSwitcher_IsVisibleOnPage()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/");

        // The theme switcher is a div with class .theme-switcher containing a button
        var themeSwitcher = page.Locator(".theme-switcher");
        await Assertions.Expect(themeSwitcher).ToBeVisibleAsync();
    }

    [Fact]
    public async Task ThemeSwitcher_ChangesTheme()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/");

        // Wait for Blazor to be fully ready (SignalR connection and JS interop initialized)
        await page.WaitForLoadStateAsync(LoadState.NetworkIdle);
        await page.WaitForTimeoutAsync(1000);

        // Click the theme switcher button to open the menu
        var themeSwitcherBtn = page.Locator(".theme-switcher-btn");
        await themeSwitcherBtn.ClickAsync();

        // Wait for the menu to be visible (CSS transition)
        var themeMenu = page.Locator(".theme-menu.open");
        await Assertions.Expect(themeMenu).ToBeVisibleAsync(new LocatorAssertionsToBeVisibleOptions { Timeout = 5000 });

        // Click on the "dark" theme option
        var darkOption = page.Locator(".theme-option:has-text('Dark')");
        await darkOption.ClickAsync();

        // Wait a moment for the theme to apply
        await page.WaitForTimeoutAsync(500);

        // Check that theme changed to dark
        var newTheme = await page.EvaluateAsync<string>("document.documentElement.getAttribute('data-theme')");
        Assert.Equal("dark", newTheme);
    }

    [Fact]
    public async Task ThemeSwitcher_HasMultipleOptions()
    {
        var page = await _fixture.CreatePageAsync();

        await page.GotoAsync("/");

        // Wait for Blazor to be fully ready (SignalR connection and JS interop initialized)
        await page.WaitForLoadStateAsync(LoadState.NetworkIdle);
        await page.WaitForTimeoutAsync(1000);

        // Click the theme switcher button to open the menu
        var themeSwitcherBtn = page.Locator(".theme-switcher-btn");
        await themeSwitcherBtn.ClickAsync();

        // Wait for the menu to be visible (CSS transition)
        var themeMenu = page.Locator(".theme-menu.open");
        await Assertions.Expect(themeMenu).ToBeVisibleAsync(new LocatorAssertionsToBeVisibleOptions { Timeout = 5000 });

        // Count the theme options (buttons with class .theme-option)
        var options = page.Locator(".theme-option");
        var count = await options.CountAsync();

        Assert.True(count >= 2, $"Expected at least 2 theme options, got {count}");
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Data/BlogDbContext.cs
SIZE: 3.53 KB
MODIFIED: 2026-01-16 21:38:47
================================================================================

using Microsoft.EntityFrameworkCore;
using MyBlog.Core.Models;

namespace MyBlog.Infrastructure.Data;

/// <summary>
/// Entity Framework Core database context for the blog.
/// </summary>
public sealed class BlogDbContext : DbContext
{
    /// <summary>Initializes a new instance of the BlogDbContext.</summary>
    public BlogDbContext(DbContextOptions<BlogDbContext> options) : base(options)
    {
    }

    /// <summary>Gets or sets the Users table.</summary>
    public DbSet<User> Users => Set<User>();
    /// <summary>Gets or sets the Posts table.</summary>
    public DbSet<Post> Posts => Set<Post>();
    /// <summary>Gets or sets the Images table.</summary>
    public DbSet<Image> Images => Set<Image>();
    /// <summary>Gets or sets the TelemetryLogs table.</summary>
    public DbSet<TelemetryLog> TelemetryLogs => Set<TelemetryLog>();
    /// <summary>Gets or sets the Image Dimension Cache table.</summary>
    public DbSet<ImageDimensionCache> ImageDimensionCache => Set<ImageDimensionCache>();

    /// <inheritdoc />
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);

        // User configuration
        modelBuilder.Entity<User>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.Username).HasMaxLength(50).IsRequired();
            entity.HasIndex(e => e.Username).IsUnique();
            entity.Property(e => e.PasswordHash).HasMaxLength(256).IsRequired();
            entity.Property(e => e.Email).HasMaxLength(256).IsRequired();
            entity.Property(e => e.DisplayName).HasMaxLength(100).IsRequired();
        });

        // Post configuration
        modelBuilder.Entity<Post>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.Title).HasMaxLength(200).IsRequired();
            entity.Property(e => e.Slug).HasMaxLength(200).IsRequired();
            entity.HasIndex(e => e.Slug).IsUnique();
            entity.Property(e => e.Summary).HasMaxLength(500).IsRequired();
            entity.HasOne(e => e.Author)
                .WithMany(u => u.Posts)
                .HasForeignKey(e => e.AuthorId)
                .OnDelete(DeleteBehavior.Restrict);
        });

        // Image configuration
        modelBuilder.Entity<Image>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.FileName).HasMaxLength(256).IsRequired();
            entity.Property(e => e.ContentType).HasMaxLength(100).IsRequired();
            entity.HasOne(e => e.Post)
                .WithMany(p => p.Images)
                .HasForeignKey(e => e.PostId)
                .OnDelete(DeleteBehavior.SetNull);
            entity.HasOne(e => e.UploadedBy)
                .WithMany(u => u.UploadedImages)
                .HasForeignKey(e => e.UploadedByUserId)
                .OnDelete(DeleteBehavior.Restrict);
        });

        // TelemetryLog configuration
        modelBuilder.Entity<TelemetryLog>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.Id).ValueGeneratedOnAdd();
            entity.Property(e => e.Level).HasMaxLength(20).IsRequired();
            entity.Property(e => e.Category).HasMaxLength(256).IsRequired();
            entity.HasIndex(e => e.TimestampUtc);
        });

        // ImageDimensionCache configuration
        modelBuilder.Entity<ImageDimensionCache>(entity =>
        {
            entity.HasKey(e => e.Url); // URL is the primary key
            entity.Property(e => e.Url).HasMaxLength(2048); // Support long URLs
        });
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Data/DatabasePathResolver.cs
SIZE: 1.90 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

namespace MyBlog.Infrastructure.Data;

/// <summary>
/// Resolves the database file path following XDG conventions.
/// </summary>
public static class DatabasePathResolver
{
    /// <summary>
    /// Gets the path for the SQLite database file.
    /// Priority: XDG_DATA_HOME > Platform-specific > Local fallback
    /// </summary>
    public static string GetDatabasePath()
    {
        var dataDir = GetDataDirectory();
        Directory.CreateDirectory(dataDir);
        return Path.Combine(dataDir, "myblog.db");
    }

    /// <summary>
    /// Gets the data directory following platform conventions.
    /// </summary>
    public static string GetDataDirectory()
    {
        string baseDir;

        if (OperatingSystem.IsWindows())
        {
            baseDir = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData);
        }
        else if (OperatingSystem.IsMacOS())
        {
            baseDir = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
        }
        else
        {
            // Linux/Unix: Use XDG_DATA_HOME or fallback
            var xdgDataHome = Environment.GetEnvironmentVariable("XDG_DATA_HOME");
            baseDir = !string.IsNullOrEmpty(xdgDataHome)
                ? xdgDataHome
                : Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), ".local", "share");
        }

        // If we can't write to the preferred location, use local directory
        var preferredDir = Path.Combine(baseDir, "MyBlog");
        try
        {
            Directory.CreateDirectory(preferredDir);
            var testFile = Path.Combine(preferredDir, ".write-test");
            File.WriteAllText(testFile, "test");
            File.Delete(testFile);
            return preferredDir;
        }
        catch
        {
            // Fallback to local directory
            return Path.Combine(AppContext.BaseDirectory, "data");
        }
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Data/DatabaseSchemaUpdater.cs
SIZE: 2.24 KB
MODIFIED: 2026-01-20 09:25:48
================================================================================

using Microsoft.EntityFrameworkCore;

namespace MyBlog.Infrastructure.Data;

/// <summary>
/// Handles incremental schema updates for existing databases.
/// Since we're not using formal EF Core migrations, this class ensures
/// new tables and columns are added to existing databases on deployment.
/// </summary>
public static class DatabaseSchemaUpdater
{
    /// <summary>
    /// Applies any pending schema updates to the database.
    /// This is safe to run multiple times - it only creates objects that don't exist.
    /// </summary>
    public static async Task ApplyUpdatesAsync(BlogDbContext db)
    {
        var connection = db.Database.GetDbConnection();
        if (connection.State != System.Data.ConnectionState.Open)
        {
            await connection.OpenAsync();
        }

        // Check and create ImageDimensionCache table if it doesn't exist
        await EnsureImageDimensionCacheTableAsync(db);
    }

    private static async Task EnsureImageDimensionCacheTableAsync(BlogDbContext db)
    {
        var tableExists = await TableExistsAsync(db, "ImageDimensionCache");
        if (!tableExists)
        {
            // Create the ImageDimensionCache table using raw SQL
            // This matches the schema defined in BlogDbContext.OnModelCreating
            await db.Database.ExecuteSqlRawAsync("""
                CREATE TABLE IF NOT EXISTS "ImageDimensionCache" (
                    "Url" TEXT NOT NULL CONSTRAINT "PK_ImageDimensionCache" PRIMARY KEY,
                    "Width" INTEGER NOT NULL,
                    "Height" INTEGER NOT NULL,
                    "LastCheckedUtc" TEXT NOT NULL
                )
                """);
        }
    }

    private static async Task<bool> TableExistsAsync(BlogDbContext db, string tableName)
    {
        var connection = db.Database.GetDbConnection();
        using var command = connection.CreateCommand();
        command.CommandText = "SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name=@tableName";

        var parameter = command.CreateParameter();
        parameter.ParameterName = "@tableName";
        parameter.Value = tableName;
        command.Parameters.Add(parameter);

        var result = await command.ExecuteScalarAsync();
        return Convert.ToInt64(result) > 0;
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/MyBlog.Infrastructure.csproj
SIZE: .50 KB
MODIFIED: 2026-01-16 21:56:40
================================================================================

<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <RootNamespace>MyBlog.Infrastructure</RootNamespace>
  </PropertyGroup>
  
  <ItemGroup>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" />
    <PackageReference Include="Microsoft.AspNetCore.Identity" />
    <PackageReference Include="Microsoft.Extensions.Http" />
    <PackageReference Include="OpenTelemetry" />
  </ItemGroup>
  
  <ItemGroup>
    <ProjectReference Include="..\MyBlog.Core\MyBlog.Core.csproj" />
  </ItemGroup>
</Project>


================================================================================
FILE: src/MyBlog.Infrastructure/Repositories/ImageRepository.cs
SIZE: 1.61 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

using Microsoft.EntityFrameworkCore;
using MyBlog.Core.Interfaces;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;

namespace MyBlog.Infrastructure.Repositories;

/// <summary>
/// EF Core implementation of the image repository.
/// </summary>
public sealed class ImageRepository : IImageRepository
{
    private readonly BlogDbContext _context;

    /// <summary>Initializes a new instance of ImageRepository.</summary>
    public ImageRepository(BlogDbContext context)
    {
        _context = context;
    }

    /// <inheritdoc />
    public async Task<IReadOnlyList<Image>> GetAllAsync(CancellationToken cancellationToken = default)
    {
        return await _context.Images
            .AsNoTracking()
            .OrderByDescending(i => i.UploadedAtUtc)
            .ToListAsync(cancellationToken);
    }

    /// <inheritdoc />
    public async Task<Image?> GetByIdAsync(Guid id, CancellationToken cancellationToken = default)
    {
        return await _context.Images.FindAsync([id], cancellationToken);
    }

    /// <inheritdoc />
    public async Task<Image> CreateAsync(Image image, CancellationToken cancellationToken = default)
    {
        _context.Images.Add(image);
        await _context.SaveChangesAsync(cancellationToken);
        return image;
    }

    /// <inheritdoc />
    public async Task DeleteAsync(Guid id, CancellationToken cancellationToken = default)
    {
        var image = await _context.Images.FindAsync([id], cancellationToken);
        if (image is not null)
        {
            _context.Images.Remove(image);
            await _context.SaveChangesAsync(cancellationToken);
        }
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Repositories/PostRepository.cs
SIZE: 5.01 KB
MODIFIED: 2026-01-14 19:57:11
================================================================================

using Microsoft.EntityFrameworkCore;
using MyBlog.Core.Interfaces;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;

namespace MyBlog.Infrastructure.Repositories;

/// <summary>
/// EF Core implementation of the post repository.
/// </summary>
public sealed class PostRepository : IPostRepository
{
    private readonly BlogDbContext _context;

    /// <summary>Initializes a new instance of PostRepository.</summary>
    public PostRepository(BlogDbContext context)
    {
        _context = context;
    }

    /// <inheritdoc />
    public async Task<(IReadOnlyList<PostListItemDto> Posts, int TotalCount)> GetPublishedPostsAsync(
        int page, int pageSize, CancellationToken cancellationToken = default)
    {
        var query = _context.Posts
            .AsNoTracking()
            .Where(p => p.IsPublished)
            .OrderByDescending(p => p.PublishedAtUtc);

        var totalCount = await query.CountAsync(cancellationToken);

        var posts = await query
            .Skip((page - 1) * pageSize)
            .Take(pageSize)
            .Include(p => p.Author)
            .Select(p => new PostListItemDto(
                p.Id,
                p.Title,
                p.Slug,
                p.Summary,
                p.Author!.DisplayName,
                p.PublishedAtUtc,
                p.IsPublished))
            .ToListAsync(cancellationToken);

        return (posts, totalCount);
    }

    /// <inheritdoc />
    public async Task<IReadOnlyList<PostListItemDto>> GetAllPostsAsync(
        CancellationToken cancellationToken = default)
    {
        return await _context.Posts
            .AsNoTracking()
            .OrderByDescending(p => p.UpdatedAtUtc)
            .Include(p => p.Author)
            .Select(p => new PostListItemDto(
                p.Id,
                p.Title,
                p.Slug,
                p.Summary,
                p.Author!.DisplayName,
                p.PublishedAtUtc,
                p.IsPublished))
            .ToListAsync(cancellationToken);
    }

    /// <inheritdoc />
    public async Task<PostDetailDto?> GetBySlugAsync(
        string slug, CancellationToken cancellationToken = default)
    {
        return await _context.Posts
            .AsNoTracking()
            .Where(p => p.Slug == slug)
            .Include(p => p.Author)
            .Select(p => new PostDetailDto(
                p.Id,
                p.Title,
                p.Slug,
                p.Content,
                p.Summary,
                p.Author!.DisplayName,
                p.CreatedAtUtc,
                p.UpdatedAtUtc,
                p.PublishedAtUtc,
                p.IsPublished))
            .FirstOrDefaultAsync(cancellationToken);
    }

    /// <inheritdoc />
    public async Task<Post?> GetByIdAsync(Guid id, CancellationToken cancellationToken = default)
    {
        return await _context.Posts
            .Include(p => p.Author)
            .FirstOrDefaultAsync(p => p.Id == id, cancellationToken);
    }

    /// <inheritdoc />
    public async Task<Post> CreateAsync(Post post, CancellationToken cancellationToken = default)
    {
        _context.Posts.Add(post);
        await _context.SaveChangesAsync(cancellationToken);
        return post;
    }

    /// <inheritdoc />
    public async Task UpdateAsync(Post post, CancellationToken cancellationToken = default)
    {
        _context.Posts.Update(post);
        await _context.SaveChangesAsync(cancellationToken);
    }

    /// <inheritdoc />
    public async Task DeleteAsync(Guid id, CancellationToken cancellationToken = default)
    {
        var post = await _context.Posts.FindAsync([id], cancellationToken);
        if (post is not null)
        {
            _context.Posts.Remove(post);
            await _context.SaveChangesAsync(cancellationToken);
        }
    }

    /// <inheritdoc />
    public async Task<int> GetCountAsync(CancellationToken cancellationToken = default)
    {
        return await _context.Posts.CountAsync(cancellationToken);
    }

    /// <inheritdoc />
    public async Task<IReadOnlyList<PostListItemDto>> GetRecentPostsAsync(
        int count, CancellationToken cancellationToken = default)
    {
        return await _context.Posts
            .AsNoTracking()
            .OrderByDescending(p => p.UpdatedAtUtc)
            .Take(count)
            .Include(p => p.Author)
            .Select(p => new PostListItemDto(
                p.Id,
                p.Title,
                p.Slug,
                p.Summary,
                p.Author!.DisplayName,
                p.PublishedAtUtc,
                p.IsPublished))
            .ToListAsync(cancellationToken);
    }

    /// <inheritdoc />
    public async Task<bool> IsSlugTakenAsync(string slug, Guid? excludePostId = null, CancellationToken cancellationToken = default)
    {
        if (excludePostId.HasValue)
        {
            return await _context.Posts
                .AnyAsync(p => p.Slug == slug && p.Id != excludePostId.Value, cancellationToken);
        }

        return await _context.Posts
            .AnyAsync(p => p.Slug == slug, cancellationToken);
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Repositories/TelemetryLogRepository.cs
SIZE: 1.43 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

using Microsoft.EntityFrameworkCore;
using MyBlog.Core.Interfaces;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;

namespace MyBlog.Infrastructure.Repositories;

/// <summary>
/// EF Core implementation of the telemetry log repository.
/// </summary>
public sealed class TelemetryLogRepository : ITelemetryLogRepository
{
    private readonly BlogDbContext _context;

    /// <summary>Initializes a new instance of TelemetryLogRepository.</summary>
    public TelemetryLogRepository(BlogDbContext context)
    {
        _context = context;
    }

    /// <inheritdoc />
    public async Task WriteAsync(TelemetryLog log, CancellationToken cancellationToken = default)
    {
        _context.TelemetryLogs.Add(log);
        await _context.SaveChangesAsync(cancellationToken);
    }

    /// <inheritdoc />
    public async Task<int> DeleteOlderThanAsync(
        DateTime cutoffUtc, CancellationToken cancellationToken = default)
    {
        return await _context.TelemetryLogs
            .Where(l => l.TimestampUtc < cutoffUtc)
            .ExecuteDeleteAsync(cancellationToken);
    }

    /// <inheritdoc />
    public async Task<IReadOnlyList<TelemetryLog>> GetRecentAsync(
        int count, CancellationToken cancellationToken = default)
    {
        return await _context.TelemetryLogs
            .AsNoTracking()
            .OrderByDescending(l => l.TimestampUtc)
            .Take(count)
            .ToListAsync(cancellationToken);
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Repositories/UserRepository.cs
SIZE: 2.05 KB
MODIFIED: 2025-12-30 21:28:12
================================================================================

using Microsoft.EntityFrameworkCore;
using MyBlog.Core.Interfaces;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;

namespace MyBlog.Infrastructure.Repositories;

/// <summary>
/// SQLite implementation of the user repository.
/// </summary>
public sealed class UserRepository : IUserRepository
{
    private readonly BlogDbContext _context;

    public UserRepository(BlogDbContext context) => _context = context;

    /// <inheritdoc />
    public async Task<User?> GetByIdAsync(Guid id, CancellationToken cancellationToken = default)
        => await _context.Users.FirstOrDefaultAsync(u => u.Id == id, cancellationToken);

    /// <inheritdoc />
    public async Task<User?> GetByUsernameAsync(string username, CancellationToken cancellationToken = default)
        => await _context.Users.FirstOrDefaultAsync(
            u => u.Username.ToLower() == username.ToLower(), cancellationToken);

    /// <inheritdoc />
    public async Task<IReadOnlyList<User>> GetAllAsync(CancellationToken cancellationToken = default)
        => await _context.Users.OrderBy(u => u.Username).ToListAsync(cancellationToken);

    /// <inheritdoc />
    public async Task<bool> AnyUsersExistAsync(CancellationToken cancellationToken = default)
        => await _context.Users.AnyAsync(cancellationToken);

    /// <inheritdoc />
    public async Task CreateAsync(User user, CancellationToken cancellationToken = default)
    {
        _context.Users.Add(user);
        await _context.SaveChangesAsync(cancellationToken);
    }

    /// <inheritdoc />
    public async Task UpdateAsync(User user, CancellationToken cancellationToken = default)
    {
        _context.Users.Update(user);
        await _context.SaveChangesAsync(cancellationToken);
    }

    /// <inheritdoc />
    public async Task DeleteAsync(Guid id, CancellationToken cancellationToken = default)
    {
        var user = await _context.Users.FindAsync([id], cancellationToken);
        if (user is not null)
        {
            _context.Users.Remove(user);
            await _context.SaveChangesAsync(cancellationToken);
        }
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/ServiceCollectionExtensions.cs
SIZE: 2.32 KB
MODIFIED: 2026-01-20 09:14:25
================================================================================

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using MyBlog.Core.Interfaces;
using MyBlog.Core.Services;
using MyBlog.Infrastructure.Data;
using MyBlog.Infrastructure.Repositories;
using MyBlog.Infrastructure.Services;

namespace MyBlog.Infrastructure;

/// <summary>
/// Extension methods for registering infrastructure services.
/// </summary>
public static class ServiceCollectionExtensions
{
    /// <summary>
    /// Adds infrastructure services to the DI container.
    /// </summary>
    public static IServiceCollection AddInfrastructure(
        this IServiceCollection services,
        IConfiguration configuration)
    {
        // Database
        var connectionString = configuration.GetConnectionString("DefaultConnection");
        if (string.IsNullOrEmpty(connectionString) || connectionString == "Data Source=myblog.db")
        {
            // Use XDG-compliant path
            var dbPath = DatabasePathResolver.GetDatabasePath();
            connectionString = $"Data Source={dbPath}";
        }

        services.AddDbContext<BlogDbContext>(options =>
            options.UseSqlite(connectionString));

        // Repositories
        services.AddScoped<IPostRepository, PostRepository>();
        services.AddScoped<IUserRepository, UserRepository>();
        services.AddScoped<IImageRepository, ImageRepository>();
        services.AddScoped<ITelemetryLogRepository, TelemetryLogRepository>();

        // Services
        services.AddSingleton<IPasswordService, PasswordService>();
        services.AddSingleton<ISlugService, SlugService>();

        // MarkdownService is Scoped because it depends on Scoped IImageDimensionService
        services.AddScoped<IMarkdownService, MarkdownService>();
        services.AddScoped<IAuthService, AuthService>();

        services.AddSingleton<IReaderTrackingService, ReaderTrackingService>();

        // Image Dimension Service (With HttpClient for fetching image headers)
        services.AddHttpClient<IImageDimensionService, ImageDimensionService>();

        // Background services
        services.AddHostedService<TelemetryCleanupService>();
        // Cache Warmer - runs on startup to pre-fetch dimensions for existing images
        services.AddHostedService<ImageCacheWarmerService>();

        return services;
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Services/AuthService.cs
SIZE: 3.21 KB
MODIFIED: 2025-12-28 11:33:37
================================================================================

using Microsoft.Extensions.Configuration;
using MyBlog.Core.Interfaces;
using MyBlog.Core.Models;

namespace MyBlog.Infrastructure.Services;

/// <summary>
/// Authentication service implementation.
/// </summary>
public sealed class AuthService : IAuthService
{
    private readonly IUserRepository _userRepository;
    private readonly IPasswordService _passwordService;
    private readonly IConfiguration _configuration;

    /// <summary>Initializes a new instance of AuthService.</summary>
    public AuthService(
        IUserRepository userRepository,
        IPasswordService passwordService,
        IConfiguration configuration)
    {
        _userRepository = userRepository;
        _passwordService = passwordService;
        _configuration = configuration;
    }

    /// <inheritdoc />
    public async Task<User?> AuthenticateAsync(
        string username, string password, CancellationToken cancellationToken = default)
    {
        var user = await _userRepository.GetByUsernameAsync(username, cancellationToken);
        if (user is null)
        {
            return null;
        }

        return _passwordService.VerifyPassword(user.PasswordHash, password) ? user : null;
    }

    /// <inheritdoc />
    public async Task EnsureAdminUserAsync(CancellationToken cancellationToken = default)
    {
        if (await _userRepository.AnyUsersExistAsync(cancellationToken))
        {
            return;
        }

        var defaultPassword = Environment.GetEnvironmentVariable("MYBLOG_ADMIN_PASSWORD")
            ?? _configuration["Authentication:DefaultAdminPassword"]
            ?? "ChangeMe123!";

        var admin = new User
        {
            Id = Guid.NewGuid(),
            Username = "admin",
            PasswordHash = _passwordService.HashPassword(defaultPassword),
            Email = "admin@localhost",
            DisplayName = "Administrator",
            CreatedAtUtc = DateTime.UtcNow
        };

        await _userRepository.CreateAsync(admin, cancellationToken);
    }

    /// <inheritdoc />
    public async Task<bool> ChangePasswordAsync(
        Guid userId,
        string currentPassword,
        string newPassword,
        CancellationToken cancellationToken = default)
    {
        var user = await _userRepository.GetByIdAsync(userId, cancellationToken);
        if (user is null)
        {
            return false;
        }

        // Verify current password
        if (!_passwordService.VerifyPassword(user.PasswordHash, currentPassword))
        {
            return false;
        }

        // Update to new password
        user.PasswordHash = _passwordService.HashPassword(newPassword);
        await _userRepository.UpdateAsync(user, cancellationToken);

        return true;
    }

    /// <inheritdoc />
    public async Task ResetPasswordAsync(
        Guid userId,
        string newPassword,
        CancellationToken cancellationToken = default)
    {
        var user = await _userRepository.GetByIdAsync(userId, cancellationToken);
        if (user is null)
        {
            throw new InvalidOperationException($"User with ID {userId} not found.");
        }

        user.PasswordHash = _passwordService.HashPassword(newPassword);
        await _userRepository.UpdateAsync(user, cancellationToken);
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Services/ImageCacheWarmerService.cs
SIZE: 5.99 KB
MODIFIED: 2026-01-20 09:14:25
================================================================================

using System.Text.RegularExpressions;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using MyBlog.Core.Interfaces;
using MyBlog.Infrastructure.Data;

namespace MyBlog.Infrastructure.Services;

/// <summary>
/// Background service that warms the image dimension cache on startup.
/// Scans all posts for images and pre-fetches their dimensions.
/// This automates the fix for "past" images.
/// </summary>
public sealed class ImageCacheWarmerService : BackgroundService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ILogger<ImageCacheWarmerService> _logger;

    public ImageCacheWarmerService(
        IServiceScopeFactory scopeFactory,
        ILogger<ImageCacheWarmerService> logger)
    {
        _scopeFactory = scopeFactory;
        _logger = logger;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        // Give the app time to fully start up
        await Task.Delay(TimeSpan.FromSeconds(5), stoppingToken);

        _logger.LogInformation("Image Cache Warmer started. Scanning posts for uncached images...");

        try
        {
            using var scope = _scopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<BlogDbContext>();
            var dimService = scope.ServiceProvider.GetRequiredService<IImageDimensionService>();

            // Check if the ImageDimensionCache table exists
            if (!await TableExistsAsync(db, stoppingToken))
            {
                _logger.LogWarning("Image Cache Warmer: ImageDimensionCache table does not exist. " +
                    "Please apply database migrations. Skipping cache warming.");
                return;
            }

            // Get all posts
            var posts = await db.Posts
                .Select(p => p.Content)
                .ToListAsync(stoppingToken);

            var regex = new Regex(@"!\[([^\]]*)\]\(([^)]+)\)");
            var distinctUrls = new HashSet<string>();

            // 1. Extract all URLs from all posts
            foreach (var content in posts)
            {
                if (string.IsNullOrEmpty(content))
                {
                    continue;
                }

                var matches = regex.Matches(content);
                foreach (Match match in matches)
                {
                    distinctUrls.Add(match.Groups[2].Value);
                }
            }

            // 2. Filter out ones we already have
            HashSet<string> existingSet;
            try
            {
                var existingCache = await db.ImageDimensionCache
                    .Select(x => x.Url)
                    .ToListAsync(stoppingToken);
                existingSet = new HashSet<string>(existingCache);
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, "Image Cache Warmer: Could not read existing cache. Will attempt to cache all URLs.");
                existingSet = new HashSet<string>();
            }

            var missingUrls = distinctUrls.Where(u => !existingSet.Contains(u)).ToList();

            if (missingUrls.Count == 0)
            {
                _logger.LogInformation("Image Cache Warmer: All images are already cached.");
                return;
            }

            _logger.LogInformation("Image Cache Warmer: Found {Count} uncached images. Fetching dimensions...", missingUrls.Count);

            // 3. Process missing (in parallel but throttled)
            var successCount = 0;
            var failCount = 0;

            foreach (var url in missingUrls.TakeWhile(_ => !stoppingToken.IsCancellationRequested))
            {
                try
                {
                    // Calling GetDimensionsAsync triggers the logic to fetch and save to DB
                    var dimensions = await dimService.GetDimensionsAsync(url, stoppingToken);
                    if (dimensions.HasValue)
                    {
                        _logger.LogDebug("Cached dimensions for: {Url} ({Width}x{Height})",
                            url, dimensions.Value.Width, dimensions.Value.Height);
                        successCount++;
                    }
                    else
                    {
                        _logger.LogDebug("Could not resolve dimensions for: {Url}", url);
                        failCount++;
                    }
                }
                catch (Exception ex)
                {
                    _logger.LogDebug(ex, "Error warming cache for {Url}", url);
                    failCount++;
                }

                // Be gentle on remote servers
                await Task.Delay(100, stoppingToken);
            }

            _logger.LogInformation("Image Cache Warmer completed. Cached: {Success}, Failed: {Failed}",
                successCount, failCount);
        }
        catch (OperationCanceledException)
        {
            _logger.LogInformation("Image Cache Warmer was cancelled.");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error in Image Cache Warmer. This is non-fatal - the blog will continue to work without cached dimensions.");
        }
    }

    /// <summary>
    /// Checks if the ImageDimensionCache table exists in the database.
    /// </summary>
    private static async Task<bool> TableExistsAsync(BlogDbContext db, CancellationToken ct)
    {
        try
        {
            var connection = db.Database.GetDbConnection();
            if (connection.State != System.Data.ConnectionState.Open)
            {
                await connection.OpenAsync(ct);
            }

            using var command = connection.CreateCommand();
            command.CommandText = "SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='ImageDimensionCache'";
            var result = await command.ExecuteScalarAsync(ct);
            return Convert.ToInt64(result) > 0;
        }
        catch
        {
            return false;
        }
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Services/ImageDimensionService.cs
SIZE: 16.42 KB
MODIFIED: 2026-01-21 12:26:50
================================================================================

using System.Buffers.Binary;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using MyBlog.Core.Interfaces;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;

namespace MyBlog.Infrastructure.Services;

public sealed class ImageDimensionService : IImageDimensionService
{
    private readonly HttpClient _httpClient;
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ILogger<ImageDimensionService> _logger;

    public ImageDimensionService(
        HttpClient httpClient,
        IServiceScopeFactory scopeFactory,
        ILogger<ImageDimensionService> logger)
    {
        _httpClient = httpClient;
        _scopeFactory = scopeFactory;
        _logger = logger;
        _httpClient.Timeout = TimeSpan.FromSeconds(10);
        _httpClient.DefaultRequestHeaders.UserAgent.ParseAdd("MyBlog/1.0");
    }

    public async Task<(int Width, int Height)?> GetDimensionsAsync(string url, CancellationToken cancellationToken = default)
    {
        // 1. Check Cache (with graceful error handling for missing table)
        try
        {
            using var scope = _scopeFactory.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<BlogDbContext>();

            // Check if table exists before querying
            if (await TableExistsAsync(db, cancellationToken))
            {
                var cached = await db.ImageDimensionCache.FindAsync([url], cancellationToken);
                if (cached != null)
                {
                    return (cached.Width, cached.Height);
                }
            }
        }
        catch (Exception ex)
        {
            // Log but don't fail - cache is optional
            _logger.LogWarning(ex, "Failed to check image dimension cache for {Url}. Continuing without cache.", url);
        }

        // 2. Fetch if missing
        try
        {
            var dimensions = await FetchDimensionsFromNetworkAsync(url, cancellationToken);

            if (dimensions.HasValue)
            {
                // 3. Update Cache (with graceful error handling)
                try
                {
                    using var scope = _scopeFactory.CreateScope();
                    var db = scope.ServiceProvider.GetRequiredService<BlogDbContext>();

                    if (await TableExistsAsync(db, cancellationToken))
                    {
                        // Double check to prevent race conditions
                        if (!await db.ImageDimensionCache.AnyAsync(x => x.Url == url, cancellationToken))
                        {
                            db.ImageDimensionCache.Add(new ImageDimensionCache
                            {
                                Url = url,
                                Width = dimensions.Value.Width,
                                Height = dimensions.Value.Height,
                                LastCheckedUtc = DateTime.UtcNow
                            });
                            await db.SaveChangesAsync(cancellationToken);
                        }
                    }
                }
                catch (Exception ex)
                {
                    // Log but don't fail - caching is optional
                    _logger.LogWarning(ex, "Failed to cache image dimensions for {Url}. Dimensions were resolved but not cached.", url);
                }

                return dimensions;
            }
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Failed to resolve dimensions for {Url}", url);
        }

        return null;
    }

    /// <summary>
    /// Checks if the ImageDimensionCache table exists in the database.
    /// </summary>
    private static async Task<bool> TableExistsAsync(BlogDbContext db, CancellationToken ct)
    {
        try
        {
            // For SQLite, check sqlite_master
            var connection = db.Database.GetDbConnection();
            if (connection.State != System.Data.ConnectionState.Open)
            {
                await connection.OpenAsync(ct);
            }

            using var command = connection.CreateCommand();
            command.CommandText = "SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name='ImageDimensionCache'";
            var result = await command.ExecuteScalarAsync(ct);
            return Convert.ToInt64(result) > 0;
        }
        catch
        {
            return false;
        }
    }

    private async Task<(int Width, int Height)?> FetchDimensionsFromNetworkAsync(string url, CancellationToken ct)
    {
        using var response = await _httpClient.GetAsync(url, HttpCompletionOption.ResponseHeadersRead, ct);
        response.EnsureSuccessStatusCode();

        await using var stream = await response.Content.ReadAsStreamAsync(ct);

        // For JPEG, we need to scan through the file looking for SOF markers
        // For PNG/GIF/WebP, dimensions are at fixed offsets near the start
        // Read enough bytes to handle all formats' headers
        var buffer = new byte[32];
        var bytesRead = await ReadFullyAsync(stream, buffer, ct);

        if (bytesRead < 8)
        {
            return null;
        }

        if (IsPng(buffer))
        {
            // PNG: IHDR chunk starts at byte 8, width at 16-19, height at 20-23 (big-endian)
            if (bytesRead >= 24)
            {
                var width = BinaryPrimitives.ReadInt32BigEndian(buffer.AsSpan(16, 4));
                var height = BinaryPrimitives.ReadInt32BigEndian(buffer.AsSpan(20, 4));
                return (width, height);
            }
        }
        else if (IsGif(buffer))
        {
            // GIF: Width at bytes 6-7, Height at bytes 8-9 (little-endian)
            if (bytesRead >= 10)
            {
                var width = BinaryPrimitives.ReadInt16LittleEndian(buffer.AsSpan(6, 2));
                var height = BinaryPrimitives.ReadInt16LittleEndian(buffer.AsSpan(8, 2));
                return (width, height);
            }
        }
        else if (IsJpeg(buffer))
        {
            // JPEG requires scanning for SOF marker
            // We need to parse from the beginning, so use a buffered approach
            return await ParseJpegDimensionsAsync(stream, buffer, bytesRead, ct);
        }
        else if (IsWebP(buffer))
        {
            // WebP: Check for VP8, VP8L, or VP8X chunk
            return ParseWebPDimensions(buffer, bytesRead);
        }

        return null;
    }

    /// <summary>
    /// Reads exactly the requested number of bytes, or as many as available.
    /// Handles cases where ReadAsync returns fewer bytes than requested.
    /// </summary>
    private static async Task<int> ReadFullyAsync(Stream stream, byte[] buffer, CancellationToken ct)
    {
        var totalRead = 0;
        while (totalRead < buffer.Length)
        {
            var read = await stream.ReadAsync(buffer.AsMemory(totalRead, buffer.Length - totalRead), ct);
            if (read == 0)
            {
                break; // End of stream
            }
            totalRead += read;
        }
        return totalRead;
    }

    private static bool IsPng(ReadOnlySpan<byte> buffer) =>
        buffer.Length >= 8 &&
        buffer[0] == 0x89 && buffer[1] == 0x50 && buffer[2] == 0x4E && buffer[3] == 0x47 &&
        buffer[4] == 0x0D && buffer[5] == 0x0A && buffer[6] == 0x1A && buffer[7] == 0x0A;

    private static bool IsGif(ReadOnlySpan<byte> buffer) =>
        buffer.Length >= 6 &&
        buffer[0] == 0x47 && buffer[1] == 0x49 && buffer[2] == 0x46 && // GIF
        buffer[3] == 0x38 && (buffer[4] == 0x39 || buffer[4] == 0x37) && buffer[5] == 0x61; // 89a or 87a

    private static bool IsJpeg(ReadOnlySpan<byte> buffer) =>
        buffer.Length >= 2 &&
        buffer[0] == 0xFF && buffer[1] == 0xD8;

    private static bool IsWebP(ReadOnlySpan<byte> buffer) =>
        buffer.Length >= 12 &&
        buffer[0] == 0x52 && buffer[1] == 0x49 && buffer[2] == 0x46 && buffer[3] == 0x46 && // RIFF
        buffer[8] == 0x57 && buffer[9] == 0x45 && buffer[10] == 0x42 && buffer[11] == 0x50; // WEBP

    /// <summary>
    /// Parses JPEG dimensions by scanning for SOF (Start of Frame) markers.
    /// JPEG structure: Starts with FFD8, then segments each starting with FF XX (marker).
    /// SOF markers (FFC0-FFCF, excluding FFC4, FFC8, FFCC) contain dimensions.
    /// </summary>
    private async Task<(int Width, int Height)?> ParseJpegDimensionsAsync(
        Stream stream, byte[] initialBuffer, int initialBytesRead, CancellationToken ct)
    {
        // Create a combined stream that first reads from initialBuffer, then continues from network stream
        // We already have 'initialBytesRead' bytes in 'initialBuffer', stream is positioned after those bytes

        // Start parsing from byte 2 (after FF D8 SOI marker)
        var position = 2;

        // Helper to read bytes, first from initialBuffer then from stream
        async Task<int> ReadByteAsync()
        {
            if (position < initialBytesRead)
            {
                return initialBuffer[position++];
            }

            var b = new byte[1];
            var read = await stream.ReadAsync(b, 0, 1, ct);
            if (read == 0)
            {
                return -1; // EOF
            }
            position++;
            return b[0];
        }

        async Task<byte[]?> ReadBytesAsync(int count)
        {
            var result = new byte[count];
            var resultPos = 0;

            // First, read from initialBuffer
            while (resultPos < count && position < initialBytesRead)
            {
                result[resultPos++] = initialBuffer[position++];
            }

            // Then read remaining from stream
            if (resultPos < count)
            {
                var remaining = count - resultPos;
                var read = await ReadFullyAsync(stream, result.AsMemory(resultPos, remaining), ct);
                if (read < remaining)
                {
                    return null; // EOF before we got all bytes
                }
                position += read;
            }

            return result;
        }

        // Scan for SOF marker
        while (true)
        {
            // Read marker (FF XX)
            var ff = await ReadByteAsync();
            if (ff == -1)
            {
                return null; // EOF
            }

            if (ff != 0xFF)
            {
                // Not a marker, keep scanning
                continue;
            }

            // Skip any padding FF bytes
            int marker;
            do
            {
                marker = await ReadByteAsync();
                if (marker == -1)
                {
                    return null; // EOF
                }
            } while (marker == 0xFF);

            // Check for SOF markers (C0-CF except C4, C8, CC)
            if (marker >= 0xC0 && marker <= 0xCF && marker != 0xC4 && marker != 0xC8 && marker != 0xCC)
            {
                // Found SOF marker! Read length (2) + precision (1) + height (2) + width (2)
                var sofData = await ReadBytesAsync(7);
                if (sofData == null)
                {
                    return null;
                }

                var height = BinaryPrimitives.ReadInt16BigEndian(sofData.AsSpan(3, 2));
                var width = BinaryPrimitives.ReadInt16BigEndian(sofData.AsSpan(5, 2));
                return (width, height);
            }

            // EOI (End of Image) - no dimensions found
            if (marker == 0xD9)
            {
                return null;
            }

            // SOS (Start of Scan) - image data follows, no more metadata
            if (marker == 0xDA)
            {
                return null;
            }

            // RST markers (D0-D7) and standalone markers - no length field
            if ((marker >= 0xD0 && marker <= 0xD7) || marker == 0x00 || marker == 0x01)
            {
                continue;
            }

            // Other markers have a length field - skip the segment
            var lengthBytes = await ReadBytesAsync(2);
            if (lengthBytes == null)
            {
                return null;
            }

            var length = BinaryPrimitives.ReadInt16BigEndian(lengthBytes) - 2; // Length includes itself
            if (length > 0)
            {
                // Skip segment content
                if (position < initialBytesRead)
                {
                    // Skip what we can from initialBuffer
                    var skipFromBuffer = Math.Min(length, initialBytesRead - position);
                    position += skipFromBuffer;
                    length -= skipFromBuffer;
                }

                // Skip remaining from stream
                if (length > 0)
                {
                    var skipBuffer = new byte[Math.Min(length, 8192)];
                    var remaining = length;
                    while (remaining > 0)
                    {
                        var toRead = Math.Min(remaining, skipBuffer.Length);
                        var read = await ReadFullyAsync(stream, skipBuffer.AsMemory(0, toRead), ct);
                        if (read == 0)
                        {
                            return null; // EOF
                        }
                        remaining -= read;
                        position += read;
                    }
                }
            }
        }
    }

    private static async Task<int> ReadFullyAsync(Stream stream, Memory<byte> buffer, CancellationToken ct)
    {
        var totalRead = 0;
        while (totalRead < buffer.Length)
        {
            var read = await stream.ReadAsync(buffer[totalRead..], ct);
            if (read == 0)
            {
                break;
            }
            totalRead += read;
        }
        return totalRead;
    }

    /// <summary>
    /// Parses WebP dimensions from the initial buffer.
    /// WebP has three formats: VP8 (lossy), VP8L (lossless), VP8X (extended).
    /// </summary>
    private static (int Width, int Height)? ParseWebPDimensions(byte[] buffer, int bytesRead)
    {
        if (bytesRead < 30)
        {
            return null;
        }

        // Check chunk type at offset 12
        var chunkType = System.Text.Encoding.ASCII.GetString(buffer, 12, 4);

        switch (chunkType)
        {
            case "VP8 ":
                {
                    // Lossy WebP
                    // VP8 bitstream starts at offset 20
                    // Frame tag at bytes 20-22, then dimensions
                    // Signature bytes: 9D 01 2A
                    if (bytesRead >= 30 && buffer[23] == 0x9D && buffer[24] == 0x01 && buffer[25] == 0x2A)
                    {
                        // Width at 26-27 (little-endian, 14 bits)
                        // Height at 28-29 (little-endian, 14 bits)
                        var width = (buffer[26] | (buffer[27] << 8)) & 0x3FFF;
                        var height = (buffer[28] | (buffer[29] << 8)) & 0x3FFF;
                        return (width, height);
                    }
                    break;
                }
            case "VP8L":
                {
                    // Lossless WebP
                    // Signature byte at offset 20: 0x2F
                    if (bytesRead >= 25 && buffer[20] == 0x2F)
                    {
                        // Dimensions encoded in bytes 21-24
                        // Width: 14 bits starting at bit 0
                        // Height: 14 bits starting at bit 14
                        var b0 = buffer[21];
                        var b1 = buffer[22];
                        var b2 = buffer[23];
                        var b3 = buffer[24];

                        var width = ((b0 | (b1 << 8)) & 0x3FFF) + 1;
                        var height = ((((b1 >> 6) | (b2 << 2) | (b3 << 10))) & 0x3FFF) + 1;
                        return (width, height);
                    }
                    break;
                }
            case "VP8X":
                {
                    // Extended WebP
                    // Canvas size at offset 24-29
                    if (bytesRead >= 30)
                    {
                        // Width at 24-26 (24-bit little-endian) + 1
                        // Height at 27-29 (24-bit little-endian) + 1
                        var width = (buffer[24] | (buffer[25] << 8) | (buffer[26] << 16)) + 1;
                        var height = (buffer[27] | (buffer[28] << 8) | (buffer[29] << 16)) + 1;
                        return (width, height);
                    }
                    break;
                }
        }

        return null;
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Services/PasswordService.cs
SIZE: .82 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

using Microsoft.AspNetCore.Identity;
using MyBlog.Core.Interfaces;
using MyBlog.Core.Models;

namespace MyBlog.Infrastructure.Services;

/// <summary>
/// Password hashing service using ASP.NET Core Identity's PasswordHasher.
/// </summary>
public sealed class PasswordService : IPasswordService
{
    private readonly PasswordHasher<User> _hasher = new();

    /// <inheritdoc />
    public string HashPassword(string password)
    {
        return _hasher.HashPassword(null!, password);
    }

    /// <inheritdoc />
    public bool VerifyPassword(string hashedPassword, string providedPassword)
    {
        var result = _hasher.VerifyHashedPassword(null!, hashedPassword, providedPassword);
        return result == PasswordVerificationResult.Success ||
               result == PasswordVerificationResult.SuccessRehashNeeded;
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Services/ReaderTrackingService.cs
SIZE: 1.57 KB
MODIFIED: 2026-01-16 20:30:23
================================================================================

using System.Collections.Concurrent;
using MyBlog.Core.Interfaces;

namespace MyBlog.Infrastructure.Services;

public class ReaderTrackingService : IReaderTrackingService
{
    // Maps Slug -> Count of active readers
    private readonly ConcurrentDictionary<string, int> _slugCounts = new();

    // Maps ConnectionId -> Slug (Reverse lookup to handle disconnects)
    private readonly ConcurrentDictionary<string, string> _connectionMap = new();

    public int JoinPost(string slug, string connectionId)
    {
        // Map the connection to the slug
        _connectionMap.AddOrUpdate(connectionId, slug, (_, _) => slug);

        // Increment the count for this slug
        return _slugCounts.AddOrUpdate(slug, 1, (_, count) => count + 1);
    }

    public int LeavePost(string slug, string connectionId)
    {
        // Remove the connection mapping
        _connectionMap.TryRemove(connectionId, out _);

        // Decrement the count
        return _slugCounts.AddOrUpdate(slug, 0, (_, count) => count > 0 ? count - 1 : 0);
    }

    public (string? Slug, int NewCount) Disconnect(string connectionId)
    {
        // Find which slug this connection was watching
        if (_connectionMap.TryRemove(connectionId, out var slug))
        {
            // Decrement that slug's count
            var newCount = _slugCounts.AddOrUpdate(slug, 0, (_, count) => count > 0 ? count - 1 : 0);
            return (slug, newCount);
        }

        return (null, 0);
    }

    public int GetReaderCount(string slug)
    {
        return _slugCounts.TryGetValue(slug, out var count) ? count : 0;
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Services/TelemetryCleanupService.cs
SIZE: 2.11 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using MyBlog.Core.Interfaces;

namespace MyBlog.Infrastructure.Services;

/// <summary>
/// Background service that cleans up old telemetry logs.
/// </summary>
public sealed class TelemetryCleanupService : BackgroundService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ILogger<TelemetryCleanupService> _logger;
    private readonly int _retentionDays;

    /// <summary>Initializes a new instance of TelemetryCleanupService.</summary>
    public TelemetryCleanupService(
        IServiceScopeFactory scopeFactory,
        IConfiguration configuration,
        ILogger<TelemetryCleanupService> logger)
    {
        _scopeFactory = scopeFactory;
        _logger = logger;
        _retentionDays = configuration.GetValue("Telemetry:RetentionDays", 30);
    }

    /// <inheritdoc />
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        // Run cleanup immediately on startup
        await CleanupAsync(stoppingToken);

        // Then run daily
        using var timer = new PeriodicTimer(TimeSpan.FromDays(1));
        while (await timer.WaitForNextTickAsync(stoppingToken))
        {
            await CleanupAsync(stoppingToken);
        }
    }

    private async Task CleanupAsync(CancellationToken cancellationToken)
    {
        try
        {
            using var scope = _scopeFactory.CreateScope();
            var repository = scope.ServiceProvider.GetRequiredService<ITelemetryLogRepository>();

            var cutoff = DateTime.UtcNow.AddDays(-_retentionDays);
            var deleted = await repository.DeleteOlderThanAsync(cutoff, cancellationToken);

            if (deleted > 0)
            {
                _logger.LogInformation(
                    "Telemetry cleanup: deleted {Count} logs older than {Days} days",
                    deleted, _retentionDays);
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error during telemetry cleanup");
        }
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Telemetry/DatabaseLogExporter.cs
SIZE: 2.11 KB
MODIFIED: 2025-12-28 08:55:11
================================================================================

using System.Text.Json;
using Microsoft.Extensions.DependencyInjection;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;
using OpenTelemetry;
using OpenTelemetry.Logs;

namespace MyBlog.Infrastructure.Telemetry;

/// <summary>
/// OpenTelemetry log exporter that writes to SQLite database.
/// </summary>
public sealed class DatabaseLogExporter : BaseExporter<LogRecord>
{
    private readonly IServiceScopeFactory _scopeFactory;

    /// <summary>Initializes a new instance of DatabaseLogExporter.</summary>
    public DatabaseLogExporter(IServiceScopeFactory scopeFactory)
    {
        _scopeFactory = scopeFactory;
    }

    /// <inheritdoc />
    public override ExportResult Export(in Batch<LogRecord> batch)
    {
        try
        {
            using var scope = _scopeFactory.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<BlogDbContext>();

            foreach (var record in batch)
            {
                var log = new TelemetryLog
                {
                    TimestampUtc = record.Timestamp.ToUniversalTime(),
                    Level = record.LogLevel.ToString(),
                    Category = record.CategoryName ?? "Unknown",
                    Message = record.FormattedMessage ?? record.Body ?? "",
                    Exception = record.Exception?.ToString(),
                    TraceId = record.TraceId.ToString(),
                    SpanId = record.SpanId.ToString(),
                    Properties = SerializeAttributes(record)
                };

                context.TelemetryLogs.Add(log);
            }

            context.SaveChanges();
            return ExportResult.Success;
        }
        catch
        {
            return ExportResult.Failure;
        }
    }

    private static string? SerializeAttributes(LogRecord record)
    {
        if (record.Attributes is null)
        {
            return null;
        }

        var dict = new Dictionary<string, object?>();
        foreach (var attr in record.Attributes)
        {
            dict[attr.Key] = attr.Value;
        }

        return dict.Count > 0 ? JsonSerializer.Serialize(dict) : null;
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Telemetry/FileLogExporter.cs
SIZE: 3.61 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

using System.Text;
using System.Text.Json;
using OpenTelemetry;
using OpenTelemetry.Logs;

namespace MyBlog.Infrastructure.Telemetry;

/// <summary>
/// OpenTelemetry log exporter that writes to JSON files.
/// </summary>
public sealed class FileLogExporter : BaseExporter<LogRecord>
{
    private readonly string _directory;
    private readonly string _runId;
    private readonly long _maxFileSizeBytes;
    private readonly object _lock = new();
    private StreamWriter? _writer;
    private long _currentFileSize;
    private int _fileNumber;
    private bool _isFirstRecord = true;
    private readonly JsonSerializerOptions _jsonOptions = new() { WriteIndented = true };

    /// <summary>Initializes a new instance of FileLogExporter.</summary>
    public FileLogExporter(string directory, long maxFileSizeBytes = 25 * 1024 * 1024)
    {
        _directory = directory;
        _maxFileSizeBytes = maxFileSizeBytes;
        _runId = DateTime.UtcNow.ToString("yyyyMMdd_HHmmss");
        Directory.CreateDirectory(_directory);
    }

    /// <inheritdoc />
    public override ExportResult Export(in Batch<LogRecord> batch)
    {
        try
        {
            lock (_lock)
            {
                EnsureWriter();

                foreach (var record in batch)
                {
                    var obj = new
                    {
                        Timestamp = record.Timestamp.ToString("O"),
                        Level = record.LogLevel.ToString(),
                        Category = record.CategoryName,
                        Message = record.FormattedMessage ?? record.Body,
                        TraceId = record.TraceId.ToString(),
                        SpanId = record.SpanId.ToString(),
                        Exception = record.Exception?.ToString()
                    };

                    var json = JsonSerializer.Serialize(obj, _jsonOptions);
                    var bytes = Encoding.UTF8.GetByteCount(json) + 2;

                    if (_currentFileSize + bytes > _maxFileSizeBytes)
                    {
                        RotateFile();
                    }

                    if (!_isFirstRecord)
                    {
                        _writer!.WriteLine(",");
                    }
                    else
                    {
                        _isFirstRecord = false;
                    }

                    _writer!.Write(json);
                    _currentFileSize += bytes;
                }

                _writer!.Flush();
            }

            return ExportResult.Success;
        }
        catch
        {
            return ExportResult.Failure;
        }
    }

    private void EnsureWriter()
    {
        if (_writer is null)
        {
            OpenNewFile();
        }
    }

    private void OpenNewFile()
    {
        var fileName = _fileNumber == 0
            ? $"logs_{_runId}.json"
            : $"logs_{_runId}_{_fileNumber:D3}.json";

        _writer = new StreamWriter(Path.Combine(_directory, fileName), false, Encoding.UTF8);
        _writer.WriteLine("[");
        _currentFileSize = 2;
        _isFirstRecord = true;
    }

    private void RotateFile()
    {
        CloseWriter();
        _fileNumber++;
        OpenNewFile();
    }

    private void CloseWriter()
    {
        if (_writer is not null)
        {
            _writer.WriteLine();
            _writer.WriteLine("]");
            _writer.Flush();
            _writer.Dispose();
            _writer = null;
        }
    }

    /// <inheritdoc />
    protected override bool OnShutdown(int timeoutMilliseconds)
    {
        lock (_lock)
        {
            CloseWriter();
        }
        return true;
    }
}


================================================================================
FILE: src/MyBlog.Infrastructure/Telemetry/TelemetryPathResolver.cs
SIZE: 2.00 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

namespace MyBlog.Infrastructure.Telemetry;

/// <summary>
/// Resolves the telemetry directory path following XDG conventions.
/// </summary>
public static class TelemetryPathResolver
{
    /// <summary>
    /// Attempts to get a writable telemetry directory.
    /// Returns null if no writable directory can be found.
    /// </summary>
    public static string? GetTelemetryDirectory()
    {
        // Try XDG/platform-specific location first
        var preferredDir = GetPreferredDirectory();
        if (TryCreateAndVerify(preferredDir))
        {
            return preferredDir;
        }

        // Fallback to local directory
        var localDir = Path.Combine(AppContext.BaseDirectory, "telemetry");
        if (TryCreateAndVerify(localDir))
        {
            return localDir;
        }

        // No writable directory available
        return null;
    }

    private static string GetPreferredDirectory()
    {
        string baseDir;

        if (OperatingSystem.IsWindows())
        {
            baseDir = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData);
        }
        else if (OperatingSystem.IsMacOS())
        {
            baseDir = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
        }
        else
        {
            var xdgDataHome = Environment.GetEnvironmentVariable("XDG_DATA_HOME");
            baseDir = !string.IsNullOrEmpty(xdgDataHome)
                ? xdgDataHome
                : Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), ".local", "share");
        }

        return Path.Combine(baseDir, "MyBlog", "telemetry");
    }

    private static bool TryCreateAndVerify(string path)
    {
        try
        {
            Directory.CreateDirectory(path);
            var testFile = Path.Combine(path, $".write-test-{Guid.NewGuid()}");
            File.WriteAllText(testFile, "test");
            File.Delete(testFile);
            return true;
        }
        catch
        {
            return false;
        }
    }
}


================================================================================
FILE: src/MyBlog.slnx
SIZE: .29 KB
MODIFIED: 2026-01-26 09:56:51
================================================================================

<Solution>
  <Project Path="MyBlog.Core/MyBlog.Core.csproj" />
  <Project Path="MyBlog.Infrastructure/MyBlog.Infrastructure.csproj" />
  <Project Path="MyBlog.Web/MyBlog.Web.csproj" />
  <Project Path="MyBlog.Tests/MyBlog.Tests.csproj" />
  <Project Path="MyBlog.E2E/MyBlog.E2E.csproj" />
</Solution>


================================================================================
FILE: src/MyBlog.Tests/Integration/AuthServiceLongPasswordTests.cs
SIZE: 11.18 KB
MODIFIED: 2026-01-11 12:56:49
================================================================================

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;
using MyBlog.Infrastructure.Repositories;
using MyBlog.Infrastructure.Services;
using Xunit;

namespace MyBlog.Tests.Integration;

/// <summary>
/// Tests for long password support and account lockout behavior.
/// Uses in-memory SQLite for cross-platform compatibility (Windows/Linux/macOS).
/// </summary>
public sealed class AuthServiceLongPasswordTests : IAsyncDisposable
{
    private readonly BlogDbContext _context;
    private readonly AuthService _sut;
    private readonly PasswordService _passwordService;

    public AuthServiceLongPasswordTests()
    {
        // Use in-memory SQLite - works on all platforms without file locking issues
        var options = new DbContextOptionsBuilder<BlogDbContext>()
            .UseSqlite("Data Source=:memory:")
            .Options;

        _context = new BlogDbContext(options);
        _context.Database.OpenConnection();
        _context.Database.EnsureCreated();

        _passwordService = new PasswordService();
        var userRepository = new UserRepository(_context);
        var configuration = new ConfigurationBuilder()
            .AddInMemoryCollection(new Dictionary<string, string?>
            {
                ["Authentication:DefaultAdminPassword"] = "TestAdmin123!"
            })
            .Build();

        _sut = new AuthService(userRepository, _passwordService, configuration);
    }

    public async ValueTask DisposeAsync()
    {
        await _context.DisposeAsync();
    }

    // =========================================================================
    // Long Password Tests (128+ characters)
    // =========================================================================

    [Fact]
    public async Task AuthenticateAsync_With128CharacterPassword_Succeeds()
    {
        var ct = TestContext.Current.CancellationToken;
        var longPassword = new string('a', 128);

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "long-pass-user",
            PasswordHash = _passwordService.HashPassword(longPassword),
            Email = "longpass@example.com",
            DisplayName = "Long Password User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        var result = await _sut.AuthenticateAsync("long-pass-user", longPassword, ct);

        Assert.NotNull(result);
        Assert.Equal("long-pass-user", result.Username);
    }

    [Fact]
    public async Task AuthenticateAsync_With256CharacterPassword_Succeeds()
    {
        var ct = TestContext.Current.CancellationToken;
        var longPassword = new string('x', 256);

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "very-long-pass-user",
            PasswordHash = _passwordService.HashPassword(longPassword),
            Email = "very-long@example.com",
            DisplayName = "Very Long Password User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        var result = await _sut.AuthenticateAsync("very-long-pass-user", longPassword, ct);

        Assert.NotNull(result);
        Assert.Equal("very-long-pass-user", result.Username);
    }

    [Fact]
    public async Task AuthenticateAsync_With512CharacterPassword_Succeeds()
    {
        var ct = TestContext.Current.CancellationToken;
        var longPassword = new string('P', 512);

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "extralong-pass-user",
            PasswordHash = _passwordService.HashPassword(longPassword),
            Email = "extralong@example.com",
            DisplayName = "Extra Long Password User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        var result = await _sut.AuthenticateAsync("extralong-pass-user", longPassword, ct);

        Assert.NotNull(result);
        Assert.Equal("extralong-pass-user", result.Username);
    }

    [Fact]
    public async Task ChangePasswordAsync_With128CharacterNewPassword_Succeeds()
    {
        var ct = TestContext.Current.CancellationToken;
        var originalPassword = "ShortPass123!";
        var newLongPassword = new string('N', 128);

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "change-pass-long-user",
            PasswordHash = _passwordService.HashPassword(originalPassword),
            Email = "changelong@example.com",
            DisplayName = "Change Long Password User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        var result = await _sut.ChangePasswordAsync(user.Id, originalPassword, newLongPassword, ct);

        Assert.True(result);

        // Verify new password works
        var authenticated = await _sut.AuthenticateAsync("change-pass-long-user", newLongPassword, ct);
        Assert.NotNull(authenticated);
    }

    [Fact]
    public async Task AuthenticateAsync_WithComplexLongPassword_Succeeds()
    {
        var ct = TestContext.Current.CancellationToken;
        // Mix of characters, 200 chars long
        var complexPassword = string.Concat(
            new string('A', 50),
            new string('1', 50),
            new string('!', 50),
            new string('z', 50)
        );

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "complex-pass-user",
            PasswordHash = _passwordService.HashPassword(complexPassword),
            Email = "complex@example.com",
            DisplayName = "Complex Password User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        var result = await _sut.AuthenticateAsync("complex-pass-user", complexPassword, ct);

        Assert.NotNull(result);
    }

    // =========================================================================
    // No Account Lockout Tests
    // =========================================================================

    [Fact]
    public async Task AuthenticateAsync_After100FailedAttempts_StillAllowsLogin()
    {
        var ct = TestContext.Current.CancellationToken;
        var correctPassword = "CorrectPassword123!";

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "no-lockout-user",
            PasswordHash = _passwordService.HashPassword(correctPassword),
            Email = "no-lockout@example.com",
            DisplayName = "No Lockout User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        // Attempt 100 failed logins
        for (var i = 0; i < 100; i++)
        {
            var failedResult = await _sut.AuthenticateAsync("no-lockout-user", "WrongPassword", ct);
            Assert.Null(failedResult);
        }

        // User should still be able to log in with correct password
        var successResult = await _sut.AuthenticateAsync("no-lockout-user", correctPassword, ct);
        Assert.NotNull(successResult);
        Assert.Equal("no-lockout-user", successResult.Username);
    }

    [Fact]
    public async Task AuthenticateAsync_After1000FailedAttempts_StillAllowsLogin()
    {
        var ct = TestContext.Current.CancellationToken;
        var correctPassword = "CorrectPassword123!";

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "no-lockout1000user",
            PasswordHash = _passwordService.HashPassword(correctPassword),
            Email = "no-lockout1000@example.com",
            DisplayName = "No Lockout 1000 User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        // Attempt 1000 failed logins
        for (var i = 0; i < 1000; i++)
        {
            var failedResult = await _sut.AuthenticateAsync("no-lockout1000user", $"WrongPassword{i}", ct);
            Assert.Null(failedResult);
        }

        // User should still be able to log in with correct password
        var successResult = await _sut.AuthenticateAsync("no-lockout1000user", correctPassword, ct);
        Assert.NotNull(successResult);
        Assert.Equal("no-lockout1000user", successResult.Username);
    }

    [Fact]
    public async Task ChangePasswordAsync_AfterManyFailedAttempts_StillWorks()
    {
        var ct = TestContext.Current.CancellationToken;
        var originalPassword = "OriginalPass123!";
        var newPassword = "NewPassword456!";

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "change-pass-no-lockout",
            PasswordHash = _passwordService.HashPassword(originalPassword),
            Email = "change-pass-no-lockout@example.com",
            DisplayName = "Change Password No Lockout",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        // Attempt 50 failed password changes
        for (var i = 0; i < 50; i++)
        {
            var failedResult = await _sut.ChangePasswordAsync(user.Id, "WrongOldPassword", "NewPass", ct);
            Assert.False(failedResult);
        }

        // Should still be able to change password with correct current password
        var successResult = await _sut.ChangePasswordAsync(user.Id, originalPassword, newPassword, ct);
        Assert.True(successResult);

        // Verify new password works
        var authenticated = await _sut.AuthenticateAsync("change-pass-no-lockout", newPassword, ct);
        Assert.NotNull(authenticated);
    }

    [Fact]
    public async Task AuthenticateAsync_InterleavedFailuresAndSuccesses_NeverLocks()
    {
        var ct = TestContext.Current.CancellationToken;
        var correctPassword = "CorrectPassword123!";

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "interleaved-user",
            PasswordHash = _passwordService.HashPassword(correctPassword),
            Email = "interleaved@example.com",
            DisplayName = "Interleaved User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        // Interleave failed and successful attempts
        for (var i = 0; i < 20; i++)
        {
            // 5 failed attempts
            for (var j = 0; j < 5; j++)
            {
                var failedResult = await _sut.AuthenticateAsync("interleaved-user", "WrongPassword", ct);
                Assert.Null(failedResult);
            }

            // 1 successful attempt
            var successResult = await _sut.AuthenticateAsync("interleaved-user", correctPassword, ct);
            Assert.NotNull(successResult);
        }

        // Final successful login after 100 failed attempts total
        var finalResult = await _sut.AuthenticateAsync("interleaved-user", correctPassword, ct);
        Assert.NotNull(finalResult);
        Assert.Equal("interleaved-user", finalResult.Username);
    }
}


================================================================================
FILE: src/MyBlog.Tests/Integration/AuthServiceTests.cs
SIZE: 3.85 KB
MODIFIED: 2025-12-28 09:39:37
================================================================================

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;
using MyBlog.Infrastructure.Repositories;
using MyBlog.Infrastructure.Services;
using Xunit;

namespace MyBlog.Tests.Integration;

public class AuthServiceTests : IAsyncDisposable
{
    private readonly BlogDbContext _context;
    private readonly AuthService _sut;
    private readonly PasswordService _passwordService = new();

    public AuthServiceTests()
    {
        var options = new DbContextOptionsBuilder<BlogDbContext>()
            .UseSqlite("Data Source=:memory:")
            .Options;

        _context = new BlogDbContext(options);
        _context.Database.OpenConnection();
        _context.Database.EnsureCreated();

        var userRepository = new UserRepository(_context);
        var configuration = new ConfigurationBuilder()
            .AddInMemoryCollection(new Dictionary<string, string?>
            {
                ["Authentication:DefaultAdminPassword"] = "TestAdmin123!"
            })
            .Build();

        _sut = new AuthService(userRepository, _passwordService, configuration);
    }

    public async ValueTask DisposeAsync()
    {
        await _context.DisposeAsync();
    }

    [Fact]
    public async Task AuthenticateAsync_WithValidCredentials_ReturnsUser()
    {
        var ct = TestContext.Current.CancellationToken;
        var password = "TestPassword123";
        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "testuser",
            PasswordHash = _passwordService.HashPassword(password),
            Email = "test@example.com",
            DisplayName = "Test User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        var result = await _sut.AuthenticateAsync("testuser", password, ct);

        Assert.NotNull(result);
        Assert.Equal("testuser", result.Username);
    }

    [Fact]
    public async Task AuthenticateAsync_WithInvalidPassword_ReturnsNull()
    {
        var ct = TestContext.Current.CancellationToken;
        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "testuser",
            PasswordHash = _passwordService.HashPassword("CorrectPassword"),
            Email = "test@example.com",
            DisplayName = "Test User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        var result = await _sut.AuthenticateAsync("testuser", "WrongPassword", ct);

        Assert.Null(result);
    }

    [Fact]
    public async Task AuthenticateAsync_WithNonExistentUser_ReturnsNull()
    {
        var ct = TestContext.Current.CancellationToken;
        var result = await _sut.AuthenticateAsync("nonexistent", "password", ct);
        Assert.Null(result);
    }

    [Fact]
    public async Task EnsureAdminUserAsync_WhenNoUsersExist_CreatesAdmin()
    {
        var ct = TestContext.Current.CancellationToken;
        await _sut.EnsureAdminUserAsync(ct);

        var admin = await _context.Users.FirstOrDefaultAsync(u => u.Username == "admin", ct);
        Assert.NotNull(admin);
    }

    [Fact]
    public async Task EnsureAdminUserAsync_WhenUsersExist_DoesNotCreateAnother()
    {
        var ct = TestContext.Current.CancellationToken;
        var existingUser = new User
        {
            Id = Guid.NewGuid(),
            Username = "existing",
            PasswordHash = "hash",
            Email = "existing@example.com",
            DisplayName = "Existing",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(existingUser);
        await _context.SaveChangesAsync(ct);

        await _sut.EnsureAdminUserAsync(ct);

        var userCount = await _context.Users.CountAsync(ct);
        Assert.Equal(1, userCount);
    }
}


================================================================================
FILE: src/MyBlog.Tests/Integration/PasswordChangeTests.cs
SIZE: 6.10 KB
MODIFIED: 2025-12-28 11:34:32
================================================================================

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;
using MyBlog.Infrastructure.Repositories;
using MyBlog.Infrastructure.Services;
using Xunit;

namespace MyBlog.Tests.Integration;

public class PasswordChangeTests : IAsyncDisposable
{
    private readonly BlogDbContext _context;
    private readonly AuthService _sut;
    private readonly PasswordService _passwordService = new();
    private readonly UserRepository _userRepository;

    public PasswordChangeTests()
    {
        var options = new DbContextOptionsBuilder<BlogDbContext>()
            .UseSqlite("Data Source=:memory:")
            .Options;

        _context = new BlogDbContext(options);
        _context.Database.OpenConnection();
        _context.Database.EnsureCreated();

        _userRepository = new UserRepository(_context);
        var configuration = new ConfigurationBuilder()
            .AddInMemoryCollection(new Dictionary<string, string?>
            {
                ["Authentication:DefaultAdminPassword"] = "TestAdmin123!"
            })
            .Build();

        _sut = new AuthService(_userRepository, _passwordService, configuration);
    }

    public async ValueTask DisposeAsync()
    {
        await _context.DisposeAsync();
    }

    [Fact]
    public async Task ChangePasswordAsync_WithCorrectCurrentPassword_ReturnsTrue()
    {
        var ct = TestContext.Current.CancellationToken;
        var originalPassword = "OriginalPass123!";
        var newPassword = "NewPassword456!";

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "testuser",
            PasswordHash = _passwordService.HashPassword(originalPassword),
            Email = "test@example.com",
            DisplayName = "Test User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        var result = await _sut.ChangePasswordAsync(user.Id, originalPassword, newPassword, ct);

        Assert.True(result);
    }

    [Fact]
    public async Task ChangePasswordAsync_WithCorrectPassword_AllowsLoginWithNewPassword()
    {
        var ct = TestContext.Current.CancellationToken;
        var originalPassword = "OriginalPass123!";
        var newPassword = "NewPassword456!";

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "testuser",
            PasswordHash = _passwordService.HashPassword(originalPassword),
            Email = "test@example.com",
            DisplayName = "Test User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        await _sut.ChangePasswordAsync(user.Id, originalPassword, newPassword, ct);

        // Should authenticate with new password
        var authenticated = await _sut.AuthenticateAsync("testuser", newPassword, ct);
        Assert.NotNull(authenticated);

        // Should NOT authenticate with old password
        var oldAuth = await _sut.AuthenticateAsync("testuser", originalPassword, ct);
        Assert.Null(oldAuth);
    }

    [Fact]
    public async Task ChangePasswordAsync_WithWrongCurrentPassword_ReturnsFalse()
    {
        var ct = TestContext.Current.CancellationToken;
        var correctPassword = "CorrectPass123!";
        var wrongPassword = "WrongPassword!";

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "testuser",
            PasswordHash = _passwordService.HashPassword(correctPassword),
            Email = "test@example.com",
            DisplayName = "Test User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        var result = await _sut.ChangePasswordAsync(user.Id, wrongPassword, "NewPass123!", ct);

        Assert.False(result);
    }

    [Fact]
    public async Task ChangePasswordAsync_WithWrongPassword_DoesNotChangePassword()
    {
        var ct = TestContext.Current.CancellationToken;
        var correctPassword = "CorrectPass123!";

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "testuser",
            PasswordHash = _passwordService.HashPassword(correctPassword),
            Email = "test@example.com",
            DisplayName = "Test User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        await _sut.ChangePasswordAsync(user.Id, "WrongPassword!", "NewPass123!", ct);

        // Original password should still work
        var authenticated = await _sut.AuthenticateAsync("testuser", correctPassword, ct);
        Assert.NotNull(authenticated);
    }

    [Fact]
    public async Task ChangePasswordAsync_WithNonExistentUser_ReturnsFalse()
    {
        var ct = TestContext.Current.CancellationToken;
        var result = await _sut.ChangePasswordAsync(Guid.NewGuid(), "any", "password", ct);
        Assert.False(result);
    }

    [Fact]
    public async Task ResetPasswordAsync_SetsNewPassword()
    {
        var ct = TestContext.Current.CancellationToken;
        var originalPassword = "OriginalPass123!";
        var newPassword = "ResetPassword789!";

        var user = new User
        {
            Id = Guid.NewGuid(),
            Username = "testuser",
            PasswordHash = _passwordService.HashPassword(originalPassword),
            Email = "test@example.com",
            DisplayName = "Test User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(user);
        await _context.SaveChangesAsync(ct);

        await _sut.ResetPasswordAsync(user.Id, newPassword, ct);

        var authenticated = await _sut.AuthenticateAsync("testuser", newPassword, ct);
        Assert.NotNull(authenticated);
    }

    [Fact]
    public async Task ResetPasswordAsync_WithNonExistentUser_ThrowsException()
    {
        var ct = TestContext.Current.CancellationToken;
        await Assert.ThrowsAsync<InvalidOperationException>(
            () => _sut.ResetPasswordAsync(Guid.NewGuid(), "password", ct));
    }
}


================================================================================
FILE: src/MyBlog.Tests/Integration/PostRepositoryTests.cs
SIZE: 4.88 KB
MODIFIED: 2025-12-28 09:39:37
================================================================================

using Microsoft.EntityFrameworkCore;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;
using MyBlog.Infrastructure.Repositories;
using Xunit;

namespace MyBlog.Tests.Integration;

public class PostRepositoryTests : IAsyncDisposable
{
    private readonly BlogDbContext _context;
    private readonly PostRepository _sut;
    private readonly User _testUser;

    public PostRepositoryTests()
    {
        var options = new DbContextOptionsBuilder<BlogDbContext>()
            .UseSqlite("Data Source=:memory:")
            .Options;

        _context = new BlogDbContext(options);
        _context.Database.OpenConnection();
        _context.Database.EnsureCreated();

        _testUser = new User
        {
            Id = Guid.NewGuid(),
            Username = "testuser",
            PasswordHash = "hash",
            Email = "test@example.com",
            DisplayName = "Test User",
            CreatedAtUtc = DateTime.UtcNow
        };
        _context.Users.Add(_testUser);
        _context.SaveChanges();

        _sut = new PostRepository(_context);
    }

    public async ValueTask DisposeAsync()
    {
        await _context.DisposeAsync();
    }

    [Fact]
    public async Task CreateAsync_AddsPostToDatabase()
    {
        var ct = TestContext.Current.CancellationToken;
        var post = CreateTestPost("Test Post");

        var result = await _sut.CreateAsync(post, ct);

        Assert.NotEqual(Guid.Empty, result.Id);
        var saved = await _context.Posts.FindAsync([result.Id], ct);
        Assert.NotNull(saved);
        Assert.Equal("Test Post", saved.Title);
    }

    [Fact]
    public async Task GetByIdAsync_WithExistingId_ReturnsPost()
    {
        var ct = TestContext.Current.CancellationToken;
        var post = CreateTestPost("Test Post");
        await _sut.CreateAsync(post, ct);

        var result = await _sut.GetByIdAsync(post.Id, ct);

        Assert.NotNull(result);
        Assert.Equal("Test Post", result.Title);
    }

    [Fact]
    public async Task GetByIdAsync_WithNonExistingId_ReturnsNull()
    {
        var ct = TestContext.Current.CancellationToken;
        var result = await _sut.GetByIdAsync(Guid.NewGuid(), ct);
        Assert.Null(result);
    }

    [Fact]
    public async Task GetBySlugAsync_WithExistingSlug_ReturnsPost()
    {
        var ct = TestContext.Current.CancellationToken;
        var post = CreateTestPost("Test Post", "test-post");
        await _sut.CreateAsync(post, ct);

        var result = await _sut.GetBySlugAsync("test-post", ct);

        Assert.NotNull(result);
        Assert.Equal("Test Post", result.Title);
    }

    [Fact]
    public async Task GetPublishedPostsAsync_ReturnsOnlyPublishedPosts()
    {
        var ct = TestContext.Current.CancellationToken;
        await _sut.CreateAsync(CreateTestPost("Published", isPublished: true), ct);
        await _sut.CreateAsync(CreateTestPost("Draft", isPublished: false), ct);

        var (posts, totalCount) = await _sut.GetPublishedPostsAsync(1, 10, ct);

        Assert.Single(posts);
        Assert.Equal("Published", posts.First().Title);
        Assert.Equal(1, totalCount);
    }

    [Fact]
    public async Task UpdateAsync_ModifiesPost()
    {
        var ct = TestContext.Current.CancellationToken;
        var post = CreateTestPost("Original Title");
        await _sut.CreateAsync(post, ct);

        post.Title = "Updated Title";
        await _sut.UpdateAsync(post, ct);

        var result = await _sut.GetByIdAsync(post.Id, ct);
        Assert.Equal("Updated Title", result!.Title);
    }

    [Fact]
    public async Task DeleteAsync_RemovesPost()
    {
        var ct = TestContext.Current.CancellationToken;
        var post = CreateTestPost("To Delete");
        await _sut.CreateAsync(post, ct);

        await _sut.DeleteAsync(post.Id, ct);

        var result = await _sut.GetByIdAsync(post.Id, ct);
        Assert.Null(result);
    }

    [Fact]
    public async Task GetPublishedPostsAsync_ReturnsCorrectCount()
    {
        var ct = TestContext.Current.CancellationToken;
        await _sut.CreateAsync(CreateTestPost("Post 1", isPublished: true), ct);
        await _sut.CreateAsync(CreateTestPost("Post 2", isPublished: true), ct);
        await _sut.CreateAsync(CreateTestPost("Draft", isPublished: false), ct);

        var (_, totalCount) = await _sut.GetPublishedPostsAsync(1, 10, ct);

        Assert.Equal(2, totalCount);
    }

    private Post CreateTestPost(string title, string? slug = null, bool isPublished = true)
    {
        return new Post
        {
            Id = Guid.NewGuid(),
            Title = title,
            Slug = slug ?? title.ToLower().Replace(" ", "-"),
            Content = "Test content",
            Summary = "Test summary",
            AuthorId = _testUser.Id,
            CreatedAtUtc = DateTime.UtcNow,
            UpdatedAtUtc = DateTime.UtcNow,
            IsPublished = isPublished,
            PublishedAtUtc = isPublished ? DateTime.UtcNow : null
        };
    }
}


================================================================================
FILE: src/MyBlog.Tests/Integration/TelemetryCleanupTests.cs
SIZE: 2.68 KB
MODIFIED: 2025-12-28 09:27:55
================================================================================

using Microsoft.EntityFrameworkCore;
using MyBlog.Core.Models;
using MyBlog.Infrastructure.Data;
using MyBlog.Infrastructure.Repositories;
using Xunit;

namespace MyBlog.Tests.Integration;

public class TelemetryCleanupTests : IAsyncDisposable
{
    private readonly BlogDbContext _context;
    private readonly TelemetryLogRepository _sut;

    public TelemetryCleanupTests()
    {
        var options = new DbContextOptionsBuilder<BlogDbContext>()
            .UseSqlite("Data Source=:memory:")
            .Options;

        _context = new BlogDbContext(options);
        _context.Database.OpenConnection();
        _context.Database.EnsureCreated();

        _sut = new TelemetryLogRepository(_context);
    }

    public async ValueTask DisposeAsync()
    {
        await _context.DisposeAsync();
    }

    [Fact]
    public async Task DeleteOlderThanAsync_RemovesOldLogs()
    {
        var ct = TestContext.Current.CancellationToken;

        // Add old logs
        var oldLog = new TelemetryLog
        {
            TimestampUtc = DateTime.UtcNow.AddDays(-60),
            Level = "Information",
            Category = "Test",
            Message = "Old log"
        };
        _context.TelemetryLogs.Add(oldLog);

        // Add recent log
        var recentLog = new TelemetryLog
        {
            TimestampUtc = DateTime.UtcNow.AddDays(-5),
            Level = "Information",
            Category = "Test",
            Message = "Recent log"
        };
        _context.TelemetryLogs.Add(recentLog);
        await _context.SaveChangesAsync(ct);

        var cutoff = DateTime.UtcNow.AddDays(-30);
        var deleted = await _sut.DeleteOlderThanAsync(cutoff, ct);

        Assert.Equal(1, deleted);
        var remaining = await _context.TelemetryLogs.CountAsync(ct);
        Assert.Equal(1, remaining);
    }

    [Fact]
    public async Task DeleteOlderThanAsync_WithNoOldLogs_ReturnsZero()
    {
        var ct = TestContext.Current.CancellationToken;

        var recentLog = new TelemetryLog
        {
            TimestampUtc = DateTime.UtcNow.AddDays(-5),
            Level = "Information",
            Category = "Test",
            Message = "Recent log"
        };
        _context.TelemetryLogs.Add(recentLog);
        await _context.SaveChangesAsync(ct);

        var cutoff = DateTime.UtcNow.AddDays(-30);
        var deleted = await _sut.DeleteOlderThanAsync(cutoff, ct);

        Assert.Equal(0, deleted);
    }

    [Fact]
    public async Task DeleteOlderThanAsync_WithEmptyTable_ReturnsZero()
    {
        var ct = TestContext.Current.CancellationToken;
        var cutoff = DateTime.UtcNow.AddDays(-30);
        var deleted = await _sut.DeleteOlderThanAsync(cutoff, ct);
        Assert.Equal(0, deleted);
    }
}


================================================================================
FILE: src/MyBlog.Tests/MyBlog.Tests.csproj
SIZE: .69 KB
MODIFIED: 2026-01-11 12:52:12
================================================================================

<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <RootNamespace>MyBlog.Tests</RootNamespace>
    <IsTestProject>true</IsTestProject>
  </PropertyGroup>
  
  <ItemGroup>
    <PackageReference Include="Microsoft.NET.Test.Sdk" />
    <PackageReference Include="xunit.v3" />
    <PackageReference Include="Microsoft.Testing.Extensions.TrxReport" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" />
  </ItemGroup>
  
  <ItemGroup>
    <ProjectReference Include="..\MyBlog.Core\MyBlog.Core.csproj" />
    <ProjectReference Include="..\MyBlog.Web\MyBlog.Web.csproj" />
    <ProjectReference Include="..\MyBlog.Infrastructure\MyBlog.Infrastructure.csproj" />
  </ItemGroup>
</Project>


================================================================================
FILE: src/MyBlog.Tests/Unit/LoginRateLimitMiddlewareTests.cs
SIZE: 6.87 KB
MODIFIED: 2026-01-26 20:33:12
================================================================================

using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging.Abstractions;
using MyBlog.Web.Middleware;
using Xunit;

namespace MyBlog.Tests.Unit;

/// <summary>
/// Tests for LoginRateLimitMiddleware.
/// Verifies that the middleware slows down but never blocks requests.
/// </summary>
public sealed class LoginRateLimitMiddlewareTests : IDisposable
{
    private readonly LoginRateLimitMiddleware _sut;
    private int _nextCallCount;
    private readonly List<TimeSpan> _recordedDelays = [];

    public LoginRateLimitMiddlewareTests()
    {
        // Clear any state from previous tests
        LoginRateLimitMiddleware.ClearAttempts();
        _nextCallCount = 0;
        RequestDelegate next = _ =>
        {
            _nextCallCount++;
            return Task.CompletedTask;
        };

        // Use a no-op delay function that just records the delay
        // This makes tests fast while still verifying delay logic
        Task NoOpDelay(TimeSpan delay, CancellationToken ct)
        {
            _recordedDelays.Add(delay);
            return Task.CompletedTask;
        }

        _sut = new LoginRateLimitMiddleware(
            next,
            NullLogger<LoginRateLimitMiddleware>.Instance,
            NoOpDelay);
    }

    public void Dispose()
    {
        // Clean up after each test
        LoginRateLimitMiddleware.ClearAttempts();
    }

    [Fact]
    public async Task InvokeAsync_NonLoginRequest_PassesThroughImmediately()
    {
        var context = CreateHttpContext("/api/posts", "GET");
        await _sut.InvokeAsync(context);

        Assert.Equal(1, _nextCallCount);
        Assert.Empty(_recordedDelays);
    }

    [Fact]
    public async Task InvokeAsync_GetLoginRequest_PassesThroughImmediately()
    {
        var context = CreateHttpContext("/login", "GET");
        await _sut.InvokeAsync(context);

        Assert.Equal(1, _nextCallCount);
        Assert.Empty(_recordedDelays);
    }

    [Fact]
    public async Task InvokeAsync_FirstFiveAttempts_NoDelay()
    {
        var uniqueIp = $"192.168.{Random.Shared.Next(1, 255)}.{Random.Shared.Next(1, 255)}";
        // First 5 attempts should have no delay
        for (var i = 0; i < 5; i++)
        {
            // Note: Updated path to match new login endpoint
            var context = CreateHttpContext("/account/login", "POST", uniqueIp);
            await _sut.InvokeAsync(context);
        }

        Assert.Equal(5, _nextCallCount);
        Assert.Empty(_recordedDelays);
        // No delays for first 5 attempts
    }

    [Fact]
    public async Task InvokeAsync_SixthAttempt_HasOneSecondDelay()
    {
        var uniqueIp = $"192.168.{Random.Shared.Next(1, 255)}.{Random.Shared.Next(1, 255)}";
        // Make 6 attempts
        for (var i = 0; i < 6; i++)
        {
            var context = CreateHttpContext("/account/login", "POST", uniqueIp);
            await _sut.InvokeAsync(context);
        }

        Assert.Equal(6, _nextCallCount);
        Assert.Single(_recordedDelays);
        Assert.Equal(TimeSpan.FromSeconds(1), _recordedDelays[0]);
    }

    [Fact]
    public async Task InvokeAsync_ProgressiveDelays_IncreaseExponentially()
    {
        var uniqueIp = $"192.168.{Random.Shared.Next(1, 255)}.{Random.Shared.Next(1, 255)}";
        // Make 10 attempts: 5 no-delay + 5 with delays
        for (var i = 0; i < 10; i++)
        {
            var context = CreateHttpContext("/account/login", "POST", uniqueIp);
            await _sut.InvokeAsync(context);
        }

        Assert.Equal(10, _nextCallCount);
        Assert.Equal(5, _recordedDelays.Count);
        // Delays start after attempt 5

        // Verify exponential progression: 1s, 2s, 4s, 8s, 16s
        Assert.Equal(TimeSpan.FromSeconds(1), _recordedDelays[0]);
        Assert.Equal(TimeSpan.FromSeconds(2), _recordedDelays[1]);
        Assert.Equal(TimeSpan.FromSeconds(4), _recordedDelays[2]);
        Assert.Equal(TimeSpan.FromSeconds(8), _recordedDelays[3]);
        Assert.Equal(TimeSpan.FromSeconds(16), _recordedDelays[4]);
    }

    [Fact]
    public async Task InvokeAsync_DelayCappedAt30Seconds()
    {
        var uniqueIp = $"192.168.{Random.Shared.Next(1, 255)}.{Random.Shared.Next(1, 255)}";
        // Make enough attempts to hit the cap (5 no-delay + enough to exceed 30s)
        // After attempt 5: 1, 2, 4, 8, 16, 30, 30, 30...
        for (var i = 0; i < 15; i++)
        {
            var context = CreateHttpContext("/account/login", "POST", uniqueIp);
            await _sut.InvokeAsync(context);
        }

        Assert.Equal(15, _nextCallCount);
        // Verify cap at 30 seconds (attempts 11+ should all be 30s)
        var maxDelays = _recordedDelays.Where(d => d == TimeSpan.FromSeconds(30)).ToList();
        Assert.True(maxDelays.Count >= 4, "Should have multiple 30-second delays");
        Assert.True(_recordedDelays.All(d => d <= TimeSpan.FromSeconds(30)), "No delay should exceed 30 seconds");
    }

    [Fact]
    public async Task InvokeAsync_AfterManyAttempts_NeverBlocks()
    {
        var uniqueIp = $"10.0.{Random.Shared.Next(1, 255)}.{Random.Shared.Next(1, 255)}";
        // Make 100 attempts - should all pass through (with delays, but never blocked)
        for (var i = 0; i < 100; i++)
        {
            var context = CreateHttpContext("/account/login", "POST", uniqueIp);
            await _sut.InvokeAsync(context);
        }

        // Key assertion: ALL requests passed through, none were blocked
        Assert.Equal(100, _nextCallCount);
    }

    [Fact]
    public async Task InvokeAsync_DifferentIPs_IndependentTracking()
    {
        var ip1 = $"10.1.{Random.Shared.Next(1, 255)}.{Random.Shared.Next(1, 255)}";
        var ip2 = $"10.2.{Random.Shared.Next(1, 255)}.{Random.Shared.Next(1, 255)}";

        // 6 attempts from IP1 (should trigger delay on 6th)
        for (var i = 0; i < 6; i++)
        {
            var context = CreateHttpContext("/account/login", "POST", ip1);
            await _sut.InvokeAsync(context);
        }

        var ip1Delays = _recordedDelays.Count;
        Assert.Equal(1, ip1Delays);
        // One delay after 5th attempt

        // First attempt from IP2 should have no delay
        var context2 = CreateHttpContext("/account/login", "POST", ip2);
        await _sut.InvokeAsync(context2);

        // No new delays should have been added for IP2
        Assert.Equal(ip1Delays, _recordedDelays.Count);
    }

    [Fact]
    public void CalculateDelay_UnknownIP_ReturnsZero()
    {
        var delay = LoginRateLimitMiddleware.CalculateDelay("unknown-ip-never-seen");
        Assert.Equal(TimeSpan.Zero, delay);
    }

    private static DefaultHttpContext CreateHttpContext(string path, string method, string? remoteIp = null)
    {
        var context = new DefaultHttpContext();
        context.Request.Path = path;
        context.Request.Method = method;

        if (remoteIp != null)
        {
            context.Connection.RemoteIpAddress = System.Net.IPAddress.Parse(remoteIp);
        }

        return context;
    }
}


================================================================================
FILE: src/MyBlog.Tests/Unit/MarkdownServiceTests.cs
SIZE: 7.09 KB
MODIFIED: 2026-01-20 09:14:25
================================================================================

using System.Threading;
using System.Threading.Tasks;
using MyBlog.Core.Interfaces;
using MyBlog.Core.Services;
using Xunit;

namespace MyBlog.Tests.Unit;

/// <summary>
/// Mock implementation for testing that simulates dimension lookup.
/// </summary>
internal sealed class MockImageDimensionService : IImageDimensionService
{
    public Task<(int Width, int Height)?> GetDimensionsAsync(string url, CancellationToken cancellationToken = default)
    {
        // Return dimensions for URLs containing "image.png"
        if (url.Contains("image.png"))
        {
            return Task.FromResult<(int, int)?>((100, 200));
        }

        // Return null for unknown images
        return Task.FromResult<(int, int)?>(null);
    }
}

/// <summary>
/// Mock implementation that throws exceptions to test error handling.
/// </summary>
internal sealed class ThrowingImageDimensionService : IImageDimensionService
{
    public Task<(int Width, int Height)?> GetDimensionsAsync(string url, CancellationToken cancellationToken = default)
    {
        throw new InvalidOperationException("Simulated database error");
    }
}

public class MarkdownServiceTests
{
    private readonly MarkdownService _sut = new(new MockImageDimensionService());

    // Helper to normalize newlines for cross-platform comparison
    private static string NormalizeNewlines(string s) => s.Replace("\r\n", "\n");

    [Fact]
    public async Task ToHtml_WithHeading1_ReturnsH1Tag()
    {
        var result = await _sut.ToHtmlAsync("# Hello");
        Assert.Contains("<h1>Hello</h1>", result);
    }

    [Fact]
    public async Task ToHtml_WithHeading2_ReturnsH2Tag()
    {
        var result = await _sut.ToHtmlAsync("## Hello");
        Assert.Contains("<h2>Hello</h2>", result);
    }

    [Fact]
    public async Task ToHtml_WithHeading6_ReturnsH6Tag()
    {
        var result = await _sut.ToHtmlAsync("###### Hello");
        Assert.Contains("<h6>Hello</h6>", result);
    }

    [Fact]
    public async Task ToHtml_WithBoldText_ReturnsStrongTag()
    {
        var result = await _sut.ToHtmlAsync("This is **bold** text");
        Assert.Contains("<strong>bold</strong>", result);
    }

    [Fact]
    public async Task ToHtml_WithItalicText_ReturnsEmTag()
    {
        var result = await _sut.ToHtmlAsync("This is *italic* text");
        Assert.Contains("<em>italic</em>", result);
    }

    [Fact]
    public async Task ToHtml_WithLink_ReturnsAnchorTag()
    {
        var result = await _sut.ToHtmlAsync("Check [this link](https://example.com)");
        Assert.Contains("<p>Check <a href=\"https://example.com\">this link</a></p>", result);
    }

    [Fact]
    public async Task ToHtml_WithImage_InjectsDimensions_IfResolvable()
    {
        // Mock returns 100x200 for 'image.png'
        var result = NormalizeNewlines(await _sut.ToHtmlAsync("![alt text](https://example.com/image.png)"));
        Assert.Contains("<p><img src=\"https://example.com/image.png\" alt=\"alt text\" width=\"100\" height=\"200\" /></p>\n", result);
    }

    [Fact]
    public async Task ToHtml_WithImage_InjectsParagraphs_IfResolvable()
    {
        // Mock returns 100x200 for 'image.png'
        var result = NormalizeNewlines(await _sut.ToHtmlAsync("Check out this photo of when I was younger. ![high school graduation photo](https://example.com/image.png)"));
        Assert.Contains("<p>Check out this photo of when I was younger. <img src=\"https://example.com/image.png\" alt=\"high school graduation photo\" width=\"100\" height=\"200\" /></p>\n", result);
    }

    [Fact]
    public async Task ToHtml_WithImage_NoDimensions_IfUnresolvable()
    {
        var result = NormalizeNewlines(await _sut.ToHtmlAsync("![alt text](https://example.com/unknown.jpg)"));
        Assert.Contains("<p><img src=\"https://example.com/unknown.jpg\" alt=\"alt text\" /></p>\n", result);
    }

    [Fact]
    public async Task ToHtml_WithImage_WhenServiceThrows_StillRendersImage()
    {
        // Use the throwing service to test error handling
        var throwingService = new ThrowingImageDimensionService();
        var sut = new MarkdownService(throwingService);

        // Should NOT throw - should gracefully degrade to image without dimensions
        var result = NormalizeNewlines(await sut.ToHtmlAsync("![alt text](https://example.com/image.png)"));
        Assert.Contains("<p><img src=\"https://example.com/image.png\" alt=\"alt text\" /></p>\n", result);
    }

    [Fact]
    public async Task ToHtml_WithInlineCode_ReturnsCodeTag()
    {
        var result = await _sut.ToHtmlAsync("Use `code` here");
        Assert.Contains("<code>code</code>", result);
    }

    [Fact]
    public async Task ToHtml_WithCodeBlock_ReturnsPreCodeTags()
    {
        var markdown = "```\nvar x = 1;\n```";
        var result = await _sut.ToHtmlAsync(markdown);
        Assert.Contains("<pre><code>", result);
        Assert.Contains("var x = 1;", result);
        Assert.Contains("</code></pre>", result);
    }

    [Fact]
    public async Task ToHtml_WithBlockquote_ReturnsBlockquoteTag()
    {
        var result = await _sut.ToHtmlAsync("> This is a quote");
        Assert.Contains("<blockquote><p>This is a quote</p></blockquote>", result);
    }

    [Fact]
    public async Task ToHtml_WithUnorderedList_ReturnsUlLiTags()
    {
        var markdown = "- Item 1\n- Item 2";
        var result = await _sut.ToHtmlAsync(markdown);
        Assert.Contains("<ul>", result);
        Assert.Contains("<li>Item 1</li>", result);
        Assert.Contains("<li>Item 2</li>", result);
        Assert.Contains("</ul>", result);
    }

    [Fact]
    public async Task ToHtml_WithHorizontalRule_ReturnsHrTag()
    {
        var result = await _sut.ToHtmlAsync("---");
        Assert.Contains("<hr />", result);
    }

    [Fact]
    public async Task ToHtml_WithOrderedList_ReturnsOlLiTags()
    {
        var markdown = "1. First\n2. Second";
        var result = await _sut.ToHtmlAsync(markdown);
        Assert.Contains("<ol>", result);
        Assert.Contains("<li>First</li>", result);
        Assert.Contains("<li>Second</li>", result);
        Assert.Contains("</ol>", result);
    }

    [Fact]
    public async Task ToHtml_WithEmptyString_ReturnsEmpty()
    {
        var result = await _sut.ToHtmlAsync("");
        Assert.Equal(string.Empty, result);
    }

    [Fact]
    public async Task ToHtml_WithNull_ReturnsEmpty()
    {
        var result = await _sut.ToHtmlAsync(null!);
        Assert.Equal(string.Empty, result);
    }

    [Fact]
    public async Task ToHtml_WithWhitespace_ReturnsEmpty()
    {
        var result = await _sut.ToHtmlAsync("   ");
        Assert.Equal(string.Empty, result);
    }

    [Fact]
    public async Task ToHtml_WithMultipleImages_ProcessesAll()
    {
        var markdown = "![img1](https://example.com/image.png) and ![img2](https://example.com/other.jpg)";
        var result = NormalizeNewlines(await _sut.ToHtmlAsync(markdown));

        // First image should have dimensions (contains 'image.png')
        Assert.Contains("width=\"100\" height=\"200\"", result);
        // Second image should not have dimensions (doesn't match mock)
        Assert.Contains("<img src=\"https://example.com/other.jpg\" alt=\"img2\" />", result);
    }
}


================================================================================
FILE: src/MyBlog.Tests/Unit/PasswordServiceTests.cs
SIZE: 1.30 KB
MODIFIED: 2025-12-28 09:05:13
================================================================================

using MyBlog.Infrastructure.Services;
using Xunit;

namespace MyBlog.Tests.Unit;

public class PasswordServiceTests
{
    private readonly PasswordService _sut = new();

    [Fact]
    public void HashPassword_ReturnsNonEmptyHash()
    {
        var hash = _sut.HashPassword("TestPassword123");
        Assert.False(string.IsNullOrEmpty(hash));
    }

    [Fact]
    public void HashPassword_ReturnsDifferentHashForSamePassword()
    {
        var hash1 = _sut.HashPassword("TestPassword123");
        var hash2 = _sut.HashPassword("TestPassword123");
        Assert.NotEqual(hash1, hash2);
    }

    [Fact]
    public void VerifyPassword_WithCorrectPassword_ReturnsTrue()
    {
        var password = "TestPassword123";
        var hash = _sut.HashPassword(password);

        var result = _sut.VerifyPassword(hash, password);

        Assert.True(result);
    }

    [Fact]
    public void VerifyPassword_WithWrongPassword_ReturnsFalse()
    {
        var hash = _sut.HashPassword("TestPassword123");

        var result = _sut.VerifyPassword(hash, "WrongPassword");

        Assert.False(result);
    }

    [Fact]
    public void VerifyPassword_WithEmptyPassword_ReturnsFalse()
    {
        var hash = _sut.HashPassword("TestPassword123");

        var result = _sut.VerifyPassword(hash, "");

        Assert.False(result);
    }
}


================================================================================
FILE: src/MyBlog.Tests/Unit/SlugServiceTests.cs
SIZE: 2.18 KB
MODIFIED: 2026-01-19 19:52:01
================================================================================

using MyBlog.Core.Services;
using Xunit;

namespace MyBlog.Tests.Unit;

public class SlugServiceTests
{
    private readonly SlugService _sut = new();

    [Fact]
    public void GenerateSlug_WithSimpleTitle_ReturnsLowercaseWithHyphens()
    {
        var result = _sut.GenerateSlugOrUuid("Hello World");
        Assert.Equal("hello-world", result);
    }

    [Fact]
    public void GenerateSlug_WithSpecialCharacters_RemovesThem()
    {
        var result = _sut.GenerateSlugOrUuid("Hello, World! How's it going?");
        Assert.Equal("hello-world-hows-it-going", result);
    }

    [Fact]
    public void GenerateSlug_WithMultipleSpaces_CollapsesToSingleHyphen()
    {
        var result = _sut.GenerateSlugOrUuid("Hello    World");
        Assert.Equal("hello-world", result);
    }

    [Fact]
    public void GenerateSlug_WithUnicode_RemovesDiacritics()
    {
        var result = _sut.GenerateSlugOrUuid("Café résumé");
        Assert.Equal("cafe-resume", result);
    }

    [Fact]
    public void GenerateSlug_WithLeadingTrailingSpaces_TrimsHyphens()
    {
        var result = _sut.GenerateSlugOrUuid("  Hello World  ");
        Assert.Equal("hello-world", result);
    }

    [Fact]
    public void GenerateSlug_WithNumbers_PreservesNumbers()
    {
        var result = _sut.GenerateSlugOrUuid("Top 10 Tips for 2024");
        Assert.Equal("top-10-tips-for-2024", result);
    }

    [Fact]
    public void GenerateSlug_WithUnderscores_ConvertsToHyphens()
    {
        var result = _sut.GenerateSlugOrUuid("hello_world_test");
        Assert.Equal("hello-world-test", result);
    }

    [Theory]
    [InlineData("")]
    [InlineData(" ")]
    [InlineData("   ")]
    [InlineData("       ")]
    public void GenerateSlug_WithEmptyStringOrWhitespace_ReturnsGuidWithPrefix(string input)
    {
        // Act
        var result = _sut.GenerateSlugOrUuid(input);

        // Assert
        Assert.StartsWith("post-", result);

        // Extract the GUID part (the part after "post-")
        var guidPart = result.Replace("post-", "");

        // Assert it is a valid GUID
        var isValidGuid = Guid.TryParse(guidPart, out _);
        Assert.True(isValidGuid, $"Expected a valid GUID but got {guidPart}");
    }
}


================================================================================
FILE: src/MyBlog.Web/appsettings.Development.json
SIZE: .11 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft.AspNetCore": "Information"
    }
  }
}


================================================================================
FILE: src/MyBlog.Web/appsettings.json
SIZE: .60 KB
MODIFIED: 2026-01-14 19:57:11
================================================================================

{
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=myblog.db"
  },
  "Authentication": {
    "SessionTimeoutMinutes": 30,
    "DefaultAdminPassword": "ChangeMe123!"
  },
  "Telemetry": {
    "RetentionDays": 30,
    "EnableFileLogging": true,
    "EnableDatabaseLogging": true
  },
  "Application": {
    "Title": "MyBlog",
    "PostsPerPage": 10,
    "RequireHttps": false,
    "GitForgeUrl": "https://github.com/kusl/dotnetcms"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  }
}


================================================================================
FILE: src/MyBlog.Web/Components/App.razor
SIZE: 1.25 KB
MODIFIED: 2026-01-26 05:44:07
================================================================================

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#f8f9fa" />
    <base href="/" />
    <link rel="stylesheet" href="css/site.css" />
    <link rel="stylesheet" href="MyBlog.Web.styles.css" />
    <HeadOutlet @rendermode="InteractiveServer" />
    <script>
        // Inline script to prevent flash of wrong theme - runs immediately
        (function() {
            var storageKey = 'myblog-theme';
            var theme = localStorage.getItem(storageKey);
            if (!theme) {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            document.documentElement.setAttribute('data-theme', theme);
            // Update theme-color meta immediately
            var isDark = ['dark', 'nord', 'dracula'].indexOf(theme) !== -1;
            var metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) metaTheme.content = isDark ? '#0f172a' : '#f8f9fa';
        })();
    </script>
</head>
<body>
    <Routes @rendermode="InteractiveServer" />
    <script src="_framework/blazor.web.js"></script>
    <script src="js/site.js"></script>
</body>
</html>


================================================================================
FILE: src/MyBlog.Web/Components/_Imports.razor
SIZE: .73 KB
MODIFIED: 2026-01-26 06:29:50
================================================================================

@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.Extensions.Configuration
@using Microsoft.JSInterop
@using MyBlog.Web
@using MyBlog.Web.Components
@using MyBlog.Web.Components.Layout
@using MyBlog.Web.Components.Pages
@using MyBlog.Web.Components.Shared
@using MyBlog.Core.Constants
@using MyBlog.Core.Interfaces
@using MyBlog.Core.Models
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using Microsoft.AspNetCore.SignalR.Client

================================================================================
FILE: src/MyBlog.Web/Components/Layout/MainLayout.razor
SIZE: 1.19 KB
MODIFIED: 2026-01-26 05:44:15
================================================================================

@inherits LayoutComponentBase
@inject IConfiguration Configuration

<div class="layout">
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <header class="header">
        <div class="container">
            <a href="/" class="logo">@(Configuration["Application:Title"] ?? "MyBlog")</a>
            <nav class="nav" aria-label="Main navigation">
                <a href="/">Home</a>
                <a href="/about">About</a>

                <AuthorizeView>
                    <Authorized>
                        <a href="/admin">Admin</a>
                        <form class="logout-form" method="post" action="/logout">
                            <AntiforgeryToken />
                            <button type="submit">Logout</button>
                        </form>
                    </Authorized>
                    <NotAuthorized>
                        <a href="/login">Login</a>
                    </NotAuthorized>
                </AuthorizeView>

                <ThemeSwitcher />
            </nav>
        </div>
    </header>

    <main id="main-content" class="main" role="main">
        <div class="container">
            @Body
        </div>
    </main>

    <Footer />
</div>


================================================================================
FILE: src/MyBlog.Web/Components/Pages/About.razor
SIZE: 31.12 KB
MODIFIED: 2026-01-26 06:25:44
================================================================================

@page "/about"
@rendermode InteractiveServer
@implements IDisposable
@inject IConfiguration Configuration
@inject IReaderTrackingService ReaderTrackingService
@inject IPostRepository PostRepository

<PageTitle>About - @(Configuration["Application:Title"] ?? "MyBlog")</PageTitle>

<article class="about-page">
    <header class="about-header">
        <h1>About @(Configuration["Application:Title"] ?? "MyBlog")</h1>
        <p class="about-tagline">A lightweight, self-hosted blogging platform built with modern .NET technologies</p>
        <div class="reader-info">
            <ReaderBadge Slug="@TrackingSlug" />
        </div>
    </header>

    <section class="about-section">
        <h2>Overview</h2>
        <p>
            Welcome to <strong>@(Configuration["Application:Title"] ?? "MyBlog")</strong>, a powerful yet lightweight
            content management system and blogging platform built entirely with <strong>.NET 10</strong> and
            <strong>Blazor Server</strong>. This application represents a modern approach to self-hosted blogging,
            combining the performance and type-safety of C# with the interactive capabilities of Blazor's
            component-based architecture.
        </p>
        <p>
            MyBlog follows <strong>Clean Architecture</strong> principles, ensuring a clear separation of concerns
            between the domain logic, infrastructure, and presentation layers. This architectural approach makes
            the codebase maintainable, testable, and extensible for future enhancements.
        </p>
    </section>

    <section class="about-section">
        <h2>Architecture</h2>
        <p>
            The application is organized into a multi-project solution structure that follows industry best practices
            for enterprise-grade .NET applications:
        </p>

        <div class="architecture-grid">
            <div class="arch-card">
                <h3>MyBlog.Core</h3>
                <p class="arch-subtitle">Domain Layer</p>
                <p>
                    Contains the heart of the application: domain models, interfaces, and business logic services.
                    This layer has zero dependencies on external frameworks or infrastructure concerns, ensuring
                    that the core business rules remain portable and testable in isolation.
                </p>
                <div class="arch-contents">
                    <strong>Contains:</strong>
                    <ul>
                        <li><code>Models/</code> — Post, User, Image, TelemetryLog, DTOs</li>
                        <li><code>Interfaces/</code> — Repository and service contracts</li>
                        <li><code>Services/</code> — MarkdownService, SlugService</li>
                        <li><code>Constants/</code> — AppConstants (auth cookie name, roles, limits)</li>
                    </ul>
                </div>
            </div>

            <div class="arch-card">
                <h3>MyBlog.Infrastructure</h3>
                <p class="arch-subtitle">Data Access Layer</p>
                <p>
                    Implements the repository interfaces defined in Core using Entity Framework Core with SQLite.
                    This layer handles all database operations, authentication services, and external integrations.
                </p>
                <div class="arch-contents">
                    <strong>Contains:</strong>
                    <ul>
                        <li><code>Data/</code> — BlogDbContext, DatabasePathResolver</li>
                        <li><code>Repositories/</code> — EF Core implementations</li>
                        <li><code>Services/</code> — AuthService, PasswordService, ReaderTrackingService</li>
                        <li><code>Telemetry/</code> — OpenTelemetry exporters</li>
                    </ul>
                </div>
            </div>

            <div class="arch-card">
                <h3>MyBlog.Web</h3>
                <p class="arch-subtitle">Presentation Layer</p>
                <p>
                    The Blazor Server application containing all UI components, pages, layouts, and middleware.
                    Uses a hybrid rendering approach with both Server-Side Rendering (SSR) for public pages
                    and Interactive Server mode for admin functionality.
                </p>
                <div class="arch-contents">
                    <strong>Contains:</strong>
                    <ul>
                        <li><code>Components/Pages/</code> — Razor pages (Home, PostDetail, About, Login)</li>
                        <li><code>Components/Pages/Admin/</code> — Dashboard, PostEditor, UserEditor, ImageManager</li>
                        <li><code>Components/Shared/</code> — Reusable components (PostCard, Pagination, ReaderBadge)</li>
                        <li><code>Middleware/</code> — LoginRateLimitMiddleware</li>
                    </ul>
                </div>
            </div>

            <div class="arch-card">
                <h3>MyBlog.Tests</h3>
                <p class="arch-subtitle">Testing Layer</p>
                <p>
                    Comprehensive test suite using <strong>xUnit v3</strong> with both unit and integration tests.
                    The tests cover core services, repositories, and middleware functionality with high code coverage.
                </p>
                <div class="arch-contents">
                    <strong>Contains:</strong>
                    <ul>
                        <li><code>Unit/</code> — MarkdownServiceTests, SlugServiceTests, PasswordServiceTests</li>
                        <li><code>Integration/</code> — AuthServiceTests, PostRepositoryTests, TelemetryCleanupTests</li>
                        <li>LoginRateLimitMiddlewareTests with injectable delay functions</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section class="about-section">
        <h2>Technology Stack</h2>
        <div class="tech-grid">
            <div class="tech-category">
                <h3>Backend Framework</h3>
                <ul>
                    <li><strong>.NET 10</strong> — Current runtime with latest features and performance improvements</li>
                    <li><strong>Blazor Server</strong> — Component-based UI with real-time SignalR connectivity</li>
                    <li><strong>ASP.NET Core</strong> — Web framework with middleware pipeline</li>
                    <li><strong>Entity Framework Core</strong> — ORM with code-first migrations</li>
                </ul>
            </div>

            <div class="tech-category">
                <h3>Database</h3>
                <ul>
                    <li><strong>SQLite</strong> — Lightweight, serverless database engine</li>
                    <li><strong>XDG-Compliant Paths</strong> — Platform-specific data directories</li>
                    <li><strong>Image Storage</strong> — Binary data stored directly in database</li>
                    <li><strong>Telemetry Logs</strong> — Structured logging with retention policies</li>
                </ul>
            </div>

            <div class="tech-category">
                <h3>Authentication & Security</h3>
                <ul>
                    <li><strong>Cookie Authentication</strong> — Secure session management</li>
                    <li><strong>ASP.NET Identity PasswordHasher</strong> — Industry-standard hashing</li>
                    <li><strong>Rate Limiting Middleware</strong> — Progressive delays, never blocks</li>
                    <li><strong>Slug Collision Prevention</strong> — Automatic unique slug generation</li>
                </ul>
            </div>

            <div class="tech-category">
                <h3>Observability</h3>
                <ul>
                    <li><strong>OpenTelemetry</strong> — Distributed tracing and metrics</li>
                    <li><strong>File Log Exporter</strong> — JSON-formatted log files with rotation</li>
                    <li><strong>Database Log Exporter</strong> — Queryable telemetry storage</li>
                    <li><strong>Console Exporter</strong> — Development-time debugging</li>
                </ul>
            </div>

            <div class="tech-category">
                <h3>Testing</h3>
                <ul>
                    <li><strong>xUnit v3</strong> — Modern testing framework</li>
                    <li><strong>In-Memory Database</strong> — Fast integration tests</li>
                    <li><strong>Dependency Injection</strong> — Testable delay functions</li>
                    <li><strong>Cross-Platform CI</strong> — Windows, Linux, macOS matrix</li>
                </ul>
            </div>

            <div class="tech-category">
                <h3>DevOps & Deployment</h3>
                <ul>
                    <li><strong>GitHub Actions</strong> — Automated CI/CD pipeline</li>
                    <li><strong>WebDeploy</strong> — IIS deployment with AppOffline rule</li>
                    <li><strong>PowerShell Scripts</strong> — No third-party deployment actions</li>
                    <li><strong>Cross-Platform Publishing</strong> — win-x86, win-x64, linux-x64</li>
                </ul>
            </div>
        </div>
    </section>

    <section class="about-section">
        <h2>Core Features</h2>

        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-icon">📝</div>
                <h3>Markdown-Based Content</h3>
                <p>
                    Write posts in Markdown with a custom-built renderer that supports headings (h1-h6),
                    <strong>bold</strong> and <em>italic</em> text, links, images, fenced code blocks with
                    syntax preservation, blockquotes, horizontal rules, and both unordered and ordered lists.
                </p>
                <div class="feature-details">
                    <strong>Supported Syntax:</strong>
                    <code># Headings</code>, <code>**bold**</code>, <code>*italic*</code>,
                    <code>[links](url)</code>, <code>![images](url)</code>, <code>`inline code`</code>,
                    <code>```code blocks```</code>, <code>> blockquotes</code>, <code>- unordered lists</code>,
                    <code>1. ordered lists</code>, <code>---</code> horizontal rules
                </div>
            </div>

            <div class="feature-card">
                <div class="feature-icon">🖼️</div>
                <h3>Image Management</h3>
                <p>
                    Upload and manage images directly through the admin interface. Images are stored as binary
                    data in the SQLite database, eliminating file system dependencies and simplifying backups.
                </p>
                <div class="feature-details">
                    <strong>Specifications:</strong>
                    Max size: 5MB per image. Supported formats: JPEG, PNG, GIF, WebP.
                    Reference in Markdown: <code>/api/images/{'{'}id{'}'}</code>
                </div>
            </div>

            <div class="feature-card">
                <div class="feature-icon">👥</div>
                <h3>Multi-User Support</h3>
                <p>
                    Create, edit, and manage multiple user accounts with display names and email addresses.
                    Each post tracks its author, and administrators can reset passwords for other users.
                </p>
                <div class="feature-details">
                    <strong>User Management:</strong>
                    User list at <code>/admin/users</code>, create new users, edit profiles, reset passwords,
                    change your own password at <code>/admin/change-password</code>
                </div>
            </div>

            <div class="feature-card">
                <div class="feature-icon">📊</div>
                <h3>Real-Time Reader Tracking</h3>
                <p>
                    See how many people are currently reading each post with live-updating reader counts.
                    Uses a thread-safe <code>ConcurrentDictionary</code> and event-driven updates via
                    SignalR for instant UI refresh.
                </p>
                <div class="feature-details">
                    <strong>Implementation:</strong>
                    <code>IReaderTrackingService</code> with JoinPost/LeavePost lifecycle,
                    <code>OnCountChanged</code> event for reactive updates
                </div>
            </div>

            <div class="feature-card">
                <div class="feature-icon">🔒</div>
                <h3>Security Features</h3>
                <p>
                    Enterprise-grade security with rate limiting that progressively delays login attempts
                    (1s, 2s, 4s... up to 30s) but never completely blocks users. Passwords are hashed using
                    ASP.NET Identity's PasswordHasher with automatic rehashing support.
                </p>
                <div class="feature-details">
                    <strong>Rate Limiting:</strong>
                    15-minute window, delays after 5 attempts, exponential backoff formula:
                    <code>2^(attempts-5)</code> seconds, capped at 30s
                </div>
            </div>

            <div class="feature-card">
                <div class="feature-icon">🔗</div>
                <h3>Smart Slug Generation</h3>
                <p>
                    Automatically generates URL-friendly slugs from post titles with Unicode normalization,
                    special character removal, and automatic collision prevention by appending numbers
                    (<code>my-post</code>, <code>my-post-1</code>, <code>my-post-2</code>).
                </p>
                <div class="feature-details">
                    <strong>Algorithm:</strong>
                    Normalize Unicode → lowercase → replace spaces/underscores with hyphens →
                    remove non-alphanumeric → collapse multiple hyphens → trim edges
                </div>
            </div>
        </div>
    </section>

    <section class="about-section">
        <h2>Admin Dashboard</h2>
        <p>
            The administrative interface provides comprehensive content management capabilities:
        </p>

        <div class="admin-features">
            <div class="admin-feature">
                <h3>📋 Dashboard (<code>/admin</code>)</h3>
                <p>
                    Overview of your blog with total post count and the 5 most recently updated posts.
                    Quick links to all management areas with status indicators.
                </p>
            </div>

            <div class="admin-feature">
                <h3>📝 Post Management (<code>/admin/posts</code>)</h3>
                <p>
                    View all posts with title, author, and publish status. Create new posts with
                    a live Markdown preview, edit existing content, toggle publish/draft status,
                    and delete posts with confirmation.
                </p>
            </div>

            <div class="admin-feature">
                <h3>👤 User Management (<code>/admin/users</code>)</h3>
                <p>
                    List all registered users, create new accounts with usernames, emails, and display names.
                    Edit user profiles and reset passwords for other administrators.
                </p>
            </div>

            <div class="admin-feature">
                <h3>🖼️ Image Library (<code>/admin/images</code>)</h3>
                <p>
                    Upload new images with drag-and-drop support, browse existing images with
                    preview thumbnails, copy image URLs for use in Markdown, and delete unused images.
                </p>
            </div>

            <div class="admin-feature">
                <h3>🔐 Password Change (<code>/admin/change-password</code>)</h3>
                <p>
                    Securely update your password with current password verification.
                    Minimum 8 characters required, with confirmation field to prevent typos.
                </p>
            </div>
        </div>
    </section>

    <section class="about-section">
        <h2>Configuration</h2>
        <p>
            MyBlog is highly configurable through <code>appsettings.json</code> and environment variables:
        </p>

        <div class="config-section">
            <h3>Application Settings</h3>
            <div class="config-table">
                <div class="config-row">
                    <code>Application:Title</code>
                    <span>Blog title displayed in header and page titles</span>
                    <em>Default: "MyBlog"</em>
                </div>
                <div class="config-row">
                    <code>Application:PostsPerPage</code>
                    <span>Number of posts per page on the homepage</span>
                    <em>Default: 10</em>
                </div>
                <div class="config-row">
                    <code>Application:RequireHttps</code>
                    <span>Force HTTPS for authentication cookies</span>
                    <em>Default: false</em>
                </div>
                <div class="config-row">
                    <code>Application:GitForgeUrl</code>
                    <span>Link to source code repository in footer</span>
                    <em>Default: GitHub URL</em>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>Authentication Settings</h3>
            <div class="config-table">
                <div class="config-row">
                    <code>Authentication:SessionTimeoutMinutes</code>
                    <span>How long before the session expires</span>
                    <em>Default: 30</em>
                </div>
                <div class="config-row">
                    <code>Authentication:DefaultAdminPassword</code>
                    <span>Initial password for first admin user</span>
                    <em>Default: "ChangeMe123!"</em>
                </div>
                <div class="config-row">
                    <code>MYBLOG_ADMIN_PASSWORD</code>
                    <span>Environment variable override (only on first run)</span>
                    <em>Takes precedence over config file</em>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>Telemetry Settings</h3>
            <div class="config-table">
                <div class="config-row">
                    <code>Telemetry:RetentionDays</code>
                    <span>Days to keep telemetry logs before cleanup</span>
                    <em>Default: 30</em>
                </div>
                <div class="config-row">
                    <code>Telemetry:EnableFileLogging</code>
                    <span>Write logs to JSON files</span>
                    <em>Default: true</em>
                </div>
                <div class="config-row">
                    <code>Telemetry:EnableDatabaseLogging</code>
                    <span>Store logs in SQLite database</span>
                    <em>Default: true</em>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>Database Locations (XDG-Compliant)</h3>
            <div class="config-table">
                <div class="config-row">
                    <code>Linux</code>
                    <span><code>~/.local/share/MyBlog/myblog.db</code></span>
                    <em>Follows XDG_DATA_HOME</em>
                </div>
                <div class="config-row">
                    <code>macOS</code>
                    <span><code>~/Library/Application Support/MyBlog/myblog.db</code></span>
                    <em>Standard macOS location</em>
                </div>
                <div class="config-row">
                    <code>Windows</code>
                    <span><code>%LOCALAPPDATA%\MyBlog\myblog.db</code></span>
                    <em>Per-user application data</em>
                </div>
            </div>
        </div>
    </section>

    <section class="about-section">
        <h2>Deployment</h2>
        <p>
            MyBlog includes a complete CI/CD pipeline with GitHub Actions for automated testing and deployment:
        </p>

        <div class="deployment-section">
            <h3>GitHub Actions Workflow</h3>
            <ol>
                <li><strong>Build & Test</strong> — Runs on Windows, Linux, and macOS simultaneously</li>
                <li><strong>Restore</strong> — <code>dotnet restore src/MyBlog.slnx</code></li>
                <li><strong>Build</strong> — <code>dotnet build -c Release</code></li>
                <li><strong>Test</strong> — <code>dotnet test</code> with TRX output</li>
                <li><strong>Publish</strong> — Self-contained deployment for win-x86</li>
                <li><strong>Deploy</strong> — WebDeploy to IIS with AppOffline rule</li>
            </ol>
        </div>

        <div class="deployment-section">
            <h3>Required GitHub Secrets</h3>
            <div class="config-table">
                <div class="config-row">
                    <code>WEBSITE_NAME</code>
                    <span>IIS site name for WebDeploy</span>
                    <em>e.g., "MyBlog"</em>
                </div>
                <div class="config-row">
                    <code>SERVER_COMPUTER_NAME</code>
                    <span>Server hostname</span>
                    <em>e.g., "myserver.example.com"</em>
                </div>
                <div class="config-row">
                    <code>SERVER_USERNAME</code>
                    <span>WebDeploy authentication user</span>
                    <em>Deploy account username</em>
                </div>
                <div class="config-row">
                    <code>SERVER_PASSWORD</code>
                    <span>WebDeploy authentication password</span>
                    <em>Stored as secret</em>
                </div>
            </div>
        </div>

        <div class="deployment-section">
            <h3>WebDeploy Configuration</h3>
            <p>
                The deployment uses key features to ensure zero-downtime deployments:
            </p>
            <ul>
                <li><strong>AppOffline Rule</strong> — Creates <code>app_offline.htm</code> to gracefully stop the application</li>
                <li><strong>DoNotDeleteRule</strong> — Preserves existing files not in the deployment package</li>
                <li><strong>Retry Logic</strong> — 3 retry attempts with 3-second intervals for transient failures</li>
                <li><strong>File Locking Prevention</strong> — Solves ERROR_FILE_IN_USE during active deployments</li>
            </ul>
        </div>
    </section>

    <section class="about-section">
        <h2>Design Principles</h2>
        <div class="principles-grid">
            <div class="principle">
                <h3>🎯 Zero External Dependencies</h3>
                <p>
                    No npm, no Node.js, no CSS frameworks. All styling is custom CSS using CSS variables
                    for theming. The only JavaScript is Blazor's <code>blazor.web.js</code> runtime.
                </p>
            </div>

            <div class="principle">
                <h3>📦 Self-Contained</h3>
                <p>
                    Everything needed runs from a single deployable unit. SQLite eliminates the need
                    for external database servers. Images are stored in the database, not the filesystem.
                </p>
            </div>

            <div class="principle">
                <h3>🔧 Centralized Package Management</h3>
                <p>
                    Uses <code>Directory.Packages.props</code> for consistent NuGet package versions
                    across all projects. The modern <code>.slnx</code> solution format keeps things clean.
                </p>
            </div>

            <div class="principle">
                <h3>⚡ Performance First</h3>
                <p>
                    Public pages use Server-Side Rendering (SSR) for fast initial loads. Interactive
                    features are scoped to admin pages where they're needed. AsNoTracking queries
                    minimize EF Core overhead for read operations.
                </p>
            </div>

            <div class="principle">
                <h3>🧪 Testability</h3>
                <p>
                    All services use interface-based dependency injection. The rate limiting middleware
                    accepts an injectable delay function for instant test execution instead of real waits.
                </p>
            </div>

            <div class="principle">
                <h3>🌍 Cross-Platform</h3>
                <p>
                    Runs identically on Windows, Linux, and macOS. XDG-compliant paths ensure data
                    is stored in appropriate locations for each operating system.
                </p>
            </div>
        </div>
    </section>

    <section class="about-section">
        <h2>Data Models</h2>
        <p>
            The core domain models represent the fundamental entities in the blogging system:
        </p>

        <div class="model-grid">
            <div class="model-card">
                <h3>Post</h3>
                <p>A blog post with full content management capabilities.</p>
                <div class="model-fields">
                    <code>Id</code> (Guid), <code>Title</code>, <code>Slug</code>, <code>Content</code>,
                    <code>Summary</code>, <code>AuthorId</code>, <code>CreatedAtUtc</code>,
                    <code>UpdatedAtUtc</code>, <code>PublishedAtUtc</code>, <code>IsPublished</code>
                </div>
            </div>

            <div class="model-card">
                <h3>User</h3>
                <p>An authenticated user who can create and manage content.</p>
                <div class="model-fields">
                    <code>Id</code> (Guid), <code>Username</code>, <code>PasswordHash</code>,
                    <code>Email</code>, <code>DisplayName</code>, <code>CreatedAtUtc</code>
                </div>
            </div>

            <div class="model-card">
                <h3>Image</h3>
                <p>An uploaded image stored as binary data in the database.</p>
                <div class="model-fields">
                    <code>Id</code> (Guid), <code>FileName</code>, <code>ContentType</code>,
                    <code>Data</code> (byte[]), <code>UploadedByUserId</code>, <code>UploadedAtUtc</code>,
                    <code>PostId</code> (optional)
                </div>
            </div>

            <div class="model-card">
                <h3>TelemetryLog</h3>
                <p>Structured log entries for observability and debugging.</p>
                <div class="model-fields">
                    <code>Id</code> (int), <code>TimestampUtc</code>, <code>Level</code>,
                    <code>Category</code>, <code>Message</code>, <code>Exception</code>,
                    <code>TraceId</code>, <code>SpanId</code>, <code>Properties</code> (JSON)
                </div>
            </div>
        </div>
    </section>

    <section class="about-section">
        <h2>API Endpoints</h2>
        <p>
            While primarily a Blazor Server application, MyBlog exposes a few HTTP endpoints:
        </p>

        <div class="api-table">
            <div class="api-row">
                <code>GET /api/images/{'{'}id{'}'}</code>
                <span>Retrieve an image by its GUID for embedding in posts</span>
            </div>
            <div class="api-row">
                <code>POST /logout</code>
                <span>Sign out the current user (requires authorization)</span>
            </div>
            <div class="api-row">
                <code>POST /login</code>
                <span>Form-based authentication with rate limiting</span>
            </div>
        </div>
    </section>

    <section class="about-section">
        <h2>Quick Start</h2>
        <div class="quickstart">
            <h3>Prerequisites</h3>
            <p><a href="https://dotnet.microsoft.com/download/dotnet/10.0" target="_blank">.NET 10 SDK</a> or later</p>

            <h3>Running Locally</h3>
            <pre><code># Clone the repository
git clone https://github.com/kusl/dotnetcms.git
cd dotnetcms/src

# Restore and run
dotnet restore MyBlog.slnx
cd MyBlog.Web
dotnet run</code></pre>

            <h3>Default Credentials</h3>
            <p>
                <strong>Username:</strong> <code>admin</code><br />
                <strong>Password:</strong> <code>ChangeMe123!</code> (or set <code>MYBLOG_ADMIN_PASSWORD</code> environment variable before first run)
            </p>

            <div class="warning-box">
                <strong>⚠️ Important:</strong> The default password is only used when creating the initial admin user.
                Once the user exists, you must change the password through the website at <code>/admin/change-password</code>.
            </div>
        </div>
    </section>

    <section class="about-section stats-section">
        <h2>Current Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">@_postCount</div>
                <div class="stat-label">Total Posts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@_publishedCount</div>
                <div class="stat-label">Published</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">@(_postCount - _publishedCount)</div>
                <div class="stat-label">Drafts</div>
            </div>
        </div>
    </section>

    <section class="about-section">
        <h2>Open Source</h2>
        <p>
            MyBlog is open source software. The complete source code, including this page, is available
            on GitHub. Contributions, bug reports, and feature requests are welcome!
        </p>
        <p>
            <a href="@(Configuration["Application:GitForgeUrl"] ?? "https://github.com/kusl/dotnetcms")"
               target="_blank"
               class="github-link">
                View on GitHub →
            </a>
        </p>
    </section>

    <footer class="about-footer">
        <p>
            Built with ❤️ using .NET 10 and Blazor Server
        </p>
        <p class="version-info">
            <small>
                Runtime: @System.Runtime.InteropServices.RuntimeInformation.FrameworkDescription |
                OS: @System.Runtime.InteropServices.RuntimeInformation.OSDescription
            </small>
        </p>
    </footer>
</article>

@code {
    private const string TrackingSlug = "__about_page__";
    private int _postCount;
    private int _publishedCount;

    protected override async Task OnInitializedAsync()
    {
        var (posts, totalCount) = await PostRepository.GetPublishedPostsAsync(1, int.MaxValue);
        _publishedCount = totalCount;
        _postCount = await PostRepository.GetCountAsync();
    }

    private void HandleCountChanged(string slug, int count)
    {
        if (slug == TrackingSlug)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/About.razor.css
SIZE: 10.55 KB
MODIFIED: 2026-01-14 19:31:11
================================================================================

/* About Page Styles */
.about-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--spacing);
}

/* Header */
.about-header {
    text-align: center;
    padding: calc(var(--spacing) * 2) 0;
    border-bottom: 1px solid var(--color-border);
    margin-bottom: calc(var(--spacing) * 2);
}

.about-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    color: var(--color-primary);
}

.about-tagline {
    font-size: 1.25rem;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
}

.reader-info {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
}

/* Sections */
.about-section {
    margin-bottom: calc(var(--spacing) * 3);
    padding-bottom: calc(var(--spacing) * 2);
    border-bottom: 1px solid var(--color-border);
}

.about-section:last-of-type {
    border-bottom: none;
}

.about-section h2 {
    font-size: 1.75rem;
    margin-bottom: 1rem;
    color: var(--color-text);
    position: relative;
    padding-bottom: 0.5rem;
}

.about-section h2::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 3px;
    background: var(--color-primary);
    border-radius: 2px;
}

.about-section p {
    line-height: 1.8;
    margin-bottom: 1rem;
}

/* Architecture Grid */
.architecture-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.arch-card {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.5rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.arch-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.arch-card h3 {
    color: var(--color-primary);
    margin-bottom: 0.25rem;
    font-size: 1.25rem;
}

.arch-subtitle {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
    font-weight: 500;
}

.arch-contents {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
    font-size: 0.9rem;
}

.arch-contents ul {
    margin: 0.5rem 0 0 1.25rem;
    padding: 0;
}

.arch-contents li {
    margin-bottom: 0.25rem;
}

.arch-contents code {
    background: var(--color-bg);
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
    font-size: 0.85em;
}

/* Technology Grid */
.tech-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.tech-category {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.25rem;
}

.tech-category h3 {
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    color: var(--color-primary);
    border-bottom: 2px solid var(--color-primary);
    padding-bottom: 0.5rem;
}

.tech-category ul {
    margin: 0;
    padding: 0;
    list-style: none;
}

.tech-category li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--color-border);
    font-size: 0.95rem;
}

.tech-category li:last-child {
    border-bottom: none;
}

/* Feature Grid */
.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.feature-card {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.5rem;
    transition: transform 0.2s ease;
}

.feature-card:hover {
    transform: translateY(-2px);
}

.feature-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
}

.feature-card h3 {
    font-size: 1.15rem;
    margin-bottom: 0.75rem;
    color: var(--color-text);
}

.feature-details {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.feature-details code {
    background: var(--color-bg);
    padding: 0.125rem 0.25rem;
    border-radius: 3px;
    font-size: 0.9em;
}

/* Admin Features */
.admin-features {
    display: grid;
    gap: 1rem;
    margin-top: 1.5rem;
}

.admin-feature {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.25rem;
}

.admin-feature h3 {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    color: var(--color-text);
}

.admin-feature code {
    background: var(--color-bg);
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
    font-size: 0.85em;
    color: var(--color-primary);
}

/* Configuration Tables */
.config-section {
    margin-top: 1.5rem;
}

.config-section h3 {
    font-size: 1.15rem;
    margin-bottom: 1rem;
    color: var(--color-text);
}

.config-table {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    overflow: hidden;
}

.config-row {
    display: grid;
    grid-template-columns: minmax(200px, 1fr) 2fr auto;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
    align-items: center;
}

.config-row:last-child {
    border-bottom: none;
}

.config-row code {
    background: var(--color-bg);
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    font-size: 0.85rem;
    color: var(--color-primary);
    word-break: break-all;
}

.config-row em {
    font-size: 0.85rem;
    color: var(--color-text-muted);
    white-space: nowrap;
}

/* Deployment Section */
.deployment-section {
    margin-top: 1.5rem;
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.5rem;
}

.deployment-section h3 {
    font-size: 1.15rem;
    margin-bottom: 1rem;
    color: var(--color-primary);
}

.deployment-section ol {
    margin: 0;
    padding-left: 1.5rem;
}

.deployment-section li {
    margin-bottom: 0.5rem;
}

.deployment-section ul {
    margin: 0.5rem 0 0 0;
    padding-left: 1.5rem;
}

/* Principles Grid */
.principles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.principle {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.5rem;
}

.principle h3 {
    font-size: 1.1rem;
    margin-bottom: 0.75rem;
    color: var(--color-text);
}

.principle p {
    font-size: 0.95rem;
    margin: 0;
}

/* Model Grid */
.model-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.model-card {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.5rem;
}

.model-card h3 {
    color: var(--color-primary);
    margin-bottom: 0.5rem;
    font-size: 1.2rem;
}

.model-fields {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.model-fields code {
    background: var(--color-bg);
    padding: 0.125rem 0.25rem;
    border-radius: 3px;
    margin-right: 0.25rem;
}

/* API Table */
.api-table {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-top: 1rem;
}

.api-row {
    display: grid;
    grid-template-columns: minmax(200px, auto) 1fr;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
    align-items: center;
}

.api-row:last-child {
    border-bottom: none;
}

.api-row code {
    background: var(--color-bg);
    padding: 0.375rem 0.625rem;
    border-radius: 3px;
    font-size: 0.9rem;
    color: var(--color-primary);
    font-weight: 500;
}

/* Quick Start */
.quickstart {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-top: 1rem;
}

.quickstart h3 {
    font-size: 1.1rem;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--color-primary);
}

.quickstart h3:first-child {
    margin-top: 0;
}

.quickstart pre {
    background: var(--color-bg);
    padding: 1rem;
    border-radius: var(--radius);
    overflow-x: auto;
    margin: 0.5rem 0;
}

.quickstart code {
    font-size: 0.9rem;
    line-height: 1.6;
}

.warning-box {
    background: #fef3cd;
    border: 1px solid #ffc107;
    border-radius: var(--radius);
    padding: 1rem;
    margin-top: 1rem;
    color: #856404;
}

/* Stats Section */
.stats-section {
    text-align: center;
}

.stats-grid {
    display: flex;
    justify-content: center;
    gap: 2rem;
    flex-wrap: wrap;
    margin-top: 1.5rem;
}

.stat-card {
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    padding: 1.5rem 2.5rem;
    min-width: 140px;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--color-primary);
}

.stat-label {
    font-size: 0.95rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
}

/* GitHub Link */
.github-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--color-primary);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    text-decoration: none;
    font-weight: 500;
    transition: background 0.2s ease, transform 0.2s ease;
}

.github-link:hover {
    background: var(--color-primary-dark, #1a5490);
    transform: translateY(-1px);
    color: white;
    text-decoration: none;
}

/* Footer */
.about-footer {
    text-align: center;
    padding: calc(var(--spacing) * 2) 0;
    margin-top: calc(var(--spacing) * 2);
    border-top: 1px solid var(--color-border);
}

.about-footer p {
    margin: 0.5rem 0;
}

.version-info {
    color: var(--color-text-muted);
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .about-header h1 {
        font-size: 2rem;
    }

    .about-tagline {
        font-size: 1.1rem;
    }

    .about-section h2 {
        font-size: 1.5rem;
    }

    .config-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }

    .config-row em {
        white-space: normal;
    }

    .api-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }

    .stats-grid {
        gap: 1rem;
    }

    .stat-card {
        padding: 1rem 1.5rem;
        min-width: 100px;
    }

    .stat-value {
        font-size: 2rem;
    }
}

@media (max-width: 480px) {
    .about-page {
        padding: 0 0.75rem;
    }

    .arch-card,
    .feature-card,
    .principle,
    .model-card {
        padding: 1rem;
    }

    .quickstart {
        padding: 1rem;
    }

    .quickstart pre {
        padding: 0.75rem;
        font-size: 0.8rem;
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/AccessDenied.razor
SIZE: .56 KB
MODIFIED: 2026-01-01 16:53:04
================================================================================

@page "/access-denied"

<PageTitle>Access Denied</PageTitle>

<div class="container" style="max-width: 600px; margin-top: 50px; text-align: center;">
    <h1 style="color: var(--color-danger);">Access Denied</h1>
    <p>You do not have permission to view this resource.</p>
    <div style="margin-top: 20px;">
        <a href="/" class="btn btn-primary">Return Home</a>
        <form action="/logout" method="post" style="display: inline;">
            <AntiforgeryToken />
            <button type="submit" class="btn btn-link">Logout</button>
        </form>
    </div>
</div>

================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/ChangePassword.razor
SIZE: 3.19 KB
MODIFIED: 2026-01-26 11:43:49
================================================================================

@page "/admin/change-password"
@attribute [Authorize]
@inject IAuthService AuthService
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Navigation
@using System.Security.Claims
@rendermode InteractiveServer

<PageTitle>Change Password</PageTitle>

<h1>Change Password</h1>

<div class="change-password-form">
    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="success-message">@_successMessage</div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="error-message">@_errorMessage</div>
    }

    <form @onsubmit="HandleSubmit">
        <div class="form-group">
            <label for="currentPassword">Current Password</label>
            <input type="password" id="currentPassword" name="currentPassword" @bind="_currentPassword" required />
        </div>

        <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" name="newPassword" @bind="_newPassword" required minlength="8" />
            <small>Minimum 8 characters</small>
        </div>

        <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword" @bind="_confirmPassword" required />
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Change Password</button>
            <a href="/admin" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

@code {
    private string _currentPassword = "";
    private string _newPassword = "";
    private string _confirmPassword = "";
    private string? _successMessage;
    private string? _errorMessage;

    private async Task HandleSubmit()
    {
        _successMessage = null;
        _errorMessage = null;

        // Validation
        if (string.IsNullOrWhiteSpace(_newPassword) || _newPassword.Length < 8)
        {
            _errorMessage = "New password must be at least 8 characters.";
            return;
        }

        if (_newPassword != _confirmPassword)
        {
            _errorMessage = "New password and confirmation do not match.";
            return;
        }

        if (_currentPassword == _newPassword)
        {
            _errorMessage = "New password must be different from current password.";
            return;
        }

        // Get current user ID
        var context = HttpContextAccessor.HttpContext;
        var userIdClaim = context?.User?.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        
        if (string.IsNullOrEmpty(userIdClaim) || !Guid.TryParse(userIdClaim, out var userId))
        {
            _errorMessage = "Unable to identify current user. Please log in again.";
            return;
        }

        // Attempt password change
        var success = await AuthService.ChangePasswordAsync(userId, _currentPassword, _newPassword);

        if (success)
        {
            _successMessage = "Password changed successfully!";
            _currentPassword = "";
            _newPassword = "";
            _confirmPassword = "";
        }
        else
        {
            _errorMessage = "Current password is incorrect.";
        }
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/ChangePassword.razor.css
SIZE: .23 KB
MODIFIED: 2026-01-26 08:42:07
================================================================================

/* ChangePassword.razor.css - Component-scoped styles */

.change-password-form {
    max-width: 500px;
}

.change-password-form small {
    display: block;
    margin-top: 0.25rem;
    color: var(--color-text-muted);
    font-size: 0.875rem;
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/Dashboard.razor
SIZE: 1.53 KB
MODIFIED: 2026-01-13 09:34:22
================================================================================

@page "/admin"
@attribute [Authorize]
@inject IPostRepository PostRepository
@rendermode InteractiveServer

<PageTitle>Admin Dashboard</PageTitle>

<h1>Admin Dashboard</h1>

<div class="dashboard-stats">
    <div class="stat-card">
        <h3>Total Posts</h3>
        <p class="stat-value">@_postCount</p>
    </div>
</div>

<div class="admin-nav">
    <a href="/admin/posts" class="btn">Manage Posts</a>
    <a href="/admin/posts/new" class="btn">New Post</a>
    <a href="/admin/images" class="btn">Manage Images</a>
</div>

<h2>Recent Posts</h2>
@if (_recentPosts is null)
{
    <p>Loading...</p>
}
else if (_recentPosts.Count == 0)
{
    <p>No posts yet.</p>
}
else
{
    <table class="admin-table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Status</th>
                <th>Updated</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var post in _recentPosts)
            {
                <tr>
                    <td><a href="/admin/posts/edit/@post.Id">@post.Title</a></td>
                    <td>@(post.IsPublished ? "Published" : "Draft")</td>
                    <td>@(post.PublishedAtUtc?.ToString("MMM d, yyyy") ?? "—")</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private int _postCount;
    private IReadOnlyList<PostListItemDto>? _recentPosts;

    protected override async Task OnInitializedAsync()
    {
        _postCount = await PostRepository.GetCountAsync();
        _recentPosts = await PostRepository.GetRecentPostsAsync(5);
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/Dashboard.razor.css
SIZE: .93 KB
MODIFIED: 2026-01-26 08:41:48
================================================================================

/* Dashboard.razor.css - Component-scoped styles */

.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--spacing);
    margin-bottom: calc(var(--spacing) * 2);
}

.stat-card {
    padding: calc(var(--spacing) * 1.25);
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    text-align: center;
    transition: border-color var(--transition-fast);
}

.stat-card:hover {
    border-color: var(--color-primary-muted);
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: var(--color-primary);
}

.stat-label {
    color: var(--color-text-muted);
    font-size: 0.875rem;
}

.admin-nav {
    display: flex;
    gap: 0.5rem;
    margin-bottom: calc(var(--spacing) * 2);
    flex-wrap: wrap;
}

@media (max-width: 480px) {
    .dashboard-stats {
        grid-template-columns: 1fr;
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/ImageManager.razor
SIZE: 3.84 KB
MODIFIED: 2025-12-30 17:48:21
================================================================================

@page "/admin/images"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IImageRepository ImageRepository
@inject AuthenticationStateProvider AuthStateProvider
@using System.Security.Claims

<PageTitle>Manage Images</PageTitle>

<h1>Manage Images</h1>

<div class="image-upload">
    <h3>Upload New Image</h3>
    <InputFile OnChange="HandleFileUpload" accept="image/*" disabled="@_uploading" />
    @if (_uploading)
    {
        <p>Uploading...</p>
    }
    @if (!string.IsNullOrEmpty(_uploadStatus))
    {
        <p class="@(_uploadError ? "error" : "success")">@_uploadStatus</p>
    }
</div>

<h3>Uploaded Images</h3>
@if (_images is null)
{
    <p>Loading...</p>
}
else if (_images.Count == 0)
{
    <p>No images uploaded yet.</p>
}
else
{
    <div class="image-grid">
        @foreach (var image in _images)
        {
            <div class="image-card">
                <img src="/api/images/@image.Id" alt="@image.FileName" />
                <div class="image-info">
                    <p>@image.FileName</p>
                    <code>/api/images/@image.Id</code>
                    <button @onclick="() => DeleteImage(image.Id)" class="btn-link danger" disabled="@_deleting">Delete</button>
                </div>
            </div>
        }
    </div>
}

@code {
    private IReadOnlyList<Image>? _images;
    private string? _uploadStatus;
    private bool _uploadError;
    private bool _uploading;
    private bool _deleting;

    protected override async Task OnInitializedAsync()
    {
        await LoadImages();
    }

    private async Task LoadImages()
    {
        _images = await ImageRepository.GetAllAsync();
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        _uploadStatus = null;
        _uploadError = false;
        _uploading = true;

        try
        {
            var file = e.File;
            if (file.Size > AppConstants.MaxImageSizeBytes)
            {
                _uploadStatus = "File too large. Maximum size is 5MB.";
                _uploadError = true;
                return;
            }

            if (!AppConstants.AllowedImageTypes.Contains(file.ContentType))
            {
                _uploadStatus = "Invalid file type. Only JPEG, PNG, GIF, and WebP are allowed.";
                _uploadError = true;
                return;
            }

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
            
            if (userIdClaim is null || !Guid.TryParse(userIdClaim.Value, out var userId))
            {
                _uploadStatus = "Unable to identify current user. Please log in again.";
                _uploadError = true;
                return;
            }

            using var stream = file.OpenReadStream(AppConstants.MaxImageSizeBytes);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            var image = new Image
            {
                Id = Guid.NewGuid(),
                FileName = file.Name,
                ContentType = file.ContentType,
                Data = ms.ToArray(),
                UploadedAtUtc = DateTime.UtcNow,
                UploadedByUserId = userId
            };

            await ImageRepository.CreateAsync(image);
            _uploadStatus = "Image uploaded successfully!";
            await LoadImages();
        }
        catch (Exception ex)
        {
            _uploadStatus = $"Upload failed: {ex.Message}";
            _uploadError = true;
        }
        finally
        {
            _uploading = false;
        }
    }

    private async Task DeleteImage(Guid id)
    {
        _deleting = true;
        try
        {
            await ImageRepository.DeleteAsync(id);
            await LoadImages();
        }
        finally
        {
            _deleting = false;
        }
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/ImageManager.razor.css
SIZE: 1.34 KB
MODIFIED: 2026-01-26 08:41:34
================================================================================

/* ImageManager.razor.css - Component-scoped styles */

.image-upload {
    margin-bottom: calc(var(--spacing) * 2);
    padding: var(--spacing);
    background-color: var(--color-bg-alt);
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-lg);
    transition: border-color var(--transition-fast);
}

.image-upload:hover {
    border-color: var(--color-primary-muted);
}

.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--spacing);
}

.image-card {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background-color: var(--color-bg);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.image-card:hover {
    border-color: var(--color-primary-muted);
    box-shadow: 0 4px 12px var(--color-shadow);
}

.image-card img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.image-info {
    padding: 0.75rem;
}

.image-info p {
    margin: 0 0 0.25rem;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.image-info code {
    display: block;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
    padding: 0.25rem;
    background-color: var(--color-code-bg);
    border-radius: 0.25rem;
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/PostEditor.razor
SIZE: 5.50 KB
MODIFIED: 2026-01-19 18:32:12
================================================================================

@page "/admin/posts/new"
@page "/admin/posts/edit/{Id:guid}"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IPostRepository PostRepository
@inject ISlugService SlugService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@using System.Security.Claims

<PageTitle>@(IsEdit ? "Edit Post" : "New Post")</PageTitle>

<h1>@(IsEdit ? "Edit Post" : "New Post")</h1>

@if (_loading)
{
    <p>Loading...</p>
}
else if (IsEdit && _existingPost is null)
{
    <p>Post not found.</p>
    <a href="/admin/posts">Back to Posts</a>
}
else
{
    <div class="post-editor">
        <div class="editor-form">
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" @bind="_title" @bind:event="oninput" />
            </div>

            <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" @bind="_summary" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label for="content">Content (Markdown)</label>
                <textarea id="content" @bind="_content" @bind:event="oninput" rows="20"></textarea>
            </div>

            <div class="form-group checkbox">
                <label>
                    <input type="checkbox" @bind="_isPublished" />
                    Published
                </label>
            </div>

            @if (!string.IsNullOrEmpty(_error))
            {
                <div class="error-message">@_error</div>
            }

            <div class="form-actions">
                <button @onclick="Save" class="btn btn-primary" disabled="@_saving">
                    @(_saving ? "Saving..." : "Save")
                </button>
                <a href="/admin/posts" class="btn">Cancel</a>
            </div>
        </div>

        <div class="editor-preview">
            <h3>Preview</h3>
            <div class="preview-content">
                <MarkdownRenderer Content="@_content" />
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid? Id { get; set; }

    private bool IsEdit => Id.HasValue;
    private bool _loading = true;
    private bool _saving;
    private string _title = "";
    private string _summary = "";
    private string _content = "";
    private bool _isPublished;
    private string? _error;
    private Post? _existingPost;

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            _existingPost = await PostRepository.GetByIdAsync(Id!.Value);
            if (_existingPost is not null)
            {
                _title = _existingPost.Title;
                _summary = _existingPost.Summary;
                _content = _existingPost.Content;
                _isPublished = _existingPost.IsPublished;
            }
        }
        _loading = false;
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(_title))
        {
            _error = "Title is required.";
            return;
        }

        _saving = true;
        _error = null;

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);

            if (userIdClaim is null || !Guid.TryParse(userIdClaim.Value, out var userId))
            {
                _error = "Unable to identify current user. Please log in again.";
                _saving = false;
                return;
            }

            // Generate unique slug
            var baseSlug = SlugService.GenerateSlugOrUuid(_title);
            var finalSlug = baseSlug;
            var counter = 1;

            // Loop until we find a slug that isn't taken (excluding current post if editing)
            while (await PostRepository.IsSlugTakenAsync(finalSlug, IsEdit ? Id : null))
            {
                finalSlug = $"{baseSlug}-{counter}";
                counter++;
            }

            if (IsEdit && _existingPost is not null)
            {
                _existingPost.Title = _title;
                _existingPost.Slug = finalSlug; // Update slug with unique version
                _existingPost.Summary = _summary;
                _existingPost.Content = _content;
                _existingPost.IsPublished = _isPublished;
                _existingPost.UpdatedAtUtc = DateTime.UtcNow;
                if (_isPublished && !_existingPost.PublishedAtUtc.HasValue)
                {
                    _existingPost.PublishedAtUtc = DateTime.UtcNow;
                }

                await PostRepository.UpdateAsync(_existingPost);
            }
            else
            {
                var post = new Post
                {
                    Id = Guid.NewGuid(),
                    Title = _title,
                    Slug = finalSlug, // Use unique slug
                    Summary = _summary,
                    Content = _content,
                    AuthorId = userId,
                    CreatedAtUtc = DateTime.UtcNow,
                    UpdatedAtUtc = DateTime.UtcNow,
                    IsPublished = _isPublished,
                    PublishedAtUtc = _isPublished ? DateTime.UtcNow : null
                };
                await PostRepository.CreateAsync(post);
            }

            Navigation.NavigateTo("/admin/posts");
        }
        catch (Exception ex)
        {
            _error = $"Failed to save: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/PostEditor.razor.css
SIZE: .77 KB
MODIFIED: 2026-01-26 08:41:17
================================================================================

/* PostEditor.razor.css - Component-scoped styles */

.post-editor {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: calc(var(--spacing) * 2);
}

.editor-preview {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing);
    max-height: 80vh;
    overflow-y: auto;
    background-color: var(--color-bg);
}

.editor-preview h3 {
    margin-bottom: var(--spacing);
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
    color: var(--color-text-muted);
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

@media (max-width: 768px) {
    .post-editor {
        grid-template-columns: 1fr;
    }

    .editor-preview {
        order: -1;
        max-height: 300px;
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/PostList.razor
SIZE: 1.72 KB
MODIFIED: 2025-12-30 17:48:21
================================================================================

@page "/admin/posts"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IPostRepository PostRepository
@inject NavigationManager Navigation

<PageTitle>Manage Posts</PageTitle>

<h1>Manage Posts</h1>

<p><a href="/admin/posts/new" class="btn btn-primary">Create New Post</a></p>

@if (_posts is null)
{
    <p>Loading...</p>
}
else if (_posts.Count == 0)
{
    <p>No posts yet.</p>
}
else
{
    <table class="admin-table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var post in _posts)
            {
                <tr>
                    <td>@post.Title</td>
                    <td>@post.AuthorDisplayName</td>
                    <td>@(post.IsPublished ? "Published" : "Draft")</td>
                    <td>
                        <a href="/admin/posts/edit/@post.Id">Edit</a>
                        <button @onclick="() => DeletePost(post.Id)" class="btn-link danger" disabled="@_deleting">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private IReadOnlyList<PostListItemDto>? _posts;
    private bool _deleting;

    protected override async Task OnInitializedAsync()
    {
        await LoadPosts();
    }

    private async Task LoadPosts()
    {
        _posts = await PostRepository.GetAllPostsAsync();
    }

    private async Task DeletePost(Guid id)
    {
        _deleting = true;
        try
        {
            await PostRepository.DeleteAsync(id);
            await LoadPosts();
        }
        finally
        {
            _deleting = false;
        }
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/UserEditor.razor
SIZE: 4.70 KB
MODIFIED: 2026-01-11 12:43:24
================================================================================

@page "/admin/users/new"
@page "/admin/users/edit/{Id:guid}"
@attribute [Authorize(Roles = AppConstants.AdminRole)]
@rendermode InteractiveServer
@inject IUserRepository UserRepository
@inject IPasswordService PasswordService
@inject NavigationManager Navigation

<PageTitle>@(IsEdit ? "Edit User" : "New User")</PageTitle>

<h1>@(IsEdit ? "Edit User" : "New User")</h1>

<div class="user-editor" style="max-width: 600px;">
    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="error-message">@_error</div>
    }

    <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" @bind="_username" required />
    </div>

    <div class="form-group">
        <label for="displayName">Display Name</label>
        <input type="text" id="displayName" @bind="_displayName" required />
    </div>

    <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" @bind="_email" required />
    </div>

    <div class="form-group">
        <label for="password">Password @(IsEdit ? "(Leave blank to keep current)" : "")</label>
        <input type="password" id="password" @bind="_password" required="@(!IsEdit)" />
        @if (!IsEdit) 
        {
            <small>Required for new users.</small>
        }
    </div>

    <div class="form-actions">
        <button @onclick="Save" class="btn btn-primary" disabled="@_saving">
            @(_saving ? "Saving..." : "Save User")
        </button>
        <a href="/admin/users" class="btn btn-secondary">Cancel</a>
    </div>
</div>

@code {
    [Parameter]
    public Guid? Id { get; set; }

    private bool IsEdit => Id.HasValue;
    private bool _saving;
    private string? _error;

    // Form fields
    private string _username = "";
    private string _displayName = "";
    private string _email = "";
    private string _password = "";

    private User? _existingUser;

    protected override async Task OnParametersSetAsync()
    {
        if (IsEdit)
        {
            _existingUser = await UserRepository.GetByIdAsync(Id!.Value);
            if (_existingUser is null)
            {
                Navigation.NavigateTo("/admin/users");
                return;
            }

            _username = _existingUser.Username;
            _displayName = _existingUser.DisplayName;
            _email = _existingUser.Email;
        }
    }

    private async Task Save()
    {
        _error = null;
        _saving = true;

        try
        {
            if (string.IsNullOrWhiteSpace(_username) || string.IsNullOrWhiteSpace(_displayName) || string.IsNullOrWhiteSpace(_email))
            {
                _error = "All fields are required.";
                return;
            }

            // Check if username is taken (by another user)
            var duplicate = await UserRepository.GetByUsernameAsync(_username);
            if (duplicate is not null && duplicate.Id != Id)
            {
                _error = "Username is already taken.";
                return;
            }

            if (IsEdit && _existingUser is not null)
            {
                // Update existing
                _existingUser.Username = _username;
                _existingUser.DisplayName = _displayName;
                _existingUser.Email = _email;

                // Only update password if provided
                if (!string.IsNullOrWhiteSpace(_password))
                {
                     if (_password.Length < 8)
                     {
                         _error = "Password must be at least 8 characters.";
                         return;
                     }
                    _existingUser.PasswordHash = PasswordService.HashPassword(_password);
                }

                await UserRepository.UpdateAsync(_existingUser);
            }
            else
            {
                // Create new
                if (string.IsNullOrWhiteSpace(_password) || _password.Length < 8)
                {
                    _error = "Password is required (min 8 chars) for new users.";
                    return;
                }

                var newUser = new User
                {
                    Id = Guid.NewGuid(),
                    Username = _username,
                    DisplayName = _displayName,
                    Email = _email,
                    PasswordHash = PasswordService.HashPassword(_password),
                    CreatedAtUtc = DateTime.UtcNow
                };

                await UserRepository.CreateAsync(newUser);
            }

            Navigation.NavigateTo("/admin/users");
        }
        catch (Exception ex)
        {
            _error = $"Error saving user: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/UserEditor.razor.css
SIZE: .52 KB
MODIFIED: 2026-01-26 08:42:20
================================================================================

/* UserEditor.razor.css - Component-scoped styles */

/* Container styling */
.user-editor {
    width: 100%;
    padding: 1rem;
    box-sizing: border-box;
}

/* Desktop optimization: Switch to side-by-side if screen is wide enough */
@media (min-width: 768px) {
    .user-editor .form-group {
        flex-direction: row;
        align-items: center;
        display: flex;
    }

    .user-editor .form-group label {
        flex: 0 0 150px;
        margin-bottom: 0;
    }

    .user-editor .form-group input {
        flex: 1;
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/UserList.razor
SIZE: 3.04 KB
MODIFIED: 2026-01-16 19:51:23
================================================================================

@page "/admin/users"
@attribute [Authorize(Roles = AppConstants.AdminRole)]
@rendermode InteractiveServer
@inject IUserRepository UserRepository
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JsRuntime
@using System.Security.Claims

<PageTitle>Manage Users</PageTitle>

<div class="admin-container">
    <div class="admin-header">
        <h1>Manage Users</h1>
        <a href="/admin/users/new" class="btn btn-primary">Create New User</a>
    </div>

    @if (_users is null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="responsive-user-list">
            @* Header - Hidden on mobile *@
            <div class="list-header d-none-mobile">
                <div class="col">Username</div>
                <div class="col">Display Name</div>
                <div class="col">Email</div>
                <div class="col actions">Actions</div>
            </div>

            @foreach (var user in _users)
            {
                <div class="list-row">
                    <div class="list-item">
                        <span class="mobile-label">Username:</span>
                        <a href="/admin/users/edit/@user.Id">@user.Username</a>
                    </div>
                    <div class="list-item">
                        <span class="mobile-label">Name:</span>
                        @user.DisplayName
                    </div>
                    <div class="list-item email-cell">
                        <span class="mobile-label">Email:</span>
                        @user.Email
                    </div>
                    <div class="list-item actions">
                        <a href="/admin/users/edit/@user.Id" class="btn btn-sm">Edit</a>
                        @if (user.Id != _currentUserId)
                        {
                            <button @onclick="() => DeleteUser(user.Id)" class="btn btn-sm btn-danger">Delete</button>
                        }
                        else
                        {
                            <span class="current-user-badge">(Current)</span>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private IReadOnlyList<User>? _users;
    private Guid _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var idClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
        if (idClaim != null && Guid.TryParse(idClaim.Value, out var id))
        {
            _currentUserId = id;
        }

        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        _users = await UserRepository.GetAllAsync();
    }

    private async Task DeleteUser(Guid id)
    {
        if (id == _currentUserId) return;

        var confirm = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this user?");
        
        if (confirm)
        {
            await UserRepository.DeleteAsync(id);
            await LoadUsers();
        }
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Admin/UserList.razor.css
SIZE: 1.41 KB
MODIFIED: 2026-01-01 22:33:51
================================================================================

/* Responsive Table Alternative */
.responsive-user-list {
    display: flex;
    flex-direction: column;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    overflow: hidden;
}

.list-header {
    display: flex;
    background-color: var(--color-bg-alt);
    font-weight: bold;
    padding: 1rem;
    border-bottom: 2px solid var(--color-border);
}

.list-row {
    display: flex;
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
    background-color: var(--color-bg);
}

.list-row:last-child { border-bottom: none; }
.col, .list-item { flex: 1; min-width: 0; }
.actions { text-align: right; flex: 0 0 180px; }

.mobile-label { display: none; font-weight: bold; margin-right: 0.5rem; }
.current-user-badge { color: var(--color-text-muted); font-size: 0.85rem; }

/* Mobile view: Stack columns into rows */
@media (max-width: 768px) {
    .d-none-mobile { display: none; }
    
    .list-row {
        flex-direction: column;
        gap: 0.5rem;
        padding: 1.5rem 1rem;
    }

    .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: left;
    }

    .mobile-label { display: inline-block; }
    .actions { 
        flex: 1; 
        margin-top: 1rem; 
        padding-top: 1rem; 
        border-top: 1px dashed var(--color-border);
        text-align: left;
        justify-content: flex-start;
        gap: 10px;
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Home.razor
SIZE: 1.20 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

@page "/"
@inject IPostRepository PostRepository
@inject IConfiguration Configuration

<PageTitle>@(Configuration["Application:Title"] ?? "MyBlog")</PageTitle>

<h1>Welcome to @(Configuration["Application:Title"] ?? "MyBlog")</h1>

@if (_posts is null)
{
    <p>Loading...</p>
}
else if (_posts.Count == 0)
{
    <p>No posts yet. Check back soon!</p>
}
else
{
    <div class="post-list">
        @foreach (var post in _posts)
        {
            <PostCard Post="post" />
        }
    </div>

    <Pagination CurrentPage="_currentPage" TotalPages="_totalPages" BaseUrl="/" />
}

@code {
    private IReadOnlyList<PostListItemDto>? _posts;
    private int _currentPage = 1;
    private int _totalPages = 1;

    [SupplyParameterFromQuery(Name = "page")]
    public int? Page { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        _currentPage = Page ?? 1;
        if (_currentPage < 1) _currentPage = 1;

        var pageSize = Configuration.GetValue("Application:PostsPerPage", 10);
        var (posts, totalCount) = await PostRepository.GetPublishedPostsAsync(_currentPage, pageSize);
        
        _posts = posts;
        _totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Login.razor
SIZE: 1.25 KB
MODIFIED: 2026-01-26 20:32:23
================================================================================

@page "/login"
@inject NavigationManager Navigation

<PageTitle>Login</PageTitle>

<div class="login-page">
    <h1>Login</h1>

    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="error-message">@_error</div>
    }

    <form method="post" action="/account/login" data-enhance="false">
        <AntiforgeryToken />
        <input type="hidden" name="returnUrl" value="@ReturnUrl" />

        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required />
        </div>

        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required />
        </div>

        <button type="submit" class="btn btn-primary">Login</button>
    </form>
</div>

@code {
    private string? _error;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery(Name = "error")]
    public string? Error { get; set; }

    protected override void OnInitialized()
    {
        _error = Error switch
        {
            "required" => "Username and password are required",
            "invalid" => "Invalid username or password",
            _ => null
        };
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/Login.razor.css
SIZE: .10 KB
MODIFIED: 2026-01-26 08:40:52
================================================================================

/* Login.razor.css - Component-scoped styles */

.login-page {
    max-width: 400px;
    margin: 0 auto;
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/PostDetail.razor
SIZE: 6.38 KB
MODIFIED: 2026-01-23 09:34:06
================================================================================

@page "/post/{Slug}"
@using System.Text.RegularExpressions
@inject IPostRepository PostRepository
@inject NavigationManager Navigation
@inject IConfiguration Configuration

@if (_post is null)
{
    @if (_notFound)
    {
        <PageTitle>Not Found</PageTitle>
        <h1>Post Not Found</h1>
        <p>The post you're looking for doesn't exist.</p>
        <a href="/">← Back to Home</a>
    }
    else
    {
        <p>Loading...</p>
    }
}
else
{
    @* --- 1. Browser Tab Title --- *@
    <PageTitle>@_post.Title</PageTitle>

    @* --- 2. SEO & Social Metadata (Injected into <head>) --- *@
    <HeadContent>
        @* Standard SEO *@
        <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
        <meta name="description" content="@_post.Summary" />
        <meta name="author" content="@_post.AuthorDisplayName" />
        <link rel="canonical" href="@_currentUrl" />

        @* Open Graph / Facebook / LinkedIn *@
        <meta property="og:type" content="article" />
        <meta property="og:site_name" content="@(Configuration["Application:Title"] ?? "MyBlog")" />
        <meta property="og:title" content="@_post.Title" />
        <meta property="og:description" content="@_post.Summary" />
        <meta property="og:url" content="@_currentUrl" />
        @if (_post.PublishedAtUtc.HasValue)
        {
            <meta property="article:published_time" content="@_post.PublishedAtUtc.Value.ToString("O")" />
        }
        <meta property="article:modified_time" content="@_post.UpdatedAtUtc.ToString("O")" />

        @if (!string.IsNullOrEmpty(_previewImage))
        {
            <meta property="og:image" content="@_previewImage" />
            <meta property="og:image:alt" content="@_post.Title" />
        }

        @* Twitter Cards *@
        <meta name="twitter:card" content="@(string.IsNullOrEmpty(_previewImage) ? "summary" : "summary_large_image")" />
        <meta name="twitter:title" content="@_post.Title" />
        <meta name="twitter:description" content="@_post.Summary" />
        @if (!string.IsNullOrEmpty(_previewImage))
        {
            <meta name="twitter:image" content="@_previewImage" />
        }

        @* JSON-LD Structured Data *@
        <script type="application/ld+json">
            @((MarkupString)GetJsonLd())
        </script>
    </HeadContent>

    @* --- 3. Visible Page Content --- *@
    <article class="post-detail">
        <header class="post-header">
            <h1>@_post.Title</h1>
            <div class="post-meta">
                <span class="author">By @_post.AuthorDisplayName</span>
                @if (_post.PublishedAtUtc.HasValue)
                {
                    <span class="date">Published @_post.PublishedAtUtc.Value.ToString("MMMM d, yyyy")</span>
                }

                @* Real-time Reader Badge *@
                <ReaderBadge Slug="@Slug" />

                @* Social Share Button (Visible UI) *@
                <button type="button" class="btn-link share-btn" data-title="@_post.Title" onclick="sharePost(this.dataset.title)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    Share
                </button>
            </div>
        </header>

        <div class="post-content">
            <MarkdownRenderer Content="@_post.Content" />
        </div>
    </article>

    <a href="/" class="back-link">← Back to Home</a>
}

@code {
    [Parameter]
    public string Slug { get; set; } = "";

    private PostDetailDto? _post;
    private bool _notFound;
    private string _currentUrl = "";
    private string? _previewImage;

    private string GetJsonLd()
    {
        if (_post is null) return "";

        var schema = new Dictionary<string, object?>
        {
            { "@context", "https://schema.org" },
            { "@type", "BlogPosting" },
            { "headline", _post.Title },
            { "description", _post.Summary },
            { "author", new Dictionary<string, object?> {
                { "@type", "Person" },
                { "name", _post.AuthorDisplayName }
            }},
            { "publisher", new Dictionary<string, object?> {
                { "@type", "Organization" },
                { "name", Configuration["Application:Title"] ?? "MyBlog" }
            }},
            { "datePublished", _post.PublishedAtUtc?.ToString("O") },
            { "dateModified", _post.UpdatedAtUtc.ToString("O") },
            { "mainEntityOfPage", new Dictionary<string, object?> {
                { "@type", "WebPage" },
                { "@id", _currentUrl }
            }}
        };

        if (!string.IsNullOrEmpty(_previewImage))
        {
            schema["image"] = _previewImage;
        }

        return System.Text.Json.JsonSerializer.Serialize(schema);
    }

    protected override async Task OnParametersSetAsync()
    {
        // 1. Load Data
        _post = await PostRepository.GetBySlugAsync(Slug);
        _notFound = _post is null;

        // 2. Validate visibility
        if (_post is not null && !_post.IsPublished)
        {
            _post = null;
            _notFound = true;
        }

        // 3. Prepare Metadata
        if (_post is not null)
        {
            // Get Absolute URL for Canonical/OG tags
            _currentUrl = Navigation.Uri;

            // Extract the first image from Markdown to use as the preview image
            // Regex matches: ![alt](url)
            var imageMatch = Regex.Match(_post.Content, @"!\[.*?\]\((.*?)\)");
            if (imageMatch.Success)
            {
                var url = imageMatch.Groups[1].Value;
                // If it's a relative URL (like /api/images/...), make it absolute
                if (url.StartsWith("/"))
                {
                    _previewImage = Navigation.ToAbsoluteUri(url).ToString();
                }
                else
                {
                    _previewImage = url;
                }
            }
        }
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Pages/PostDetail.razor.css
SIZE: .55 KB
MODIFIED: 2026-01-19 20:24:14
================================================================================

/* PostDetail.razor.css */

.share-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    /* Reset button styles if not already handled by btn-link */
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
}

.share-btn:hover {
    color: var(--color-primary);
    text-decoration: underline;
}

.share-btn svg {
    margin-top: -2px; /* Fine-tune icon alignment */
}

.share-btn.success {
    color: var(--color-success);
}

article {
    word-break: break-word;
}


================================================================================
FILE: src/MyBlog.Web/Components/Routes.razor
SIZE: .83 KB
MODIFIED: 2026-01-26 06:25:15
================================================================================

<Router AppAssembly="typeof(Program).Assembly">
    <Found Context="routeData">
        <AuthorizeRouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)">
            <NotAuthorized>
                @if (context.User.Identity?.IsAuthenticated != true)
                {
                    <RedirectToLogin />
                }
                else
                {
                    <p role="alert">You are not authorized to access this resource.</p>
                }
            </NotAuthorized>
        </AuthorizeRouteView>
        <FocusOnNavigate RouteData="routeData" Selector="h1" />
    </Found>
    <NotFound>
        <LayoutView Layout="typeof(Layout.MainLayout)">
            <h1>Page Not Found</h1>
            <p>Sorry, the page you requested could not be found.</p>
        </LayoutView>
    </NotFound>
</Router>


================================================================================
FILE: src/MyBlog.Web/Components/Shared/Footer.razor
SIZE: 1.43 KB
MODIFIED: 2026-01-13 20:54:07
================================================================================

@inject IConfiguration Configuration

<footer class="footer">
    <div class="container">
        <p>&copy; @DateTime.Now.Year @(Configuration["Application:Title"] ?? "MyBlog")</p>

        @{
            var gitUrl = Configuration["Application:GitForgeUrl"];
            if (!string.IsNullOrWhiteSpace(gitUrl) &&
                Uri.TryCreate(gitUrl, UriKind.Absolute, out var validatedUri) &&
                (validatedUri.Scheme == Uri.UriSchemeHttp || validatedUri.Scheme == Uri.UriSchemeHttps))
            {
                <a href="@gitUrl" target="_blank" rel="noopener noreferrer" class="footer-link">
                    <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                        <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path>
                    </svg>
                    <span>Source Code</span>
                </a>
            }
        }
    </div>
</footer>


================================================================================
FILE: src/MyBlog.Web/Components/Shared/Footer.razor.css
SIZE: .61 KB
MODIFIED: 2026-01-13 20:55:51
================================================================================

/* Note: You can still use the variables defined in site.css :root here! */

.footer {
    background-color: var(--color-bg-alt);
    border-top: 1px solid var(--color-border);
    padding: var(--spacing) 0;
    text-align: center;
    color: var(--color-text-muted);
}

.footer-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 0.5rem;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color 0.2s ease;
}

.footer-link:hover {
    color: var(--color-primary);
    text-decoration: underline;
}

.footer-link svg {
    flex-shrink: 0;
}


================================================================================
FILE: src/MyBlog.Web/Components/Shared/MarkdownRenderer.razor
SIZE: .38 KB
MODIFIED: 2026-01-16 21:47:57
================================================================================

@using MyBlog.Core.Interfaces
@inject IMarkdownService MarkdownService

<div class="markdown-content">
    @((MarkupString)_htmlContent)
</div>

@code {
    [Parameter]
    public string? Content { get; set; }

    private string _htmlContent = "";

    protected override async Task OnParametersSetAsync()
    {
        _htmlContent = await MarkdownService.ToHtmlAsync(Content ?? "");
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Shared/Pagination.razor
SIZE: .76 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

@if (TotalPages > 1)
{
    <nav class="pagination" aria-label="Page navigation">
        @if (CurrentPage > 1)
        {
            <a href="@GetPageUrl(CurrentPage - 1)" class="page-link">← Previous</a>
        }
        
        <span class="page-info">Page @CurrentPage of @TotalPages</span>
        
        @if (CurrentPage < TotalPages)
        {
            <a href="@GetPageUrl(CurrentPage + 1)" class="page-link">Next →</a>
        }
    </nav>
}

@code {
    [Parameter, EditorRequired]
    public int CurrentPage { get; set; }

    [Parameter, EditorRequired]
    public int TotalPages { get; set; }

    [Parameter]
    public string BaseUrl { get; set; } = "/";

    private string GetPageUrl(int page) =>
        page == 1 ? BaseUrl : $"{BaseUrl}?page={page}";
}


================================================================================
FILE: src/MyBlog.Web/Components/Shared/PostCard.razor
SIZE: .69 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

<article class="post-card">
    <h2 class="post-card-title">
        <a href="/post/@Post.Slug">@Post.Title</a>
    </h2>
    <div class="post-card-meta">
        <span class="author">By @Post.AuthorDisplayName</span>
        @if (Post.PublishedAtUtc.HasValue)
        {
            <span class="date">@Post.PublishedAtUtc.Value.ToString("MMMM d, yyyy")</span>
        }
        @if (!Post.IsPublished)
        {
            <span class="draft-badge">Draft</span>
        }
    </div>
    <p class="post-card-summary">@Post.Summary</p>
    <a href="/post/@Post.Slug" class="read-more">Read more →</a>
</article>

@code {
    [Parameter, EditorRequired]
    public PostListItemDto Post { get; set; } = default!;
}


================================================================================
FILE: src/MyBlog.Web/Components/Shared/PostCard.razor.css
SIZE: .03 KB
MODIFIED: 2026-01-19 20:24:56
================================================================================

article {
    word-break: break-word;
}


================================================================================
FILE: src/MyBlog.Web/Components/Shared/ReaderBadge.razor
SIZE: 1.94 KB
MODIFIED: 2026-01-16 20:40:44
================================================================================

@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Navigation
@implements IAsyncDisposable

<div class="reader-badge" title="Active readers on this post. Share this post to increase this number!">
    <span class="reader-dot">●</span>
    <span>@_count @(_count == 1 ? "person" : "people") reading now.</span>
</div>

@code {
    [Parameter, EditorRequired]
    public string Slug { get; set; } = "";

    private HubConnection? _hubConnection;
    private int _count;

    protected override async Task OnInitializedAsync()
    {
        // Create the connection
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/readerHub"))
            .WithAutomaticReconnect()
            .Build();

        // Register the listener BEFORE starting the connection
        _hubConnection.On<int>("UpdateCount", (newCount) =>
        {
            _count = newCount;
            InvokeAsync(StateHasChanged);
        });

        try
        {
            // Start connection
            await _hubConnection.StartAsync();

            // Tell the server we are viewing this specific slug
            if (!string.IsNullOrEmpty(Slug))
            {
                await _hubConnection.InvokeAsync("JoinPage", Slug);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error connecting to ReaderHub: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            if (!string.IsNullOrEmpty(Slug) && _hubConnection.State == HubConnectionState.Connected)
            {
                // Gracefully leave the page if possible
                try
                {
                    await _hubConnection.InvokeAsync("LeavePage", Slug);
                }
                catch { /* Connection might be closed already, ignore */ }
            }

            await _hubConnection.DisposeAsync();
        }
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Shared/ReaderBadge.razor.css
SIZE: .52 KB
MODIFIED: 2026-01-13 21:06:07
================================================================================

/* Reader Badge */
.reader-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    background-color: var(--color-bg-alt);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius);
    border: 1px solid var(--color-border);
}

.reader-dot {
    color: var(--color-success);
    font-size: 1.2em;
    line-height: 0.5;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.4; }
    100% { opacity: 1; }
}


================================================================================
FILE: src/MyBlog.Web/Components/Shared/RedirectToLogin.razor
SIZE: .20 KB
MODIFIED: 2025-12-28 08:44:06
================================================================================

@inject NavigationManager Navigation

@code {
    protected override void OnInitialized()
    {
        Navigation.NavigateTo($"/login?returnUrl={Uri.EscapeDataString(Navigation.Uri)}", forceLoad: true);
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Shared/ThemeSwitcher.razor
SIZE: 4.11 KB
MODIFIED: 2026-01-26 06:37:10
================================================================================

@implements IDisposable
@inject IJSRuntime JS
@inject ILogger<ThemeSwitcher> Logger

<div class="theme-switcher">
    <button class="theme-switcher-btn"
            @onclick="ToggleMenu"
            @onclick:stopPropagation="true"
            aria-label="Change theme"
            aria-expanded="@_isOpen"
            aria-haspopup="true"
            title="Change theme">
        @* Sun/Moon icon that adapts to current theme *@
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            @if (IsDarkTheme(_currentTheme))
            {
                @* Moon icon for dark themes *@
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            }
            else
            {
                @* Sun icon for light themes *@
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            }
        </svg>
    </button>

    <div class="theme-menu @(_isOpen ? "open" : "")" role="menu" aria-label="Theme options">
        @foreach (var theme in Themes)
        {
            <button class="theme-option @(theme.Id == _currentTheme ? "active" : "")"
                    @onclick="() => SelectThemeAsync(theme.Id)"
                    @onclick:stopPropagation="true"
                    role="menuitem"
                    aria-current="@(theme.Id == _currentTheme ? "true" : null)">
                <span class="theme-preview theme-preview-@theme.Id" aria-hidden="true"></span>
                <span>@theme.Name</span>
            </button>
        }
    </div>
</div>

@code {
    private bool _isOpen;
    private string _currentTheme = "light";
    private DotNetObjectReference<ThemeSwitcher>? _objRef;
    private bool _initialized;

    private record ThemeOption(string Id, string Name, bool IsDark);

    private static readonly ThemeOption[] Themes =
    [
        new("light", "Light", false),
        new("dark", "Dark", true),
        new("sepia", "Sepia", false),
        new("nord", "Nord", true),
        new("solarized-light", "Solarized Light", false),
        new("dracula", "Dracula", true)
    ];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_initialized)
        {
            _initialized = true;
            _objRef = DotNetObjectReference.Create(this);

            try
            {
                // Initialize theme from localStorage or system preference
                _currentTheme = await JS.InvokeAsync<string>("themeManager.init", _objRef);

                // Register click outside handler
                await JS.InvokeVoidAsync("themeManager.registerClickOutside", _objRef);

                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Theme initialization error");
            }
        }
    }

    private void ToggleMenu()
    {
        _isOpen = !_isOpen;
    }

    [JSInvokable]
    public void CloseMenu()
    {
        if (_isOpen)
        {
            _isOpen = false;
            StateHasChanged();
        }
    }

    private async Task SelectThemeAsync(string themeId)
    {
        _currentTheme = themeId;
        _isOpen = false;

        try
        {
            await JS.InvokeVoidAsync("themeManager.setTheme", themeId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Theme selection error: {ex.Message}");
        }
    }

    private static bool IsDarkTheme(string themeId)
    {
        return themeId is "dark" or "nord" or "dracula";
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }
}


================================================================================
FILE: src/MyBlog.Web/Components/Shared/ThemeSwitcher.razor.css
SIZE: 3.20 KB
MODIFIED: 2026-01-26 05:45:13
================================================================================

/* ThemeSwitcher.razor.css - Component-scoped styles */

.theme-switcher {
    position: relative;
    display: inline-block;
}

.theme-switcher-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    padding: 0;
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: 50%;
    color: var(--color-text);
    cursor: pointer;
    transition: all 150ms ease;
}

.theme-switcher-btn:hover {
    background-color: var(--color-bg-elevated);
    border-color: var(--color-primary-muted);
    color: var(--color-primary);
}

.theme-switcher-btn:focus-visible {
    outline: 2px solid var(--color-focus-ring);
    outline-offset: 2px;
}

.theme-switcher-btn svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

.theme-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    min-width: 180px;
    background-color: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    box-shadow: 0 8px 24px var(--color-shadow);
    padding: 0.5rem;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 150ms ease;
}

.theme-menu.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.theme-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.625rem 0.75rem;
    background: none;
    border: none;
    border-radius: 0.375rem;
    color: var(--color-text);
    cursor: pointer;
    font: inherit;
    font-size: 0.9rem;
    text-align: left;
    transition: background-color 150ms ease;
}

.theme-option:hover {
    background-color: var(--color-bg-alt);
}

.theme-option:focus-visible {
    outline: 2px solid var(--color-focus-ring);
    outline-offset: -2px;
}

.theme-option.active {
    background-color: var(--color-primary);
    color: white;
}

.theme-option .theme-preview {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid var(--color-border);
    flex-shrink: 0;
}

.theme-option.active .theme-preview {
    border-color: rgba(255, 255, 255, 0.5);
}

/* Theme preview color swatches */
.theme-preview-light {
    background: linear-gradient(135deg, #ffffff 50%, #2563eb 50%);
}

.theme-preview-dark {
    background: linear-gradient(135deg, #0f172a 50%, #60a5fa 50%);
}

.theme-preview-sepia {
    background: linear-gradient(135deg, #faf6f1 50%, #a0522d 50%);
}

.theme-preview-nord {
    background: linear-gradient(135deg, #2e3440 50%, #88c0d0 50%);
}

.theme-preview-solarized-light {
    background: linear-gradient(135deg, #fdf6e3 50%, #268bd2 50%);
}

.theme-preview-dracula {
    background: linear-gradient(135deg, #282a36 50%, #bd93f9 50%);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .theme-menu {
        right: -20px;
        min-width: 160px;
    }
}

@media (max-width: 480px) {
    .theme-menu {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        border-radius: 1rem 1rem 0 0;
        padding: 1rem;
        transform: translateY(100%);
    }

    .theme-menu.open {
        transform: translateY(0);
    }

    .theme-option {
        padding: 1rem;
    }
}


================================================================================
FILE: src/MyBlog.Web/Dockerfile
SIZE: 1.37 KB
MODIFIED: 2026-01-26 11:06:02
================================================================================

# Build stage
FROM mcr.microsoft.com/dotnet/sdk:10.0 AS build
WORKDIR /src

# Copy project files first for better layer caching
COPY Directory.Build.props .
COPY Directory.Packages.props .
COPY MyBlog.Core/MyBlog.Core.csproj MyBlog.Core/
COPY MyBlog.Infrastructure/MyBlog.Infrastructure.csproj MyBlog.Infrastructure/
COPY MyBlog.Web/MyBlog.Web.csproj MyBlog.Web/

# Restore dependencies
RUN dotnet restore MyBlog.Web/MyBlog.Web.csproj

# Copy source code
COPY MyBlog.Core/ MyBlog.Core/
COPY MyBlog.Infrastructure/ MyBlog.Infrastructure/
COPY MyBlog.Web/ MyBlog.Web/

# Build and publish (without --no-restore to ensure all deps are available)
RUN dotnet publish MyBlog.Web/MyBlog.Web.csproj -c Release -o /app/publish

# Runtime stage
FROM mcr.microsoft.com/dotnet/aspnet:10.0 AS runtime
WORKDIR /app

# Install curl for health checks
RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*

# Create non-root user for security
RUN useradd -m -s /bin/bash appuser

# Create data directory for SQLite
RUN mkdir -p /app/data && chown appuser:appuser /app/data

COPY --from=build /app/publish .

# Set environment variables
ENV ASPNETCORE_URLS=http://+:5000
ENV ASPNETCORE_ENVIRONMENT=Production
ENV ConnectionStrings__DefaultConnection="Data Source=/app/data/myblog.db"

# Switch to non-root user
USER appuser

EXPOSE 5000

ENTRYPOINT ["dotnet", "MyBlog.Web.dll"]


================================================================================
FILE: src/MyBlog.Web/Hubs/ReaderHub.cs
SIZE: 1.39 KB
MODIFIED: 2026-01-16 20:30:48
================================================================================

using Microsoft.AspNetCore.SignalR;
using MyBlog.Core.Interfaces;

namespace MyBlog.Web.Hubs;

public class ReaderHub : Hub
{
    private readonly IReaderTrackingService _trackingService;

    public ReaderHub(IReaderTrackingService trackingService)
    {
        _trackingService = trackingService;
    }

    public async Task JoinPage(string slug)
    {
        // Add this connection to the SignalR group for this slug
        await Groups.AddToGroupAsync(Context.ConnectionId, slug);

        // Update state
        var newCount = _trackingService.JoinPost(slug, Context.ConnectionId);

        // Broadcast new count to everyone in this group
        await Clients.Group(slug).SendAsync("UpdateCount", newCount);
    }

    public async Task LeavePage(string slug)
    {
        await Groups.RemoveFromGroupAsync(Context.ConnectionId, slug);

        var newCount = _trackingService.LeavePost(slug, Context.ConnectionId);

        await Clients.Group(slug).SendAsync("UpdateCount", newCount);
    }

    public override async Task OnDisconnectedAsync(Exception? exception)
    {
        // Handle abrupt disconnects (tab closed, network lost)
        var (slug, newCount) = _trackingService.Disconnect(Context.ConnectionId);

        if (!string.IsNullOrEmpty(slug))
        {
            await Clients.Group(slug).SendAsync("UpdateCount", newCount);
        }

        await base.OnDisconnectedAsync(exception);
    }
}


================================================================================
FILE: src/MyBlog.Web/Middleware/LoginRateLimitMiddleware.cs
SIZE: 5.66 KB
MODIFIED: 2026-01-26 20:32:55
================================================================================

using System.Collections.Concurrent;

namespace MyBlog.Web.Middleware;

/// <summary>
/// Rate limiting middleware for login attempts.
/// Slows down requests but NEVER blocks users completely.
/// </summary>
public sealed class LoginRateLimitMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<LoginRateLimitMiddleware> _logger;
    private readonly Func<TimeSpan, CancellationToken, Task>? _delayFunc;

    // Track attempts per IP: IP -> (attempt count, window start)
    private static readonly ConcurrentDictionary<string, (int Count, DateTime WindowStart)> Attempts = new();
    // Configuration
    private const int WindowMinutes = 15;
    private const int AttemptsBeforeDelay = 5;
    private const int MaxDelaySeconds = 30;

    // Use this for the standard DI activation
    [ActivatorUtilitiesConstructor]
    public LoginRateLimitMiddleware(RequestDelegate next, ILogger<LoginRateLimitMiddleware> logger)
        : this(next, logger, null)
    {
    }

    /// <summary>
    /// Constructor with injectable delay function for testing.
    /// </summary>
    public LoginRateLimitMiddleware(
        RequestDelegate next,
        ILogger<LoginRateLimitMiddleware> logger,
        Func<TimeSpan, CancellationToken, Task>? delayFunc)
    {
        _next = next;
        _logger = logger;
        _delayFunc = delayFunc;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        // Only rate limit POST requests to login endpoint
        if (!IsLoginPostRequest(context))
        {
            await _next(context);
            return;
        }

        var ip = GetClientIp(context);
        var delay = CalculateDelay(ip);
        if (delay > TimeSpan.Zero)
        {
            _logger.LogInformation(
                "Rate limiting login attempt from {IP}, delaying {Seconds}s",
                ip, delay.TotalSeconds);
            // Use injected delay function if available (for testing), otherwise real delay
            if (_delayFunc != null)
            {
                await _delayFunc(delay, context.RequestAborted);
            }
            else
            {
                await Task.Delay(delay, context.RequestAborted);
            }
        }

        // Always proceed - never block
        await _next(context);
        // Record the attempt after processing
        RecordAttempt(ip);
    }

    private static bool IsLoginPostRequest(HttpContext context)
    {
        return context.Request.Method == HttpMethods.Post &&
               context.Request.Path.StartsWithSegments("/account/login", StringComparison.OrdinalIgnoreCase);
    }

    private static string GetClientIp(HttpContext context)
    {
        // Check for forwarded IP (behind proxy/load balancer)
        var forwardedFor = context.Request.Headers["X-Forwarded-For"].FirstOrDefault();
        if (!string.IsNullOrEmpty(forwardedFor))
        {
            var ip = forwardedFor.Split(',')[0].Trim();
            if (!string.IsNullOrEmpty(ip))
            {
                return ip;
            }
        }

        return context.Connection.RemoteIpAddress?.ToString() ?? "unknown";
    }

    /// <summary>
    /// Calculates the delay for a given IP. Exposed for testing.
    /// </summary>
    public static TimeSpan CalculateDelay(string ip)
    {
        if (!Attempts.TryGetValue(ip, out var record))
        {
            return TimeSpan.Zero;
        }

        // Reset if window expired
        if (DateTime.UtcNow - record.WindowStart > TimeSpan.FromMinutes(WindowMinutes))
        {
            Attempts.TryRemove(ip, out _);
            return TimeSpan.Zero;
        }

        // No delay for first few attempts
        if (record.Count < AttemptsBeforeDelay)
        {
            return TimeSpan.Zero;
        }

        // Progressive delay: 1s, 2s, 4s, 8s, ... capped at MaxDelaySeconds
        var delayMultiplier = record.Count - AttemptsBeforeDelay;
        var delaySeconds = Math.Min(Math.Pow(2, delayMultiplier), MaxDelaySeconds);
        return TimeSpan.FromSeconds(delaySeconds);
    }

    /// <summary>
    /// Records a login attempt for the given IP.
    /// Exposed for testing.
    /// </summary>
    internal static void RecordAttempt(string ip)
    {
        var now = DateTime.UtcNow;
        Attempts.AddOrUpdate(
            ip,
            _ => (1, now),
            (_, existing) =>
            {
                // Reset window if expired
                if (now - existing.WindowStart > TimeSpan.FromMinutes(WindowMinutes))
                {
                    return (1, now);
                }
                return (existing.Count + 1, existing.WindowStart);
            });
        // Cleanup old entries periodically (every 100th request)
        if (Random.Shared.Next(100) == 0)
        {
            CleanupOldEntries();
        }
    }

    /// <summary>
    /// Clears all tracked attempts.
    /// For testing only.
    /// </summary>
    public static void ClearAttempts()
    {
        Attempts.Clear();
    }

    private static void CleanupOldEntries()
    {
        var cutoff = DateTime.UtcNow.AddMinutes(-WindowMinutes * 2);
        foreach (var kvp in Attempts)
        {
            if (kvp.Value.WindowStart < cutoff)
            {
                Attempts.TryRemove(kvp.Key, out _);
            }
        }
    }
}

/// <summary>
/// Extension methods for LoginRateLimitMiddleware.
/// </summary>
public static class LoginRateLimitMiddlewareExtensions
{
    /// <summary>
    /// Adds login rate limiting middleware that slows down repeated attempts
    /// but never completely blocks users.
    /// </summary>
    public static IApplicationBuilder UseLoginRateLimit(this IApplicationBuilder app)
    {
        return app.UseMiddleware<LoginRateLimitMiddleware>();
    }
}


================================================================================
FILE: src/MyBlog.Web/MyBlog.Web.csproj
SIZE: .62 KB
MODIFIED: 2026-01-16 20:29:40
================================================================================

<Project Sdk="Microsoft.NET.Sdk.Web">
  <PropertyGroup>
    <RootNamespace>MyBlog.Web</RootNamespace>
  </PropertyGroup>
  
  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.SignalR.Client" />
    <PackageReference Include="OpenTelemetry.Extensions.Hosting" />
    <PackageReference Include="OpenTelemetry.Instrumentation.AspNetCore" />
    <PackageReference Include="OpenTelemetry.Exporter.Console" />
    <PackageReference Include="OpenTelemetry.Instrumentation.Http" />
  </ItemGroup>
  
  <ItemGroup>
    <ProjectReference Include="..\MyBlog.Infrastructure\MyBlog.Infrastructure.csproj" />
  </ItemGroup>
</Project>

================================================================================
FILE: src/MyBlog.Web/Program.cs
SIZE: 5.35 KB
MODIFIED: 2026-01-26 20:32:10
================================================================================

using System.Security.Claims;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.EntityFrameworkCore;
using MyBlog.Core.Constants;
using MyBlog.Core.Interfaces;
using MyBlog.Infrastructure;
using MyBlog.Infrastructure.Data;
using MyBlog.Infrastructure.Telemetry;
using MyBlog.Web.Components;
using MyBlog.Web.Hubs;
using MyBlog.Web.Middleware;
using OpenTelemetry;
using OpenTelemetry.Logs;
using OpenTelemetry.Metrics;
using OpenTelemetry.Resources;
using OpenTelemetry.Trace;

var builder = WebApplication.CreateBuilder(args);
// Add services
builder.Services.AddRazorComponents()
    .AddInteractiveServerComponents();

// Register SignalR
builder.Services.AddSignalR();

builder.Services.AddInfrastructure(builder.Configuration);

// Configure authentication
var sessionTimeout = builder.Configuration.GetValue("Authentication:SessionTimeoutMinutes", 30);
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.Cookie.Name = AppConstants.AuthCookieName;
        options.LoginPath = "/login";
        options.LogoutPath = "/logout";
        options.AccessDeniedPath = "/access-denied";
        options.ExpireTimeSpan = TimeSpan.FromMinutes(sessionTimeout);
        options.SlidingExpiration = true;
        options.Cookie.HttpOnly = true;
        options.Cookie.SecurePolicy = builder.Configuration.GetValue("Application:RequireHttps", false)
            ? CookieSecurePolicy.Always
            : CookieSecurePolicy.SameAsRequest;
    });
builder.Services.AddAuthorization();
builder.Services.AddCascadingAuthenticationState();
builder.Services.AddHttpContextAccessor();

// Configure OpenTelemetry
var serviceName = "MyBlog";
var serviceVersion = typeof(Program).Assembly.GetName().Version?.ToString() ?? "1.0.0";
builder.Services.AddOpenTelemetry()
    .ConfigureResource(resource => resource.AddService(serviceName, serviceVersion))
    .WithTracing(tracing => tracing
        .AddAspNetCoreInstrumentation()
        .AddHttpClientInstrumentation()
        .AddConsoleExporter())
    .WithMetrics(metrics => metrics
        .AddAspNetCoreInstrumentation()
        .AddHttpClientInstrumentation()
        .AddConsoleExporter());
// Configure logging with OpenTelemetry
builder.Logging.AddOpenTelemetry(logging =>
{
    logging.IncludeFormattedMessage = true;
    logging.IncludeScopes = true;
    logging.AddConsoleExporter();
});
var app = builder.Build();

// Configure the HTTP request pipeline
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
}

app.UseStaticFiles();
// Rate limiting for login attempts
app.UseLoginRateLimit();

app.UseRouting();

app.UseAuthentication();
app.UseAuthorization();

app.UseAntiforgery();
// Minimal API endpoints
app.MapPost("/account/login", async (HttpContext context, IAuthService authService) =>
{
    var form = await context.Request.ReadFormAsync();
    var username = form["username"].ToString();
    var password = form["password"].ToString();
    var returnUrl = form["returnUrl"].ToString();

    if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
    {
        return Results.Redirect($"/login?error=required&returnUrl={Uri.EscapeDataString(returnUrl ?? "")}");
    }

    var user = await authService.AuthenticateAsync(username, password);
    if (user is null)
    {
        return Results.Redirect($"/login?error=invalid&returnUrl={Uri.EscapeDataString(returnUrl ?? "")}");
    }

    var claims = new List<Claim>
    {
        new(ClaimTypes.NameIdentifier, user.Id.ToString()),
        new(ClaimTypes.Name, user.Username),
        new("DisplayName", user.DisplayName),
        new(ClaimTypes.Role, AppConstants.AdminRole)
    };

    var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
    var principal = new ClaimsPrincipal(identity);

    await context.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);

    return Results.Redirect(string.IsNullOrWhiteSpace(returnUrl) ? "/admin" : returnUrl);
});
app.MapPost("/logout", async (HttpContext context) =>
{
    await context.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
    return Results.Redirect("/");
}).RequireAuthorization();
app.MapGet("/api/images/{id:guid}", async (Guid id, IImageRepository imageRepository) =>
{
    var image = await imageRepository.GetByIdAsync(id);
    if (image is null)
    {
        return Results.NotFound();
    }
    return Results.File(image.Data, image.ContentType);
});
app.MapRazorComponents<App>()
    .AddInteractiveServerRenderMode();

app.MapHub<ReaderHub>("/readerHub");

// Initialize database and ensure admin user
using (var scope = app.Services.CreateScope())
{
    var context = scope.ServiceProvider.GetRequiredService<BlogDbContext>();
    // EnsureCreated creates the database and all tables if they don't exist
    await context.Database.EnsureCreatedAsync();
    // Apply any incremental schema updates for existing databases
    await DatabaseSchemaUpdater.ApplyUpdatesAsync(context);

    var authService = scope.ServiceProvider.GetRequiredService<IAuthService>();
    await authService.EnsureAdminUserAsync();
    // Register telemetry exporters with the service provider
    var logExporter = scope.ServiceProvider.GetService<FileLogExporter>();
    var dbExporter = scope.ServiceProvider.GetService<DatabaseLogExporter>();
}

app.Run();


================================================================================
FILE: src/MyBlog.Web/Properties/launchSettings.json
SIZE: .26 KB
MODIFIED: 2026-01-21 11:47:46
================================================================================

{
  "profiles": {
    "MyBlog.Web": {
      "commandName": "Project",
      "launchBrowser": true,
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      },
      "applicationUrl": "https://localhost:51226;http://localhost:51227"
    }
  }
}


================================================================================
FILE: src/MyBlog.Web/wwwroot/css/site.css
SIZE: 21.43 KB
MODIFIED: 2026-01-26 08:40:30
================================================================================

/* =============================================================================
   MyBlog CSS - Multi-Theme System with Accessibility
   All themes meet WCAG AA contrast requirements (4.5:1 for text, 3:1 for UI)
   ============================================================================= */

/* =============================================================================
   Theme 1: Light (Default) - Clean and professional
   ============================================================================= */
:root,
[data-theme="light"] {
    --color-bg: #ffffff;
    --color-bg-alt: #f8f9fa;
    --color-bg-elevated: #ffffff;
    --color-text: #1a1a2e;
    --color-text-muted: #5a5a6e;
    --color-primary: #2563eb;
    --color-primary-hover: #1d4ed8;
    --color-primary-muted: #3b82f6;
    --color-border: #e2e8f0;
    --color-border-light: #cbd5e1;
    --color-danger: #dc2626;
    --color-danger-hover: #b91c1c;
    --color-success: #16a34a;
    --color-success-hover: #15803d;
    --color-warning: #f59e0b;
    --color-info: #0ea5e9;
    --color-code-bg: #f1f5f9;
    --color-blockquote-border: #3b82f6;
    --color-selection-bg: #dbeafe;
    --color-selection-text: #1e40af;
    --color-focus-ring: #3b82f6;
    --color-shadow: rgba(0, 0, 0, 0.1);
    --color-overlay: rgba(255, 255, 255, 0.8);
    color-scheme: light;
}

/* =============================================================================
   Theme 2: Dark - Modern dark theme
   ============================================================================= */
[data-theme="dark"] {
    --color-bg: #0f172a;
    --color-bg-alt: #1e293b;
    --color-bg-elevated: #334155;
    --color-text: #f1f5f9;
    --color-text-muted: #94a3b8;
    --color-primary: #60a5fa;
    --color-primary-hover: #93c5fd;
    --color-primary-muted: #3b82f6;
    --color-border: #334155;
    --color-border-light: #475569;
    --color-danger: #f87171;
    --color-danger-hover: #fca5a5;
    --color-success: #4ade80;
    --color-success-hover: #86efac;
    --color-warning: #fbbf24;
    --color-info: #38bdf8;
    --color-code-bg: #1e293b;
    --color-blockquote-border: #60a5fa;
    --color-selection-bg: #1e40af;
    --color-selection-text: #dbeafe;
    --color-focus-ring: #60a5fa;
    --color-shadow: rgba(0, 0, 0, 0.3);
    --color-overlay: rgba(15, 23, 42, 0.8);
    color-scheme: dark;
}

/* =============================================================================
   Theme 3: Sepia - Warm, paper-like reading experience
   ============================================================================= */
[data-theme="sepia"] {
    --color-bg: #faf6f1;
    --color-bg-alt: #f5ebe0;
    --color-bg-elevated: #ffffff;
    --color-text: #3d2914;
    --color-text-muted: #6b5344;
    --color-primary: #a0522d;
    --color-primary-hover: #8b4513;
    --color-primary-muted: #cd853f;
    --color-border: #ddd0c1;
    --color-border-light: #c4b5a5;
    --color-danger: #c53030;
    --color-danger-hover: #9c2020;
    --color-success: #2e7d32;
    --color-success-hover: #1b5e20;
    --color-warning: #e65100;
    --color-info: #0277bd;
    --color-code-bg: #f5ebe0;
    --color-blockquote-border: #a0522d;
    --color-selection-bg: #ddd0c1;
    --color-selection-text: #3d2914;
    --color-focus-ring: #a0522d;
    --color-shadow: rgba(61, 41, 20, 0.1);
    --color-overlay: rgba(250, 246, 241, 0.8);
    color-scheme: light;
}

/* =============================================================================
   Theme 4: Nord - Arctic, bluish color palette
   ============================================================================= */
[data-theme="nord"] {
    --color-bg: #2e3440;
    --color-bg-alt: #3b4252;
    --color-bg-elevated: #434c5e;
    --color-text: #eceff4;
    --color-text-muted: #d8dee9;
    --color-primary: #88c0d0;
    --color-primary-hover: #8fbcbb;
    --color-primary-muted: #81a1c1;
    --color-border: #4c566a;
    --color-border-light: #616e88;
    --color-danger: #bf616a;
    --color-danger-hover: #d08770;
    --color-success: #a3be8c;
    --color-success-hover: #b5d19c;
    --color-warning: #ebcb8b;
    --color-info: #5e81ac;
    --color-code-bg: #3b4252;
    --color-blockquote-border: #88c0d0;
    --color-selection-bg: #4c566a;
    --color-selection-text: #eceff4;
    --color-focus-ring: #88c0d0;
    --color-shadow: rgba(0, 0, 0, 0.25);
    --color-overlay: rgba(46, 52, 64, 0.8);
    color-scheme: dark;
}

/* =============================================================================
   Theme 5: Solarized Light - Precision colors for machines and people
   ============================================================================= */
[data-theme="solarized-light"] {
    --color-bg: #fdf6e3;
    --color-bg-alt: #eee8d5;
    --color-bg-elevated: #ffffff;
    --color-text: #657b83;
    --color-text-muted: #93a1a1;
    --color-primary: #268bd2;
    --color-primary-hover: #2176b5;
    --color-primary-muted: #6c9cc4;
    --color-border: #d3cbb7;
    --color-border-light: #bdb8a6;
    --color-danger: #dc322f;
    --color-danger-hover: #cb4b16;
    --color-success: #859900;
    --color-success-hover: #6d8000;
    --color-warning: #b58900;
    --color-info: #2aa198;
    --color-code-bg: #eee8d5;
    --color-blockquote-border: #268bd2;
    --color-selection-bg: #eee8d5;
    --color-selection-text: #586e75;
    --color-focus-ring: #268bd2;
    --color-shadow: rgba(0, 0, 0, 0.1);
    --color-overlay: rgba(253, 246, 227, 0.8);
    color-scheme: light;
}

/* =============================================================================
   Theme 6: Dracula - Dark theme with vibrant colors
   ============================================================================= */
[data-theme="dracula"] {
    --color-bg: #282a36;
    --color-bg-alt: #343746;
    --color-bg-elevated: #44475a;
    --color-text: #f8f8f2;
    --color-text-muted: #bfc9db;
    --color-primary: #bd93f9;
    --color-primary-hover: #caa8fc;
    --color-primary-muted: #9d79d9;
    --color-border: #44475a;
    --color-border-light: #6272a4;
    --color-danger: #ff5555;
    --color-danger-hover: #ff6e6e;
    --color-success: #50fa7b;
    --color-success-hover: #6dfb92;
    --color-warning: #f1fa8c;
    --color-info: #8be9fd;
    --color-code-bg: #343746;
    --color-blockquote-border: #bd93f9;
    --color-selection-bg: #44475a;
    --color-selection-text: #f8f8f2;
    --color-focus-ring: #bd93f9;
    --color-shadow: rgba(0, 0, 0, 0.3);
    --color-overlay: rgba(40, 42, 54, 0.8);
    color-scheme: dark;
}

/* =============================================================================
   Common Variables (shared across all themes)
   ============================================================================= */
:root {
    --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    --font-mono: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --max-width: 1200px;
    --spacing: 1rem;
    --radius: 0.375rem;
    --radius-lg: 0.5rem;
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
}

/* =============================================================================
   Base Styles
   ============================================================================= */
*, *::before, *::after {
    box-sizing: border-box;
}

html {
    font-size: 16px;
    line-height: 1.5;
    scroll-behavior: smooth;
}

body {
    margin: 0;
    font-family: var(--font-sans);
    color: var(--color-text);
    background-color: var(--color-bg);
    transition: background-color var(--transition-normal), color var(--transition-normal);
}

/* Selection styling */
::selection {
    background-color: var(--color-selection-bg);
    color: var(--color-selection-text);
}

/* Focus visible for accessibility */
:focus-visible {
    outline: 2px solid var(--color-focus-ring);
    outline-offset: 2px;
}

:focus:not(:focus-visible) {
    outline: none;
}

/* =============================================================================
   Typography
   ============================================================================= */
h1, h2, h3, h4, h5, h6 {
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 600;
    line-height: 1.2;
    color: var(--color-text);
}

h1 { font-size: 2.5rem; }
h2 { font-size: 2rem; }
h3 { font-size: 1.5rem; }
h4 { font-size: 1.25rem; }
h5 { font-size: 1.125rem; }
h6 { font-size: 1rem; }

p {
    margin-top: 0;
    margin-bottom: 1rem;
}

a {
    color: var(--color-primary);
    text-decoration: none;
    transition: color var(--transition-fast);
}

a:hover {
    color: var(--color-primary-hover);
    text-decoration: underline;
}

/* =============================================================================
   Layout
   ============================================================================= */
.container {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--spacing);
}

.layout {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* =============================================================================
   Header & Navigation
   ============================================================================= */
.header {
    background-color: var(--color-bg-alt);
    border-bottom: 1px solid var(--color-border);
    padding: var(--spacing) 0;
    transition: background-color var(--transition-normal), border-color var(--transition-normal);
}

.header .container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--spacing);
}

.logo {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
    transition: color var(--transition-fast);
}

.logo:hover {
    color: var(--color-primary);
    text-decoration: none;
}

.nav {
    display: flex;
    gap: var(--spacing);
    align-items: center;
}

.nav a {
    color: var(--color-text);
    font-weight: 500;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius);
    transition: color var(--transition-fast), background-color var(--transition-fast);
}

.nav a:hover {
    color: var(--color-primary);
    text-decoration: none;
}

.logout-form {
    display: inline;
}

.logout-form button {
    background: none;
    border: none;
    color: var(--color-primary);
    cursor: pointer;
    font: inherit;
    padding: 0;
    transition: color var(--transition-fast);
}

.logout-form button:hover {
    color: var(--color-primary-hover);
    text-decoration: underline;
}

/* =============================================================================
   Main Content
   ============================================================================= */
.main {
    flex: 1;
    padding: calc(var(--spacing) * 2) 0;
}

/* =============================================================================
   Buttons
   ============================================================================= */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background-color: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    color: var(--color-text);
    cursor: pointer;
    font: inherit;
    font-weight: 500;
    text-decoration: none;
    transition: all var(--transition-fast);
}

.btn:hover {
    background-color: var(--color-bg-elevated);
    border-color: var(--color-border-light);
    text-decoration: none;
}

.btn:active {
    transform: translateY(1px);
}

.btn-primary {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
}

.btn-primary:hover {
    background-color: var(--color-primary-hover);
    border-color: var(--color-primary-hover);
    color: white;
}

.btn-danger {
    background-color: var(--color-danger);
    border-color: var(--color-danger);
    color: white;
}

.btn-danger:hover {
    background-color: var(--color-danger-hover);
    border-color: var(--color-danger-hover);
    color: white;
}

.btn-success {
    background-color: var(--color-success);
    border-color: var(--color-success);
    color: white;
}

.btn-success:hover {
    background-color: var(--color-success-hover);
    border-color: var(--color-success-hover);
    color: white;
}

.btn-link {
    background: none;
    border: none;
    color: var(--color-primary);
    cursor: pointer;
    padding: 0;
    font: inherit;
}

.btn-link:hover {
    color: var(--color-primary-hover);
    text-decoration: underline;
}

.btn-link.danger {
    color: var(--color-danger);
}

.btn-link.danger:hover {
    color: var(--color-danger-hover);
}

/* Small button variant */
.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* Icon button (for theme switcher, etc.) */
.btn-icon {
    padding: 0.5rem;
    border-radius: 50%;
    line-height: 1;
}

/* =============================================================================
   Forms
   ============================================================================= */
.form-group {
    margin-bottom: var(--spacing);
}

.form-group label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 500;
    color: var(--color-text);
}

.form-group input[type="text"],
.form-group input[type="password"],
.form-group input[type="email"],
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    font: inherit;
    color: var(--color-text);
    background-color: var(--color-bg);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-selection-bg);
    outline: none;
}

.form-group textarea {
    resize: vertical;
    min-height: 120px;
}

.form-group.checkbox label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.form-group.checkbox input {
    width: auto;
    accent-color: var(--color-primary);
}

.form-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: var(--spacing);
}

/* =============================================================================
   Messages (Error, Success)
   ============================================================================= */
.error-message {
    background-color: color-mix(in srgb, var(--color-danger) 15%, transparent);
    border: 1px solid var(--color-danger);
    color: var(--color-danger);
    padding: var(--spacing);
    border-radius: var(--radius);
    margin-bottom: var(--spacing);
}

.success-message {
    background-color: color-mix(in srgb, var(--color-success) 15%, transparent);
    border: 1px solid var(--color-success);
    color: var(--color-success);
    padding: var(--spacing);
    border-radius: var(--radius);
    margin-bottom: var(--spacing);
}

/* =============================================================================
   Post Cards
   ============================================================================= */
.post-list {
    display: flex;
    flex-direction: column;
    gap: calc(var(--spacing) * 2);
}

.post-card {
    padding: calc(var(--spacing) * 1.5);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    background-color: var(--color-bg);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.post-card:hover {
    border-color: var(--color-primary-muted);
    box-shadow: 0 4px 12px var(--color-shadow);
}

.post-card-title {
    margin-bottom: 0.5rem;
}

.post-card-title a {
    color: var(--color-text);
    font-weight: 600;
}

.post-card-title a:hover {
    color: var(--color-primary);
}

.post-card-meta {
    color: var(--color-text-muted);
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.draft-badge {
    background-color: var(--color-warning);
    color: #1a1a2e;
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius);
    font-size: 0.75rem;
    font-weight: 600;
}

.read-more {
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.read-more::after {
    content: "→";
    transition: transform var(--transition-fast);
}

.read-more:hover::after {
    transform: translateX(4px);
}

/* =============================================================================
   Pagination
   ============================================================================= */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing);
    margin-top: calc(var(--spacing) * 2);
}

.page-info {
    color: var(--color-text-muted);
    font-weight: 500;
}

/* =============================================================================
   Post Detail
   ============================================================================= */
.post-detail {
    max-width: 800px;
}

.post-header {
    margin-bottom: calc(var(--spacing) * 2);
    padding-bottom: var(--spacing);
    border-bottom: 1px solid var(--color-border);
}

.post-meta {
    color: var(--color-text-muted);
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.9rem;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: calc(var(--spacing) * 2);
    font-weight: 500;
}

.back-link::before {
    content: "←";
    transition: transform var(--transition-fast);
}

.back-link:hover::before {
    transform: translateX(-4px);
}

/* =============================================================================
   Markdown Content
   ============================================================================= */
.markdown-content {
    line-height: 1.7;
}

.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4,
.markdown-content h5,
.markdown-content h6 {
    margin-top: 1.5em;
}

.markdown-content pre {
    background-color: var(--color-code-bg);
    padding: var(--spacing);
    border-radius: var(--radius);
    overflow-x: auto;
    border: 1px solid var(--color-border);
}

.markdown-content code {
    font-family: var(--font-mono);
    font-size: 0.875em;
}

.markdown-content :not(pre) > code {
    background-color: var(--color-code-bg);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    color: var(--color-text);
}

.markdown-content blockquote {
    border-left: 4px solid var(--color-blockquote-border);
    margin: var(--spacing) 0;
    padding: 0.5rem 0 0.5rem var(--spacing);
    color: var(--color-text-muted);
    background-color: var(--color-bg-alt);
    border-radius: 0 var(--radius) var(--radius) 0;
}

.markdown-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius);
}

.markdown-content hr {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: calc(var(--spacing) * 2) 0;
}

.markdown-content ul,
.markdown-content ol {
    padding-left: 1.5rem;
}

.markdown-content li {
    margin-bottom: 0.5rem;
}

.markdown-content a {
    text-decoration: underline;
    text-underline-offset: 2px;
}

/* =============================================================================
   Admin Styles - Shared
   ============================================================================= */
.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table th,
.admin-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
}

.admin-table th {
    background-color: var(--color-bg-alt);
    font-weight: 600;
    color: var(--color-text);
}

.admin-table tr:hover td {
    background-color: var(--color-bg-alt);
}

/* =============================================================================
   Utility Classes
   ============================================================================= */
.success { color: var(--color-success); }
.error { color: var(--color-danger); }
.warning { color: var(--color-warning); }
.info { color: var(--color-info); }
.muted { color: var(--color-text-muted); }

.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* =============================================================================
   Skip Link for Accessibility
   ============================================================================= */
.skip-link {
    position: absolute;
    top: -100%;
    left: 0;
    background-color: var(--color-primary);
    color: white;
    padding: 0.5rem 1rem;
    z-index: 9999;
    transition: top var(--transition-fast);
}

.skip-link:focus {
    top: 0;
}

/* =============================================================================
   Reduced Motion
   ============================================================================= */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

/* =============================================================================
   Responsive Styles
   ============================================================================= */
@media (max-width: 768px) {
    html { font-size: 15px; }
    h1 { font-size: 2rem; }
    h2 { font-size: 1.5rem; }

    .header .container {
        flex-direction: column;
        text-align: center;
    }

    .nav {
        flex-wrap: wrap;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .pagination {
        flex-direction: column;
        gap: 0.5rem;
    }
}


================================================================================
FILE: src/MyBlog.Web/wwwroot/js/site.js
SIZE: 5.84 KB
MODIFIED: 2026-01-26 05:45:48
================================================================================

/**
 * MyBlog Theme Manager
 * Handles theme switching, persistence, and system preference detection
 */
window.themeManager = {
    storageKey: 'myblog-theme',
    defaultTheme: 'light',
    dotNetRef: null,

    /**
     * Available themes with their dark/light classification
     */
    themes: {
        'light': { isDark: false },
        'dark': { isDark: true },
        'sepia': { isDark: false },
        'nord': { isDark: true },
        'solarized-light': { isDark: false },
        'dracula': { isDark: true }
    },

    /**
     * Initialize the theme system
     * @param {object} dotNetRef - Reference to the Blazor component
     * @returns {string} The current theme ID
     */
    init: function(dotNetRef) {
        this.dotNetRef = dotNetRef;

        // Check for saved preference
        var savedTheme = localStorage.getItem(this.storageKey);

        // If no saved preference, check system preference
        if (!savedTheme) {
            var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            savedTheme = prefersDark ? 'dark' : 'light';
        }

        // Validate theme exists
        if (!this.themes[savedTheme]) {
            savedTheme = this.defaultTheme;
        }

        // Apply theme
        this.applyTheme(savedTheme);

        // Listen for system preference changes
        var self = this;
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            // Only auto-switch if user hasn't explicitly chosen a theme
            if (!localStorage.getItem(self.storageKey)) {
                var newTheme = e.matches ? 'dark' : 'light';
                self.setTheme(newTheme);
            }
        });

        return savedTheme;
    },

    /**
     * Apply a theme to the document
     * @param {string} themeId - The theme identifier
     */
    applyTheme: function(themeId) {
        document.documentElement.setAttribute('data-theme', themeId);

        // Update meta theme-color for mobile browsers
        var isDark = this.themes[themeId] ? this.themes[themeId].isDark : false;
        this.updateMetaThemeColor(isDark);
    },

    /**
     * Set and persist a theme
     * @param {string} themeId - The theme identifier
     */
    setTheme: function(themeId) {
        if (!this.themes[themeId]) {
            console.warn('Theme "' + themeId + '" not found, using default');
            themeId = this.defaultTheme;
        }

        // Apply immediately
        this.applyTheme(themeId);

        // Persist to localStorage
        localStorage.setItem(this.storageKey, themeId);

        // Announce change to screen readers
        this.announceThemeChange(themeId);
    },

    /**
     * Update the meta theme-color for mobile browser UI
     * @param {boolean} isDark - Whether the theme is dark
     */
    updateMetaThemeColor: function(isDark) {
        var metaThemeColor = document.querySelector('meta[name="theme-color"]');

        if (!metaThemeColor) {
            metaThemeColor = document.createElement('meta');
            metaThemeColor.name = 'theme-color';
            document.head.appendChild(metaThemeColor);
        }

        // Set color based on theme type
        metaThemeColor.content = isDark ? '#0f172a' : '#f8f9fa';
    },

    /**
     * Announce theme change to screen readers
     * @param {string} themeId - The theme identifier
     */
    announceThemeChange: function(themeId) {
        var themeName = themeId.split('-').map(function(w) {
            return w.charAt(0).toUpperCase() + w.slice(1);
        }).join(' ');

        // Create or reuse announcement element
        var announcer = document.getElementById('theme-announcer');
        if (!announcer) {
            announcer = document.createElement('div');
            announcer.id = 'theme-announcer';
            announcer.setAttribute('role', 'status');
            announcer.setAttribute('aria-live', 'polite');
            announcer.setAttribute('aria-atomic', 'true');
            announcer.className = 'visually-hidden';
            document.body.appendChild(announcer);
        }

        // Announce the change
        announcer.textContent = 'Theme changed to ' + themeName;
    },

    /**
     * Register click outside handler to close menu
     * @param {object} dotNetRef - Reference to the Blazor component
     */
    registerClickOutside: function(dotNetRef) {
        this.dotNetRef = dotNetRef;
        var self = this;

        document.addEventListener('click', function(e) {
            var themeSwitcher = e.target.closest('.theme-switcher');
            if (!themeSwitcher && self.dotNetRef) {
                self.dotNetRef.invokeMethodAsync('CloseMenu');
            }
        });

        // Also close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && self.dotNetRef) {
                self.dotNetRef.invokeMethodAsync('CloseMenu');
            }
        });
    },

    /**
     * Get current theme
     * @returns {string} Current theme ID
     */
    getCurrentTheme: function() {
        return document.documentElement.getAttribute('data-theme') || this.defaultTheme;
    },

    /**
     * Check if current theme is dark
     * @returns {boolean}
     */
    isDarkMode: function() {
        var current = this.getCurrentTheme();
        return this.themes[current] ? this.themes[current].isDark : false;
    }
};

/**
 * Initialize theme immediately to prevent flash of wrong theme
 * This runs before Blazor initializes
 */
(function() {
    var storageKey = 'myblog-theme';
    var defaultTheme = 'light';

    var theme = localStorage.getItem(storageKey);

    if (!theme) {
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        theme = prefersDark ? 'dark' : 'light';
    }

    // Apply theme immediately (before page renders)
    document.documentElement.setAttribute('data-theme', theme);
})();


===============================================================================
EXPORT COMPLETED: Tue Jan 27 08:46:21 AM EST 2026
Total Files Found: 115
Files Exported: 115
Files Skipped: 0 (binary or large files)
Output File: /home/kushal/src/dotnet/MyBlog/docs/llm/dump.txt
===============================================================================
