@page "/admin/posts/new"
@page "/admin/posts/edit/{Id:guid}"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IPostRepository PostRepository
@inject ISlugService SlugService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ILogger<PostEditor> Logger
@using System.Security.Claims

<PageTitle>@(IsEdit ? "Edit Post" : "New Post")</PageTitle>

<h1>@(IsEdit ? "Edit Post" : "New Post")</h1>

@if (_loading)
{
    <p>Loading...</p>
}
else if (IsEdit && _existingPost is null)
{
    <p>Post not found.</p>
    <a href="/admin/posts">Back to Posts</a>
}
else
{
    <div class="post-editor">
        <div class="editor-form">
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" @bind="_title" @bind:event="oninput" placeholder="Enter post title..." />
            </div>

            <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" @bind="_summary" rows="2" placeholder="Brief description for listings..."></textarea>
            </div>

            <div class="form-group">
                <label for="content">Content (Markdown)</label>
                <textarea id="content" @bind="_content" @bind:event="oninput" rows="15" placeholder="Write your post content in Markdown..."></textarea>
            </div>

            <div class="form-group checkbox">
                <label>
                    <input type="checkbox" @bind="_isPublished" />
                    Published
                </label>
            </div>

            @if (!string.IsNullOrEmpty(_error))
            {
                <div class="error-message">@_error</div>
            }

            <div class="form-actions">
                <button @onclick="Save" class="btn btn-primary" disabled="@_saving">
                    @(_saving ? "Saving..." : "Save")
                </button>
                <a href="/admin/posts" class="btn">Cancel</a>
            </div>
        </div>

        <div class="editor-preview">
            <h3>Preview</h3>
            <div class="preview-content">
                <MarkdownRenderer Content="@_content" />
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid? Id { get; set; }

    private bool IsEdit => Id.HasValue;
    private bool _loading = true;
    private bool _saving;
    private string _title = "";
    private string _summary = "";
    private string _content = "";
    private bool _isPublished = true; // Default to published for new posts
    private string? _error;
    private Post? _existingPost;

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            _existingPost = await PostRepository.GetByIdAsync(Id!.Value);
            if (_existingPost is not null)
            {
                _title = _existingPost.Title;
                _summary = _existingPost.Summary;
                _content = _existingPost.Content;
                _isPublished = _existingPost.IsPublished;
            }
        }
        // For new posts, _isPublished stays true (the default)
        _loading = false;
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(_title))
        {
            _error = "Title is required.";
            return;
        }

        _saving = true;
        _error = null;

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                _error = "User not authenticated. Please log in again.";
                return;
            }

            if (!Guid.TryParse(userId, out var authorId))
            {
                _error = "Invalid user ID. Please log in again.";
                Logger.LogError("Failed to parse user ID from claims: {UserId}", userId);
                return;
            }

            if (IsEdit && _existingPost is not null)
            {
                _existingPost.Title = _title;
                _existingPost.Slug = SlugService.GenerateSlugOrUuid(_title);
                _existingPost.Summary = _summary;
                _existingPost.Content = _content;
                _existingPost.IsPublished = _isPublished;
                _existingPost.UpdatedAtUtc = DateTime.UtcNow;

                if (_isPublished && !_existingPost.PublishedAtUtc.HasValue)
                {
                    _existingPost.PublishedAtUtc = DateTime.UtcNow;
                }
                else if (!_isPublished)
                {
                    _existingPost.PublishedAtUtc = null;
                }

                await PostRepository.UpdateAsync(_existingPost);
                Logger.LogInformation("Post updated: {PostId} by user {UserId}", _existingPost.Id, authorId);
            }
            else
            {
                var post = new Post
                {
                    Id = Guid.NewGuid(),
                    Title = _title,
                    Slug = SlugService.GenerateSlugOrUuid(_title),
                    Summary = _summary,
                    Content = _content,
                    IsPublished = _isPublished,
                    AuthorId = authorId,
                    CreatedAtUtc = DateTime.UtcNow,
                    UpdatedAtUtc = DateTime.UtcNow,
                    PublishedAtUtc = _isPublished ? DateTime.UtcNow : null
                };
                await PostRepository.CreateAsync(post);
                Logger.LogInformation("Post created: {PostId} by user {UserId}", post.Id, authorId);
            }

            Navigation.NavigateTo("/admin/posts");
        }
        catch (Exception ex)
        {
            // Log the full exception including inner exception
            Logger.LogError(ex, "Failed to save post. Title: {Title}, IsEdit: {IsEdit}", _title, IsEdit);
            
            // Show a more detailed error message
            var innerMessage = ex.InnerException?.Message ?? ex.Message;
            _error = $"Failed to save: {innerMessage}";
        }
        finally
        {
            _saving = false;
        }
    }
}
