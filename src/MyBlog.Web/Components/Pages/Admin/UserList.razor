@page "/admin/users"
@attribute [Authorize(Roles = AppConstants.AdminRole)]
@rendermode InteractiveServer
@inject IUserRepository UserRepository
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JsRuntime
@using System.Security.Claims

<PageTitle>Manage Users</PageTitle>

<div class="admin-container">
    <div class="admin-header">
        <h1>Manage Users</h1>
        <a href="/admin/users/new" class="btn btn-primary">Create New User</a>
    </div>

    @if (_users is null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="responsive-user-list">
            @* Header - Hidden on mobile *@
            <div class="list-header d-none-mobile">
                <div class="col">Username</div>
                <div class="col">Display Name</div>
                <div class="col">Email</div>
                <div class="col actions">Actions</div>
            </div>

            @foreach (var user in _users)
            {
                <div class="list-row">
                    <div class="list-item">
                        <span class="mobile-label">Username:</span>
                        <a href="/admin/users/edit/@user.Id">@user.Username</a>
                    </div>
                    <div class="list-item">
                        <span class="mobile-label">Name:</span>
                        @user.DisplayName
                    </div>
                    <div class="list-item email-cell">
                        <span class="mobile-label">Email:</span>
                        @user.Email
                    </div>
                    <div class="list-item actions">
                        <a href="/admin/users/edit/@user.Id" class="btn btn-sm">Edit</a>
                        @if (user.Id != _currentUserId)
                        {
                            <button @onclick="() => DeleteUser(user.Id)" class="btn btn-sm btn-danger">Delete</button>
                        }
                        else
                        {
                            <span class="current-user-badge">(Current)</span>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private IReadOnlyList<User>? _users;
    private Guid _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var idClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
        if (idClaim != null && Guid.TryParse(idClaim.Value, out var id))
        {
            _currentUserId = id;
        }

        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        _users = await UserRepository.GetAllAsync();
    }

    private async Task DeleteUser(Guid id)
    {
        if (id == _currentUserId) return;

        var confirm = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this user?");
        
        if (confirm)
        {
            await UserRepository.DeleteAsync(id);
            await LoadUsers();
        }
    }
}
