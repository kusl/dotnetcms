@page "/post/{Slug}"
@using System.Text.RegularExpressions
@inject IPostRepository PostRepository
@inject NavigationManager Navigation
@inject IConfiguration Configuration

@if (_post is null)
{
    @if (_notFound)
    {
        <PageTitle>Not Found</PageTitle>
        <h1>Post Not Found</h1>
        <p>The post you're looking for doesn't exist.</p>
        <a href="/">← Back to Home</a>
    }
    else
    {
        <p>Loading...</p>
    }
}
else
{
    @* --- 1. Browser Tab Title --- *@
    <PageTitle>@_post.Title</PageTitle>

    @* --- 2. SEO & Social Metadata (Injected into <head>) --- *@
    <HeadContent>
        @* Standard SEO *@
        <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
        <meta name="description" content="@_post.Summary" />
        <meta name="author" content="@_post.AuthorDisplayName" />
        <link rel="canonical" href="@_currentUrl" />

        @* Open Graph / Facebook / LinkedIn *@
        <meta property="og:type" content="article" />
        <meta property="og:site_name" content="@(Configuration["Application:Title"] ?? "MyBlog")" />
        <meta property="og:title" content="@_post.Title" />
        <meta property="og:description" content="@_post.Summary" />
        <meta property="og:url" content="@_currentUrl" />
        @if (_post.PublishedAtUtc.HasValue)
        {
            <meta property="article:published_time" content="@_post.PublishedAtUtc.Value.ToString("O")" />
        }
        <meta property="article:modified_time" content="@_post.UpdatedAtUtc.ToString("O")" />

        @if (!string.IsNullOrEmpty(_previewImage))
        {
            <meta property="og:image" content="@_previewImage" />
            <meta property="og:image:alt" content="@_post.Title" />
        }

        @* Twitter Cards *@
        <meta name="twitter:card" content="@(string.IsNullOrEmpty(_previewImage) ? "summary" : "summary_large_image")" />
        <meta name="twitter:title" content="@_post.Title" />
        <meta name="twitter:description" content="@_post.Summary" />
        @if (!string.IsNullOrEmpty(_previewImage))
        {
            <meta name="twitter:image" content="@_previewImage" />
        }

        @* JSON-LD Structured Data *@
        <script type="application/ld+json">
            @((MarkupString)GetJsonLd())
        </script>
    </HeadContent>

    @* --- 3. Visible Page Content --- *@
    <article class="post-detail">
        <header class="post-header">
            <h1>@_post.Title</h1>
            <div class="post-meta">
                <span class="author">By @_post.AuthorDisplayName</span>
                @if (_post.PublishedAtUtc.HasValue)
                {
                    <span class="date">Published @_post.PublishedAtUtc.Value.ToString("MMMM d, yyyy")</span>
                }

                @* Real-time Reader Badge *@
                <ReaderBadge Slug="@Slug" />

                @* Social Share Button (Visible UI) *@
                <button type="button" class="btn-link share-btn" data-title="@_post.Title" onclick="sharePost(this.dataset.title)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    Share
                </button>
            </div>
        </header>

        <div class="post-content">
            <MarkdownRenderer Content="@_post.Content" />
        </div>
    </article>

    <a href="/" class="back-link">← Back to Home</a>
}

@code {
    [Parameter]
    public string Slug { get; set; } = "";

    private PostDetailDto? _post;
    private bool _notFound;
    private string _currentUrl = "";
    private string? _previewImage;

    private string GetJsonLd()
    {
        if (_post is null) return "";

        var schema = new Dictionary<string, object?>
        {
            { "@context", "https://schema.org" },
            { "@type", "BlogPosting" },
            { "headline", _post.Title },
            { "description", _post.Summary },
            { "author", new Dictionary<string, object?> {
                { "@type", "Person" },
                { "name", _post.AuthorDisplayName }
            }},
            { "publisher", new Dictionary<string, object?> {
                { "@type", "Organization" },
                { "name", Configuration["Application:Title"] ?? "MyBlog" }
            }},
            { "datePublished", _post.PublishedAtUtc?.ToString("O") },
            { "dateModified", _post.UpdatedAtUtc.ToString("O") },
            { "mainEntityOfPage", new Dictionary<string, object?> {
                { "@type", "WebPage" },
                { "@id", _currentUrl }
            }}
        };

        if (!string.IsNullOrEmpty(_previewImage))
        {
            schema["image"] = _previewImage;
        }

        return System.Text.Json.JsonSerializer.Serialize(schema);
    }

    protected override async Task OnParametersSetAsync()
    {
        // 1. Load Data
        _post = await PostRepository.GetBySlugAsync(Slug);
        _notFound = _post is null;

        // 2. Validate visibility
        if (_post is not null && !_post.IsPublished)
        {
            _post = null;
            _notFound = true;
        }

        // 3. Prepare Metadata
        if (_post is not null)
        {
            // Get Absolute URL for Canonical/OG tags
            _currentUrl = Navigation.Uri;

            // Extract the first image from Markdown to use as the preview image
            // Regex matches: ![alt](url)
            var imageMatch = Regex.Match(_post.Content, @"!\[.*?\]\((.*?)\)");
            if (imageMatch.Success)
            {
                var url = imageMatch.Groups[1].Value;
                // If it's a relative URL (like /api/images/...), make it absolute
                if (url.StartsWith("/"))
                {
                    _previewImage = Navigation.ToAbsoluteUri(url).ToString();
                }
                else
                {
                    _previewImage = url;
                }
            }
        }
    }
}
