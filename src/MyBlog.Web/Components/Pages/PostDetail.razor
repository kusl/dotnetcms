@page "/post/{Slug}"
@inject IPostRepository PostRepository
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@if (_post is null)
{
    @if (_notFound)
    {
        <PageTitle>Not Found</PageTitle>
        <h1>Post Not Found</h1>
        <p>The post you're looking for doesn't exist.</p>
        <a href="/">← Back to Home</a>
    }
    else
    {
        <p>Loading...</p>
    }
}
else
{
    <PageTitle>@_post.Title</PageTitle>

    <article class="post-detail">
        <header class="post-header">
            <h1>@_post.Title</h1>
            <div class="post-meta">
                <span class="author">By @_post.AuthorDisplayName</span>
                @if (_post.PublishedAtUtc.HasValue)
                {
                    <span class="date">Published @_post.PublishedAtUtc.Value.ToString("MMMM d, yyyy")</span>
                }

                <button class="btn-link share-btn" @onclick="HandleShare">
                    Share
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                </button>
            </div>
        </header>

        <div class="post-content">
            <MarkdownRenderer Content="@_post.Content" />
        </div>
    </article>

    <a href="/" class="back-link">← Back to Home</a>
}

@code {
    [Parameter]
    public string Slug { get; set; } = "";

    private PostDetailDto? _post;
    private bool _notFound;

    protected override async Task OnParametersSetAsync()
    {
        _post = await PostRepository.GetBySlugAsync(Slug);
        _notFound = _post is null;

        // Don't show unpublished posts to public
        if (_post is not null && !_post.IsPublished)
        {
            _post = null;
            _notFound = true;
        }
    }

    private async Task HandleShare()
    {
        if (_post is not null)
        {
            // Call the JS function we created in site.js
            // Arguments: Title, Summary (text), URL
            await JSRuntime.InvokeVoidAsync("sharePost",
                _post.Title,
                _post.Summary,
                Navigation.Uri);
        }
    }
}
