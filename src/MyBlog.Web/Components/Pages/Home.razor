@page "/"
@inject IPostRepository PostRepository
@inject IConfiguration Configuration

<PageTitle>@(Configuration["Application:Title"] ?? "MyBlog")</PageTitle>

<h1>Welcome to @(Configuration["Application:Title"] ?? "MyBlog")</h1>

@if (_posts is null)
{
    <p>Loading...</p>
}
else if (_posts.Count == 0)
{
    <p>No posts yet. Check back soon!</p>
}
else
{
    <div class="post-list">
        @foreach (var post in _posts)
        {
            <PostCard Post="post" />
        }
    </div>

    <Pagination CurrentPage="_currentPage" TotalPages="_totalPages" BaseUrl="/" />
}

@code {
    private IReadOnlyList<PostListItemDto>? _posts;
    private int _currentPage = 1;
    private int _totalPages = 1;

    [SupplyParameterFromQuery(Name = "page")]
    public int? Page { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        _currentPage = Page ?? 1;
        if (_currentPage < 1) _currentPage = 1;

        var pageSize = Configuration.GetValue("Application:PostsPerPage", 10);
        var (posts, totalCount) = await PostRepository.GetPublishedPostsAsync(_currentPage, pageSize);
        
        _posts = posts;
        _totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
    }
}
