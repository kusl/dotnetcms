@rendermode InteractiveServer
@implements IDisposable
@inject IReaderTrackingService ReaderTracking

@if (_count > 0)
{
    <div class="reader-count" style="display: inline-block; font-size: 0.9em; color: #666;">
        @( _count > 1 ? $"‚óè {_count} people reading this" : "You are the only one here" )
    </div>
}

@code {
    [Parameter] public string Slug { get; set; } = "";
    private int _count = 0;

    protected override void OnInitialized()
    {
        try
        {
            ReaderTracking.OnCountChanged += HandleCountChanged;
            ReaderTracking.JoinPost(Slug);
            _count = ReaderTracking.GetReaderCount(Slug);
        }
        catch {
            /* Fail silently: Reader just sees nothing or 'only one here' */
        }
    }

    private void HandleCountChanged(string slug, int newCount)
    {
        if (slug == Slug)
        {
            _count = newCount;
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        try
        {
            ReaderTracking.LeavePost(Slug);
            ReaderTracking.OnCountChanged -= HandleCountChanged;
        }
        catch { /* Fail silently */ }
    }
}
