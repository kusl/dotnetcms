@using MyBlog.Core.Interfaces
@inject IReaderTrackingService TrackingService
@implements IDisposable

@if (_count > 0)
{
    <span class="reader-badge" title="Live reader count">
        <span class="reader-dot">‚óè</span>
        @_count people reading
    </span>
}

@code {
    [Parameter]
    public string Slug { get; set; } = "";

    private int _count;

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(Slug)) return;

        // Get current count and increment for this user
        TrackingService.JoinPost(Slug);
        _count = TrackingService.GetReaderCount(Slug);

        // Listen for updates from other users
        TrackingService.OnCountChanged += HandleCountChanged;
    }

    private void HandleCountChanged(string slug, int count)
    {
        // Only update if the event is for this post
        if (slug == Slug)
        {
            _count = count;
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        if (!string.IsNullOrEmpty(Slug))
        {
            // Decrement count and unsubscribe
            TrackingService.LeavePost(Slug);
            TrackingService.OnCountChanged -= HandleCountChanged;
        }
    }
}
